{% extends 'base/base.html' %}

{% block title %}Oil Note - 쿠폰 관리{% endblock %}

{% block content %}
    <!-- 쿠폰 관리 메인 카드 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <!-- 탭 네비게이션 -->
                    <ul class="nav nav-tabs mb-3" id="couponTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="auto-coupon-tab" data-bs-toggle="tab" data-bs-target="#auto-coupon" type="button" role="tab" aria-controls="auto-coupon" aria-selected="true">
                                <i class="fas fa-magic me-2"></i>자동 쿠폰
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-coupon-tab" data-bs-toggle="tab" data-bs-target="#manual-coupon" type="button" role="tab" aria-controls="manual-coupon" aria-selected="false">
                                <i class="fas fa-hand-paper me-2"></i>수동 쿠폰
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="coupon-management-tab" data-bs-toggle="tab" data-bs-target="#coupon-management" type="button" role="tab" aria-controls="coupon-management" aria-selected="false">
                                <i class="fas fa-cog me-2"></i>쿠폰 관리
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button" role="tab" aria-controls="statistics" aria-selected="false">
                                <i class="fas fa-chart-bar me-2"></i>통계 현황
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="couponTabContent">
                        <!-- 자동 쿠폰 탭 -->
                        <div class="tab-pane fade show active" id="auto-coupon" role="tabpanel" aria-labelledby="auto-coupon-tab">
                            <!-- 자동 쿠폰 관리 서브 탭 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="nav nav-pills nav-fill rounded-3 p-1 bg-light shadow-sm" id="autoCouponSubTabs" role="tablist" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active rounded-3 fw-semibold transition-all" id="signup-tab" data-bs-toggle="pill" data-bs-target="#signup-templates" type="button" role="tab" aria-controls="signup-templates" aria-selected="true" style="transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0,123,255,0.3);">
                                                <i class="fas fa-user-plus me-2 text-primary"></i>회원가입 쿠폰
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link rounded-3 fw-semibold transition-all" id="cumulative-tab" data-bs-toggle="pill" data-bs-target="#cumulative-templates" type="button" role="tab" aria-controls="cumulative-templates" aria-selected="false" style="transition: all 0.3s ease;">
                                                <i class="fas fa-chart-line me-2 text-success"></i>누적매출 쿠폰
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link rounded-3 fw-semibold transition-all" id="monthly-tab" data-bs-toggle="pill" data-bs-target="#monthly-templates" type="button" role="tab" aria-controls="monthly-templates" aria-selected="false" style="transition: all 0.3s ease;">
                                                <i class="fas fa-calendar-alt me-2 text-warning"></i>전월매출 쿠폰
                                            </button>
                                        </li>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-content" id="autoCouponSubTabContent">
                                <!-- 회원가입 쿠폰 관리 -->
                                <div class="tab-pane fade show active" id="signup-templates" role="tabpanel" aria-labelledby="signup-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <div>
                                            <h5 class="mb-1 fw-bold" style="color: #2c3e50;">회원가입 쿠폰 템플릿</h5>
                                            <p class="text-muted mb-0 small">신규 회원에게 자동으로 발급되는 쿠폰을 관리합니다</p>
                                        </div>
                                        <button type="button" class="btn btn-primary rounded-3 shadow-sm px-4 py-2 fw-semibold" onclick="editTemplate(null, 'SIGNUP')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.2)'">
                                            <i class="fas fa-plus me-2"></i>새 템플릿 추가
                                        </button>
                                    </div>
                                    <div id="signup-template-list" class="template-list">
                                        <!-- 동적으로 로드될 템플릿 목록 -->
                                    </div>
                                    <div class="mt-4 p-4 rounded-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea;">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                <i class="fas fa-lightbulb text-white"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted fw-semibold">
                                                    회원가입 시 쿠폰명으로 구분하여 자동으로 발급됩니다. 최신 생성 순으로 처리됩니다.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 누적매출 쿠폰 관리 -->
                                <div class="tab-pane fade" id="cumulative-templates" role="tabpanel" aria-labelledby="cumulative-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <div>
                                            <h5 class="mb-1 fw-bold" style="color: #2c3e50;">누적매출 쿠폰 템플릿</h5>
                                            <p class="text-muted mb-0 small">고객의 누적 매출 달성 시 자동으로 발급되는 쿠폰을 관리합니다</p>
                                        </div>
                                        <button type="button" class="btn btn-success rounded-3 shadow-sm px-4 py-2 fw-semibold" onclick="editTemplate(null, 'CUMULATIVE')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.2)'">
                                            <i class="fas fa-plus me-2"></i>새 템플릿 추가
                                        </button>
                                    </div>
                                    <div id="cumulative-template-list" class="template-list">
                                        <!-- 동적으로 로드될 템플릿 목록 -->
                                    </div>
                                    <div class="mt-4 p-4 rounded-3" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%); border-left: 4px solid #28a745;">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                                <i class="fas fa-lightbulb text-white"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted fw-semibold">
                                                    고객의 누적 매출이 설정된 임계값에 도달할 때 자동으로 발급됩니다.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 전월매출 쿠폰 관리 -->
                                <div class="tab-pane fade" id="monthly-templates" role="tabpanel" aria-labelledby="monthly-tab">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <div>
                                            <h5 class="mb-1 fw-bold" style="color: #2c3e50;">전월매출 쿠폰 템플릿</h5>
                                            <p class="text-muted mb-0 small">전월 매출 기준으로 매월 자동으로 발급되는 쿠폰을 관리합니다</p>
                                        </div>
                                        <button type="button" class="btn btn-warning rounded-3 shadow-sm px-4 py-2 fw-semibold" onclick="editTemplate(null, 'MONTHLY')" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); border: none; color: white; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255, 193, 7, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 193, 7, 0.2)'">
                                            <i class="fas fa-plus me-2"></i>새 템플릿 추가
                                        </button>
                                    </div>
                                    <div id="monthly-template-list" class="template-list">
                                        <!-- 동적으로 로드될 템플릿 목록 -->
                                    </div>
                                    <div class="mt-4 p-4 rounded-3" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 140, 0, 0.1) 100%); border-left: 4px solid #ffc107;">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);">
                                                <i class="fas fa-lightbulb text-white"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted fw-semibold">
                                                    매월 지정된 날짜에 전월 매출 기준으로 자동으로 발급됩니다.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 전체 통계 요약 -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <div class="row text-center">
                                                <div class="col-md-3">
                                                    <div class="bg-primary bg-opacity-10 rounded p-3">
                                                        <i class="fas fa-layer-group text-primary mb-2" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">총 템플릿</h6>
                                                        <span class="text-primary fw-bold fs-4" id="totalTemplates">0</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="bg-success bg-opacity-10 rounded p-3">
                                                        <i class="fas fa-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">활성 템플릿</h6>
                                                        <span class="text-success fw-bold fs-4" id="activeTemplates">0</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="bg-info bg-opacity-10 rounded p-3">
                                                        <i class="fas fa-gift text-info mb-2" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">이번 달 발행</h6>
                                                        <span class="text-info fw-bold fs-4" id="monthlyIssued">0</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="bg-warning bg-opacity-10 rounded p-3">
                                                        <i class="fas fa-chart-line text-warning mb-2" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">사용률</h6>
                                                        <span class="text-warning fw-bold fs-4" id="usageRate">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 수동 쿠폰 탭 -->
                        <div class="tab-pane fade" id="manual-coupon" role="tabpanel" aria-labelledby="manual-coupon-tab">
                            <div class="row">
                                <!-- 쿠폰 생성 섹션 -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card border h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">
                                                <i class="fas fa-plus me-2"></i>쿠폰 생성
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="couponCreationForm">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="couponType" class="form-label">쿠폰 유형</label>
                                                    <select class="form-select" id="couponType" name="coupon_type_id" required>
                                                        <option value="">쿠폰 유형 선택...</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="couponName" class="form-label">쿠폰명</label>
                                                    <input type="text" class="form-control" id="couponName" name="coupon_name" placeholder="예: 세차 할인 쿠폰" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="benefitType" class="form-label">혜택 유형</label>
                                                    <select class="form-select" id="benefitType" name="benefit_type" required>
                                                        <option value="">혜택 유형 선택...</option>
                                                        <option value="DISCOUNT">할인</option>
                                                        <option value="PRODUCT">상품</option>
                                                        <option value="BOTH">할인+상품</option>
                                                    </select>
                                                </div>
                                                <div id="discountSection" class="mb-3" style="display: none;">
                                                    <label for="discountAmount" class="form-label">할인 금액 (원)</label>
                                                    <input type="number" class="form-control" id="discountAmount" name="discount_amount" placeholder="1000" min="0">
                                                </div>
                                                <div id="productSection" class="mb-3" style="display: none;">
                                                    <label for="productName" class="form-label">상품명</label>
                                                    <input type="text" class="form-control" id="productName" name="product_name" placeholder="예: 음료수">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="description" class="form-label">설명</label>
                                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="쿠폰에 대한 상세 설명"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">사용 기간</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="manualIsPermanent" name="is_permanent">
                                                        <label class="form-check-label" for="manualIsPermanent">
                                                            무기한 사용
                                                        </label>
                                                    </div>
                                                    <div id="manualValidityPeriod" class="mt-2">
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <label for="manualValidFrom" class="form-label small">시작일</label>
                                                                <input type="date" class="form-control" id="manualValidFrom" name="valid_from">
                                                            </div>
                                                            <div class="col-6">
                                                                <label for="manualValidUntil" class="form-label small">종료일</label>
                                                                <input type="date" class="form-control" id="manualValidUntil" name="valid_until">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100">
                                                    <i class="fas fa-plus me-1"></i>쿠폰 생성
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- 쿠폰 발행 섹션 -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card border h-100">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">
                                                <i class="fas fa-gift me-2"></i>쿠폰 발행
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="couponIssuanceForm">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="issueCouponTemplate" class="form-label">발행할 쿠폰</label>
                                                    <select class="form-select" id="issueCouponTemplate" name="coupon_template_id" required>
                                                        <option value="">쿠폰 선택...</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="targetType" class="form-label">발행 대상</label>
                                                    <select class="form-select" id="targetType" name="target_type" required>
                                                        <option value="">발행 대상 선택...</option>
                                                        <option value="all">모든 고객</option>
                                                        <option value="group">특정 그룹</option>
                                                        <option value="individual">개별 고객</option>
                                                    </select>
                                                </div>
                                                <div id="groupSection" class="mb-3" style="display: none;">
                                                    <label for="targetGroup" class="form-label">대상 그룹</label>
                                                    <select class="form-select" id="targetGroup" name="group_id">
                                                        <option value="">그룹 선택...</option>
                                                    </select>
                                                </div>
                                                <div id="individualSection" class="mb-3" style="display: none;">
                                                    <label for="targetCustomers" class="form-label">대상 고객</label>
                                                    <select class="form-select" id="targetCustomers" name="customer_ids" multiple>
                                                    </select>
                                                    <small class="form-text text-muted">Ctrl+클릭으로 여러 고객 선택 가능</small>
                                                </div>
                                                <button type="submit" class="btn btn-success w-100">
                                                    <i class="fas fa-gift me-1"></i>쿠폰 발행
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 쿠폰 수량 현황 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <div class="row text-center">
                                                <div class="col-md-3">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-ticket-alt text-primary"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">총 쿠폰 수량</h6>
                                                            <span class="text-primary fw-bold" id="totalQuota">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-minus-circle text-danger"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">사용된 수량</h6>
                                                            <span class="text-danger fw-bold" id="usedQuota">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="d-flex align-items-center justify-content-center">
                                                        <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                            <i class="fas fa-check-circle text-success"></i>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">잔여 수량</h6>
                                                            <span class="text-success fw-bold" id="remainingQuota">0</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <button class="btn btn-warning btn-sm" onclick="requestCouponPurchase()">
                                                        <i class="fas fa-shopping-cart me-1"></i>쿠폰 구매 요청
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 쿠폰 관리 탭 -->
                        <div class="tab-pane fade" id="coupon-management" role="tabpanel" aria-labelledby="coupon-management-tab">
                            <!-- 발행된 쿠폰 목록 -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card border">
                                        <div class="card-header bg-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-list me-2"></i>발행된 쿠폰 목록
                                                </h5>
                                                <button class="btn btn-outline-primary btn-sm" onclick="refreshCouponList()">
                                                    <i class="fas fa-sync-alt me-1"></i>새로고침
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover" id="couponListTable">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>고객명</th>
                                                            <th>쿠폰명</th>
                                                            <th>유형</th>
                                                            <th>상태</th>
                                                            <th>발행일</th>
                                                            <th>만료일</th>
                                                            <th>사용일</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if all_coupons %}
                                                            {% for coupon in all_coupons %}
                                                            <tr>
                                                                <td>
                                                                    {{ coupon.customer.username }}
                                                                    {% if coupon.customer.customer_profile.phone_number %}
                                                                        <br><small class="text-muted">{{ coupon.customer.customer_profile.phone_number }}</small>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if coupon.auto_coupon_template %}
                                                                        {{ coupon.auto_coupon_template.coupon_name }}
                                                                    {% elif coupon.coupon_template %}
                                                                        {{ coupon.coupon_template.coupon_name }}
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if coupon.auto_coupon_template %}
                                                                        {% if coupon.auto_coupon_template.coupon_type == 'SIGNUP' %}
                                                                            <span class="badge bg-primary">회원가입</span>
                                                                        {% elif coupon.auto_coupon_template.coupon_type == 'CUMULATIVE' %}
                                                                            <span class="badge bg-success">누적매출</span>
                                                                        {% elif coupon.auto_coupon_template.coupon_type == 'MONTHLY' %}
                                                                            <span class="badge bg-warning">전월매출</span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">{{ coupon.auto_coupon_template.coupon_type }}</span>
                                                                        {% endif %}
                                                                    {% elif coupon.coupon_template %}
                                                                        {% if coupon.coupon_template.coupon_type %}
                                                                            <span class="badge bg-info">{{ coupon.coupon_template.coupon_type.type_name }}</span>
                                                                        {% else %}
                                                                            <span class="badge bg-secondary">수동</span>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if coupon.status == 'AVAILABLE' %}
                                                                        <span class="badge bg-success">사용가능</span>
                                                                    {% elif coupon.status == 'USED' %}
                                                                        <span class="badge bg-secondary">사용완료</span>
                                                                    {% elif coupon.status == 'EXPIRED' %}
                                                                        <span class="badge bg-danger">만료</span>
                                                                    {% else %}
                                                                        <span class="badge bg-light text-dark">{{ coupon.status }}</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>{{ coupon.issued_date|date:"Y-m-d H:i" }}</td>
                                                                <td>
                                                                    {% if coupon.auto_coupon_template %}
                                                                        {% if coupon.auto_coupon_template.is_permanent %}
                                                                            <span class="text-success">무기한</span>
                                                                        {% elif coupon.auto_coupon_template.valid_until %}
                                                                            {{ coupon.auto_coupon_template.valid_until|date:"Y-m-d" }}
                                                                        {% else %}
                                                                            -
                                                                        {% endif %}
                                                                    {% elif coupon.coupon_template %}
                                                                        {% if coupon.coupon_template.is_permanent %}
                                                                            <span class="text-success">무기한</span>
                                                                        {% elif coupon.coupon_template.valid_until %}
                                                                            {{ coupon.coupon_template.valid_until|date:"Y-m-d" }}
                                                                        {% else %}
                                                                            -
                                                                        {% endif %}
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if coupon.used_date %}
                                                                        {{ coupon.used_date|date:"Y-m-d H:i" }}
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="7" class="text-center text-muted">
                                                                    <i class="fas fa-ticket-alt me-2"></i>발행된 쿠폰이 없습니다.
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- 통계 현황 탭 -->
                        <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
                            <!-- 상단 요약 카드 -->
                            <div class="row mb-4">
                                <div class="col-xl-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-primary text-white h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-ticket-alt fa-2x me-3"></i>
                                                <div>
                                                    <div class="text-xs font-weight-bold text-uppercase mb-1">총 발행</div>
                                                    <div class="h5 mb-0" id="totalIssuedCount">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-success text-white h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-check-circle fa-2x me-3"></i>
                                                <div>
                                                    <div class="text-xs font-weight-bold text-uppercase mb-1">사용됨</div>
                                                    <div class="h5 mb-0" id="totalUsedCount">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-warning text-white h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-clock fa-2x me-3"></i>
                                                <div>
                                                    <div class="text-xs font-weight-bold text-uppercase mb-1">사용 가능</div>
                                                    <div class="h5 mb-0" id="totalAvailableCount">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-3 col-md-6 mb-3">
                                    <div class="card border-0 bg-info text-white h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-percentage fa-2x me-3"></i>
                                                <div>
                                                    <div class="text-xs font-weight-bold text-uppercase mb-1">사용률</div>
                                                    <div class="h5 mb-0" id="usageRate">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 차트 섹션 -->
                            <div class="row mb-4">
                                <div class="col-lg-8 mb-4">
                                    <div class="card border h-100">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-line me-2"></i>월별 쿠폰 발행/사용 추이
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="monthlyChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 mb-4">
                                    <div class="card border h-100">
                                        <div class="card-header bg-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-chart-pie me-2"></i>쿠폰 타입별 분포
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="typeChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 쿠폰 구매 요청 모달 -->
<div class="modal fade" id="purchaseRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>쿠폰 구매 요청
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="purchaseRequestForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="purchaseQuantity" class="form-label">구매 수량</label>
                        <input type="number" class="form-control" id="purchaseQuantity" min="1" max="1000" placeholder="1" required>
                        <small class="form-text text-muted">1~1000개 사이의 수량을 입력해주세요.</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        구매 요청 후 관리자 승인이 필요합니다.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-warning" onclick="submitPurchaseRequest()">
                    <i class="fas fa-paper-plane me-1"></i>요청 제출
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* 추가 스타일 */
.nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-bottom: 3px solid transparent;
    background: none;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #dee2e6;
}

.nav-tabs .nav-link.active {
    color: #495057;
    border-bottom-color: #007bff;
    background: none;
}

.card-header-tabs {
    margin-bottom: -1rem;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,.075);
}
</style>

<script>
// 새로운 자동 쿠폰 CRUD 시스템 JavaScript
let currentTemplateType = '';
let templates = {
    'SIGNUP': [],
    'CUMULATIVE': [],
    'MONTHLY': []
};

// 모든 템플릿 데이터 로드
function loadAllTemplates() {
    console.log('loadAllTemplates 함수 시작');
    fetch('/station/auto-coupons/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('서버 응답 데이터:', data);
        if (data.status === 'success') {
            // 타입별로 템플릿 분류
            templates = {
                'SIGNUP': [],
                'CUMULATIVE': [],
                'MONTHLY': []
            };
            
            data.data.forEach(template => {
                templates[template.coupon_type].push(template);
            });
            
            // 각 탭의 템플릿 목록 업데이트
            updateTemplateList('SIGNUP');
            updateTemplateList('CUMULATIVE');
            updateTemplateList('MONTHLY');
            
            // 통계 업데이트
            updateStatisticsSummary(data.data);
        }
    })
    .catch(error => {
        console.error('템플릿 로드 오류:', error);
    });
}

// 템플릿 목록 업데이트
function updateTemplateList(type) {
    console.log(`updateTemplateList 호출: type=${type}`);
    const container = document.getElementById(`${type.toLowerCase()}-template-list`);
    console.log(`컨테이너 요소:`, container);
    const typeTemplates = templates[type] || [];
    console.log(`템플릿 개수: ${typeTemplates.length}`);
    
    if (typeTemplates.length === 0) {
        container.innerHTML = `
            <div class="text-center p-4 text-muted">
                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                <p>등록된 템플릿이 없습니다.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row g-3">';
    
    typeTemplates.forEach((template, index) => {
        console.log(`템플릿 ${index} 데이터:`, template);
        console.log(`템플릿 ID: ${template.id}, 타입: ${typeof template.id}`);
        console.log(`템플릿 이름: ${template.coupon_name}`);
        
        const statusBadge = template.is_active ? 
            '<span class="badge rounded-pill px-3 py-1 ms-2 fw-semibold" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-size: 0.75rem;"><i class="fas fa-check-circle me-1"></i>활성</span>' : 
            '<span class="badge rounded-pill px-3 py-1 ms-2 fw-semibold" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; font-size: 0.75rem;"><i class="fas fa-pause-circle me-1"></i>비활성</span>';
            
                           
        const benefitText = template.benefit_type === 'DISCOUNT' ? `${template.discount_amount}원 할인` :
                          template.benefit_type === 'PRODUCT' ? template.product_name :
                          template.benefit_type === 'BOTH' ? `${template.discount_amount}원 할인 + ${template.product_name}` : '';
                          
        const conditionText = (type === 'CUMULATIVE' || type === 'MONTHLY') ? 
            `<small class="text-muted d-block">기준: ${template.condition_data?.threshold_amount || 0}원</small>` : '';
            
        html += `
            <div class="col-lg-6 col-xl-4 mb-3">
                <div class="card border-0 shadow-sm h-100 ${template.is_active ? 'bg-white' : 'bg-light'}" data-template-id="${template.id}" 
                     style="border-radius: 16px; transition: all 0.3s ease; ${template.is_active ? 'border-left: 4px solid #0d6efd !important;' : 'border-left: 4px solid #6c757d !important;'}" 
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <i class="fas fa-ticket-alt text-white"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fw-bold" style="color: #2c3e50; font-size: 1.1rem;">${template.coupon_name}</h6>
                                        ${statusBadge}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <span class="badge rounded-pill px-3 py-2 fw-semibold" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 0.85rem;">
                                        <i class="fas fa-gift me-1"></i>${benefitText}
                                    </span>
                                </div>
                                ${conditionText}
                                <div class="row text-center mt-3">
                                    <div class="col-6">
                                        <div class="p-2 rounded-3" style="background: rgba(13, 110, 253, 0.1);">
                                            <div class="fw-bold text-primary" style="font-size: 1.1rem;">${template.total_issued}</div>
                                            <small class="text-muted">발행</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 rounded-3" style="background: rgba(25, 135, 84, 0.1);">
                                            <div class="fw-bold text-success" style="font-size: 1.1rem;">${template.total_used}</div>
                                            <small class="text-muted">사용</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-column gap-2 ms-3">
                                <button type="button" class="btn btn-outline-primary btn-sm rounded-3 shadow-sm" onclick="console.log('수정 버튼 클릭됨, ID:', ${template.id}); editTemplate(${template.id})" title="수정" style="width: 40px; height: 40px; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-${template.is_active ? 'warning' : 'success'} btn-sm rounded-3 shadow-sm" 
                                        onclick="toggleTemplate(${template.id})" title="${template.is_active ? '비활성화' : '활성화'}" style="width: 40px; height: 40px; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-${template.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm rounded-3 shadow-sm" onclick="deleteTemplate(${template.id})" title="삭제" style="width: 40px; height: 40px; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    console.log(`생성된 HTML (처음 500자):`, html.substring(0, 500));
    console.log(`DOM에 삽입하기 전 컨테이너:`, container);
    container.innerHTML = html;
    console.log(`DOM 삽입 후 수정 버튼 개수:`, container.querySelectorAll('[onclick*="editTemplate"]').length);
    
    // 실제 생성된 버튼들의 onclick 속성 확인
    const editButtons = container.querySelectorAll('[onclick*="editTemplate"]');
    editButtons.forEach((btn, idx) => {
        console.log(`수정 버튼 ${idx} onclick:`, btn.getAttribute('onclick'));
    });
}

// 통계 요약 업데이트
function updateStatisticsSummary(allTemplates) {
    const totalTemplates = allTemplates.length;
    const activeTemplates = allTemplates.filter(t => t.is_active).length;
    const monthlyIssued = allTemplates.reduce((sum, t) => sum + (t.monthly_issued || 0), 0);
    const totalIssued = allTemplates.reduce((sum, t) => sum + t.total_issued, 0);
    const totalUsed = allTemplates.reduce((sum, t) => sum + t.total_used, 0);
    const usageRate = totalIssued > 0 ? Math.round((totalUsed / totalIssued) * 100) : 0;
    
    document.getElementById('totalTemplates').textContent = totalTemplates;
    document.getElementById('activeTemplates').textContent = activeTemplates;
    document.getElementById('monthlyIssued').textContent = monthlyIssued;
    document.getElementById('usageRate').textContent = usageRate + '%';
}

// Removed showAddTemplateOverlay and related functions - now using editTemplate for both add and edit modes
function showModalWithDOMManipulation(modalElement) {
    console.log('순수 DOM 조작으로 모달 표시');
    modalElement.style.display = 'block';
    modalElement.classList.add('show');
    modalElement.setAttribute('aria-modal', 'true');
    modalElement.setAttribute('role', 'dialog');
    modalElement.removeAttribute('aria-hidden');
    
    // 백드롭 추가
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    backdrop.id = 'custom-backdrop';
    document.body.appendChild(backdrop);
    
    // body에 modal-open 클래스 추가
    document.body.classList.add('modal-open');
    
    // ESC 키로 닫기
    document.addEventListener('keydown', handleModalEscape);
    
    // 백드롭 클릭으로 닫기
    backdrop.addEventListener('click', hideModalWithDOMManipulation);
}

// 순수 DOM 조작으로 모달 숨기기
function hideModalWithDOMManipulation() {
    console.log('순수 DOM 조작으로 모달 숨기기');
    const modalElement = document.getElementById('templateModal');
    const backdrop = document.getElementById('custom-backdrop');
    
    modalElement.style.display = 'none';
    modalElement.classList.remove('show');
    modalElement.setAttribute('aria-hidden', 'true');
    modalElement.removeAttribute('aria-modal');
    modalElement.removeAttribute('role');
    
    if (backdrop) {
        backdrop.remove();
    }
    
    document.body.classList.remove('modal-open');
    document.removeEventListener('keydown', handleModalEscape);
}

// ESC 키 핸들러
function handleModalEscape(event) {
    if (event.key === 'Escape') {
        hideModalWithDOMManipulation();
    }
}

// 데이터 로드 후 모달 표시
function loadTemplateDataAndShow(templateId, modalElement) {
    console.log('=== loadTemplateDataAndShow 함수 호출됨 ===');
    console.log('templateId:', templateId);
    
    fetch(`/station/auto-coupons/${templateId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => {
        console.log('서버 응답 받음:', response);
        return response.json();
    })
    .then(data => {
        console.log('서버 응답 데이터:', data);
        if (data.status === 'success') {
            console.log('성공 응답 처리 시작');
            const template = data.data;
            console.log('템플릿 데이터:', template);
            
            // 폼 필드 직접 설정
            document.getElementById('templateId').value = template.id;
            document.getElementById('couponName').value = template.coupon_name;
            document.getElementById('templateDescription').value = template.description || '';
            document.getElementById('modalBenefitType').value = template.benefit_type;
            document.getElementById('discountAmount').value = template.discount_amount || '';
            document.getElementById('productName').value = template.product_name || '';
            document.getElementById('isPermanent').checked = template.is_permanent;
            document.getElementById('validFrom').value = template.valid_from || '';
            document.getElementById('validUntil').value = template.valid_until || '';
            
            // 조건 데이터
            if (template.condition_data) {
                document.getElementById('thresholdAmount').value = template.condition_data.threshold_amount || '';
            }
            
            // 혜택 유형에 따른 필드 표시
            handleBenefitTypeChange();
            
            // 유효기간 설정에 따른 필드 표시
            handlePermanentChange();
            
            console.log('모든 필드 설정 완료, 모달 표시');
            
            // 데이터 설정 완료 후 모달 표시
            showModalWithDOMManipulation(modalElement);
            
        } else {
            console.error('템플릿 데이터 로드 실패:', data.message);
            showToast(data.message || '템플릿 데이터를 불러올 수 없습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('템플릿 데이터 로드 오류:', error);
        showToast('템플릿 데이터를 불러오는 중 오류가 발생했습니다.', 'error');
    });
}

// 템플릿 데이터 로드 (구버전 - 사용하지 않음)
function loadTemplateData_OLD(templateId) {
    console.log('=== loadTemplateData 함수 호출됨 ===');
    console.log('templateId:', templateId);
    
    fetch(`/station/auto-coupons/${templateId}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => {
        console.log('서버 응답 받음:', response);
        console.log('응답 상태:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('서버 응답 데이터:', data);
        if (data.status === 'success') {
            console.log('성공 응답 처리 시작');
            const template = data.data;
            console.log("수정 데이터 로드 완료:", template.coupon_name);
            
            
            // 모던 디자인 임시 다이얼로그 생성
            const tempDialog = document.createElement("div");
            tempDialog.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999999; backdrop-filter: blur(8px); animation: fadeIn 0.3s ease;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 0; border-radius: 20px; width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideIn 0.4s ease;">
                        <!-- 헤더 -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 20px 20px 0 0; position: relative;">
                            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; display: flex; align-items: center;">
                                <i class="fas fa-edit" style="margin-right: 12px; font-size: 1.3rem;"></i>
                                ${template.coupon_type_display} 쿠폰 템플릿 수정
                            </h2>
                            <button onclick="this.closest(\"div\").remove()" style="position: absolute; top: 20px; right: 25px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s ease;" onmouseover="this.style.background=\"rgba(255,255,255,0.3)\"" onmouseout="this.style.background=\"rgba(255,255,255,0.2)\"">
                                ×
                            </button>
                        </div>
                        
                        <!-- 내용 -->
                        <div style="padding: 30px;">
                            <!-- 기본 정보 -->
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #e9ecef;">
                                <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;">
                                    <i class="fas fa-info-circle" style="margin-right: 10px; color: #667eea;"></i>
                                    기본 정보
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #667eea;">
                                        <i class="fas fa-ticket-alt" style="color: #667eea; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">쿠폰 이름</div>
                                            <div style="font-weight: 600; color: #495057;">${template.coupon_name}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid ${template.is_active ? "#28a745" : "#6c757d"};">
                                        <i class="fas fa-${template.is_active ? "check-circle" : "pause-circle"}" style="color: ${template.is_active ? "#28a745" : "#6c757d"}; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">상태</div>
                                            <div style="font-weight: 600; color: ${template.is_active ? "#28a745" : "#6c757d"};">${template.is_active ? "활성" : "비활성"}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 혜택 정보 -->
                            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #ffeaa7;">
                                <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;">
                                    <i class="fas fa-gift" style="margin-right: 10px; color: #f39c12;"></i>
                                    혜택 정보
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #f39c12;">
                                        <i class="fas fa-${template.benefit_type === "DISCOUNT" ? "percentage" : template.benefit_type === "PRODUCT" ? "box" : "plus"}" style="color: #f39c12; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">혜택 유형</div>
                                            <div style="font-weight: 600; color: #495057;">${template.benefit_type === "DISCOUNT" ? "할인" : template.benefit_type === "PRODUCT" ? "상품" : "할인+상품"}</div>
                                        </div>
                                    </div>
                                    ${template.discount_amount ? `
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #e74c3c;">
                                        <i class="fas fa-won-sign" style="color: #e74c3c; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">할인 금액</div>
                                            <div style="font-weight: 600; color: #495057;">${template.discount_amount}원</div>
                                        </div>
                                    </div>` : ""}
                                    ${template.product_name ? `
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #17a2b8; ${template.discount_amount ? "grid-column: 1 / -1;" : ""}">
                                        <i class="fas fa-box-open" style="color: #17a2b8; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">상품명</div>
                                            <div style="font-weight: 600; color: #495057;">${template.product_name}</div>
                                        </div>
                                    </div>` : ""}
                                </div>
                            </div>
                            
                            <!-- 유효기간 및 발행 정보 -->
                            <div style="background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #bee5eb;">
                                <h3 style="margin: 0 0 20px 0; color: #495057; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;">
                                    <i class="fas fa-calendar-alt" style="margin-right: 10px; color: #17a2b8;"></i>
                                    유효기간 및 발행 정보
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #17a2b8;">
                                        <i class="fas fa-${template.is_permanent ? "infinity" : "calendar-check"}" style="color: #17a2b8; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">유효기간</div>
                                            <div style="font-weight: 600; color: #495057;">${template.is_permanent ? "무기한" : (template.valid_from || "없음") + " ~ " + (template.valid_until || "없음")}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #28a745;">
                                        <i class="fas fa-paper-plane" style="color: #28a745; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">발행된 수</div>
                                            <div style="font-weight: 600; color: #495057;">${template.total_issued}개</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 12px; border-left: 4px solid #fd7e14;">
                                        <i class="fas fa-check-double" style="color: #fd7e14; margin-right: 10px; width: 20px;"></i>
                                        <div>
                                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 2px;">사용된 수</div>
                                            <div style="font-weight: 600; color: #495057;">${template.total_used}개</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${template.description ? `
                            <!-- 설명 -->
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid #dee2e6;">
                                <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;">
                                    <i class="fas fa-comment-alt" style="margin-right: 10px; color: #6c757d;"></i>
                                    설명
                                </h3>
                                <div style="background: white; padding: 15px; border-radius: 12px; border-left: 4px solid #6c757d; color: #495057; line-height: 1.5;">
                                    ${template.description}
                                </div>
                            </div>` : ""}
                            
                            <!-- 액션 버튼 -->
                            <div style="display: flex; gap: 15px; justify-content: center; padding-top: 15px;">
                                <button onclick="this.closest(\"div\").remove()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);" onmouseover="this.style.transform=\"translateY(-2px)\"; this.style.boxShadow=\"0 6px 20px rgba(108, 117, 125, 0.4)\"" onmouseout="this.style.transform=\"translateY(0)\"; this.style.boxShadow=\"0 4px 15px rgba(108, 117, 125, 0.3)\"">
                                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                                    닫기
                                </button>
                                <button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform=\"translateY(-2px)\"; this.style.boxShadow=\"0 6px 20px rgba(102, 126, 234, 0.4)\"" onmouseout="this.style.transform=\"translateY(0)\"; this.style.boxShadow=\"0 4px 15px rgba(102, 126, 234, 0.3)\"">
                                    <i class="fas fa-edit" style="margin-right: 8px;"></i>
                                    실제 수정하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { 
                        opacity: 0;
                        transform: translate(-50%, -60%) scale(0.9);
                    }
                    to { 
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                }
                </style>
            `;
            document.body.appendChild(tempDialog);
            console.log("모던 디자인 다이얼로그 생성 완료");
            // 모달 강제 알림
            alert("모달이 열려있습니다! couponName: " + template.coupon_name);
            
            // 모든 필드 값 확인
            setTimeout(() => {
                const name = document.getElementById("couponName").value;
                const desc = document.getElementById("templateDescription").value;
                const benefit = document.getElementById("modalBenefitType").value;
                alert("필드 값 확인:\n이름: " + name + "\n설명: " + desc + "\n혜택: " + benefit);
            }, 1000);
            
            // 폼 필드 채우기
            document.getElementById('templateId').value = template.id;
            document.getElementById('couponName').value = template.coupon_name;
            document.getElementById('templateDescription').value = template.description || '';
            document.getElementById('modalBenefitType').value = template.benefit_type;
            document.getElementById('discountAmount').value = template.discount_amount || '';
            document.getElementById('productName').value = template.product_name || '';
            document.getElementById('isPermanent').checked = template.is_permanent;
            document.getElementById('validFrom').value = template.valid_from || '';
            document.getElementById('validUntil').value = template.valid_until || '';
            
            // 조건 데이터 (누적/전월매출)
            if (template.condition_data) {
                document.getElementById('thresholdAmount').value = template.condition_data.threshold_amount || '';
            }
            
            // 혜택 유형에 따른 필드 표시
            handleBenefitTypeChange();
            
            // 유효기간 설정에 따른 필드 표시
            handlePermanentChange();
        }
    })
    .catch(error => {
        console.error('=== 템플릿 데이터 로드 오류 ===');
        console.error('오류 내용:', error);
        console.error('오류 타입:', typeof error);
        console.error('오류 메시지:', error.message);
    });
}

// 템플릿 저장
function saveTemplate() {
    console.log('🔵 [FRONTEND-LOG] saveTemplate() 시작');
    const form = document.getElementById('templateForm');
    const formData = new FormData(form);
    const templateId = document.getElementById('templateId').value;
    
    console.log('🔵 [FRONTEND-LOG] 기본 폼 데이터:');
    for (let [key, value] of formData.entries()) {
        console.log(`🔵 [FRONTEND-LOG]   ${key}: "${value}" (타입: ${typeof value})`);
    }
    
    // 조건 데이터 구성
    const conditionData = {};
    if (currentTemplateType === 'CUMULATIVE' || currentTemplateType === 'MONTHLY') {
        const thresholdAmount = formData.get('threshold_amount');
        console.log(`🔵 [FRONTEND-LOG] threshold_amount 원본값: "${thresholdAmount}" (타입: ${typeof thresholdAmount})`);
        conditionData.threshold_amount = parseInt(thresholdAmount) || 0;
        console.log(`🔵 [FRONTEND-LOG] threshold_amount 변환값: ${conditionData.threshold_amount} (타입: ${typeof conditionData.threshold_amount})`);
    }
    console.log('🔵 [FRONTEND-LOG] conditionData 구성:', JSON.stringify(conditionData));
    formData.append('condition_data', JSON.stringify(conditionData));
    
    // 추가된 데이터 확인
    console.log('🔵 [FRONTEND-LOG] 최종 FormData (condition_data 포함):');
    for (let [key, value] of formData.entries()) {
        console.log(`🔵 [FRONTEND-LOG]   ${key}: "${value}" (타입: ${typeof value})`);
    }
    
    const url = templateId ? 
        `/station/auto-coupons/${templateId}/update/` : 
        '/station/auto-coupons/create/';
    
    console.log(`🔵 [FRONTEND-LOG] 요청 URL: ${url}`);
    console.log(`🔵 [FRONTEND-LOG] 템플릿 ID: ${templateId}`);
    console.log(`🔵 [FRONTEND-LOG] 현재 템플릿 타입: ${currentTemplateType}`);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => {
        console.log(`🔵 [FRONTEND-LOG] 서버 응답 상태: ${response.status} ${response.statusText}`);
        return response.json();
    })
    .then(data => {
        console.log('🔵 [FRONTEND-LOG] 서버 응답 데이터:', JSON.stringify(data, null, 2));
        if (data.status === 'success') {
            console.log('🔵 [FRONTEND-LOG] 성공 처리 시작');
            // 모달 닫기
            hideModalWithDOMManipulation();
            
            // 템플릿 목록 새로고침
            loadAllTemplates();
            
            showToast(data.message || (templateId ? '템플릿이 수정되었습니다.' : '새 템플릿이 생성되었습니다.'), 'success');
        } else {
            console.log('🔴 [FRONTEND-ERROR] 서버에서 오류 응답:', data);
            showToast(data.message || '오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('🔴 [FRONTEND-ERROR] 템플릿 저장 오류:', error);
        console.error('🔴 [FRONTEND-ERROR] 오류 상세:', error.message, error.stack);
        showToast((isAddMode ? '템플릿 생성' : '템플릿 저장') + ' 중 오류가 발생했습니다.', 'error');
    });
}

// 템플릿 수정
function editTemplate(templateId, couponType = null) {
    console.log('=== editTemplate 함수 호출됨 ===');
    console.log('전달받은 templateId:', templateId, '타입:', typeof templateId);
    console.log('전달받은 couponType:', couponType);
    
    // templateId가 null이면 새 템플릿 추가 모드, 아니면 수정 모드
    if (templateId === null) {
        // 새 템플릿 추가 모드
        showTemplateOverlay(null, couponType);
    } else {
        // 기존 템플릿 수정 모드
        showTemplateOverlay(templateId);
    }
}

// 편집 가능한 다이얼로그 표시 (기존 모달과 동일한 디자인)
function showTemplateOverlay(templateId, couponType = null) {
    console.log('=== showTemplateOverlay 함수 호출됨 ===');
    console.log('templateId:', templateId);
    console.log('couponType:', couponType);
    
    if (templateId === null) {
        // 새 템플릿 추가 모드 - 빈 데이터로 다이얼로그 생성
        createTemplateDialog(null, couponType);
    } else {
        // 기존 템플릿 수정 모드 - 데이터를 가져와서 다이얼로그 생성
        fetch(`/station/auto-coupons/${templateId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => {
            console.log('서버 응답 받음:', response);
            return response.json();
        })
        .then(data => {
            console.log('서버 응답 데이터:', data);
            if (data.status === 'success') {
                const template = data.data;
                console.log('템플릿 데이터:', template);
                
                // 기존 템플릿 데이터로 다이얼로그 생성
                createTemplateDialog(template);
            } else {
                console.error('템플릿 데이터 로드 실패:', data.message);
                alert('템플릿 데이터를 가져오는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('템플릿 데이터 로드 에러:', error);
            alert('템플릿 데이터를 가져오는데 실패했습니다.');
        });
    }
}

// 템플릿 다이얼로그 생성 (수정 모드와 새 추가 모드 공통 사용)
function createTemplateDialog(template, couponType = null) {
    console.log('=== createTemplateDialog 함수 호출됨 ===');
    console.log('template:', template);
    console.log('couponType:', couponType);
    
    // 새 추가 모드인지 수정 모드인지 판별
    const isAddMode = template === null;
    const actualType = isAddMode ? couponType : template?.coupon_type;
    
    // 기존 모달과 동일한 디자인의 편집 가능한 다이얼로그 생성
    const editDialog = document.createElement("div");
    editDialog.innerHTML = `
                <div class="modal-backdrop fade show" onclick="this.closest('.edit-modal-overlay').remove()"></div>
                <div class="modal fade show" tabindex="-1" style="display: block; z-index: 1055;">
                    <div class="modal-dialog modal-dialog-centered" style="max-height: 66vh;">
                        <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.1); height: 100%; display: flex; flex-direction: column;">
                            <div class="modal-header border-0 pb-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px 20px 0 0; padding: 0.75rem 1.5rem;">
                                <div class="w-100 text-center">
                                    <h5 class="modal-title text-white fw-bold mb-0">
                                        <i class="fas fa-${isAddMode ? 'plus' : 'edit'} me-2"></i>${isAddMode ? '새' : ''} ${getTypeDisplayName(actualType)} 템플릿 ${isAddMode ? '추가' : '수정'}
                                    </h5>
                                </div>
                                <button type="button" class="btn-close btn-close-white position-absolute" onclick="this.closest('.edit-modal-overlay').remove()" aria-label="Close" style="top: 1rem; right: 1rem; opacity: 0.8;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'"></button>
                            </div>
                            <div class="modal-body" style="padding: 1rem; flex: 1; overflow-y: auto; max-height: calc(66vh - 120px);">
                                <form id="editTemplateForm">
                                    <input type="hidden" id="editTemplateId" value="${isAddMode ? '' : template.id}">
                                    <input type="hidden" id="editModalCouponType" value="${actualType}">
                                    
                                    <!-- 기본 정보 -->
                                    <div class="mb-4">
                                        <h6 class="text-primary fw-semibold mb-3" style="font-size: 1.1rem;">
                                            <i class="fas fa-info-circle me-2"></i>기본 정보
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <label for="editCouponName" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                <i class="fas fa-ticket-alt me-2 text-primary"></i>쿠폰명
                                            </label>
                                            <input type="text" class="form-control rounded-3 shadow-sm" id="editCouponName" value="${isAddMode ? '' : template.coupon_name || ''}" 
                                                style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="editTemplateDescription" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                <i class="fas fa-file-alt me-2 text-success"></i>설명 (선택사항)
                                            </label>
                                            <textarea class="form-control rounded-3 shadow-sm" id="editTemplateDescription" rows="2" 
                                                style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">${isAddMode ? '' : template.description || ''}</textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="editModalBenefitType" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                <i class="fas fa-gift me-2 text-warning"></i>혜택 유형
                                            </label>
                                            <select class="form-select rounded-3 shadow-sm" id="editModalBenefitType" onchange="handleEditBenefitTypeChange()"
                                                style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                                <option value=""${isAddMode ? ' selected' : ''}>혜택 유형 선택</option>
                                                <option value="DISCOUNT" ${!isAddMode && template.benefit_type === 'DISCOUNT' ? 'selected' : ''}>할인</option>
                                                <option value="PRODUCT" ${!isAddMode && template.benefit_type === 'PRODUCT' ? 'selected' : ''}>상품 증정</option>
                                                <option value="BOTH" ${!isAddMode && template.benefit_type === 'BOTH' ? 'selected' : ''}>할인 + 상품 증정</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3" id="editDiscountAmountGroup" style="display: ${!isAddMode && (template.benefit_type === 'DISCOUNT' || template.benefit_type === 'BOTH') ? 'block' : 'none'};">
                                            <label for="editDiscountAmount" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                <i class="fas fa-percentage me-2 text-danger"></i>할인 금액 (원)
                                            </label>
                                            <input type="number" class="form-control rounded-3 shadow-sm" id="editDiscountAmount" value="${isAddMode ? '' : template.discount_amount || ''}" 
                                                style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                        </div>
                                        
                                        <div class="mb-3" id="editProductNameGroup" style="display: ${!isAddMode && (template.benefit_type === 'PRODUCT' || template.benefit_type === 'BOTH') ? 'block' : 'none'};">
                                            <label for="editProductName" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                <i class="fas fa-box me-2 text-info"></i>상품명
                                            </label>
                                            <input type="text" class="form-control rounded-3 shadow-sm" id="editProductName" value="${isAddMode ? '' : template.product_name || ''}" 
                                                style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                        </div>
                                    </div>
                                    
                                    <!-- 발행 조건 (누적매출, 전월매출 쿠폰에만 표시) -->
                                    <!-- 발행 조건 (누적매출, 전월매출 쿠폰에만 표시) -->
                                    <div class="mb-4" id="editConditionSection" style="display: ${actualType === 'CUMULATIVE' || actualType === 'MONTHLY' ? 'block' : 'none'};">
                                        <h6 class="text-info fw-semibold mb-3" style="font-size: 1.1rem;">
                                            <i class="fas fa-cogs me-2"></i>발행 조건
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <label for="editThresholdAmount" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                <i class="fas fa-won-sign me-2 text-primary"></i>기준 금액 (원)
                                            </label>
                                            <input type="number" class="form-control rounded-3 shadow-sm" id="editThresholdAmount" 
                                                value="${isAddMode ? '' : (template.condition_data ? template.condition_data.threshold_amount || '' : '')}" 
                                                style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                        </div>
                                        
                                        
                                    </div>
                                    
                                    <!-- 회원가입 쿠폰 특성 안내 -->
                                    <div class="mb-4" id="editSignupNotice" style="display: ${actualType === 'SIGNUP' ? 'block' : 'none'};">
                                        <div class="p-4 rounded-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #667eea;">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                    <i class="fas fa-lightbulb text-white"></i>
                                                </div>
                                                <div>
                                                    <small class="text-muted fw-semibold">💡 회원가입 쿠폰 특성</small>
                                                    <p class="mb-0 small text-muted mt-1">
                                                        • 무제한 발행: 회원가입 쿠폰은 항상 무제한으로 발행됩니다<br>
                                                        • 자동 발급: 신규 회원 가입 시 자동으로 발급됩니다
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 유효기간 설정 -->
                                    <div class="mb-4">
                                        <h6 class="text-warning fw-semibold mb-3" style="font-size: 1.1rem;">
                                            <i class="fas fa-calendar-alt me-2"></i>유효기간 설정
                                        </h6>
                                        
                                        <div class="form-check mb-3" style="padding-left: 2rem;">
                                            <input class="form-check-input" type="checkbox" id="editIsPermanent" onchange="handleEditPermanentChange()" 
                                                ${!isAddMode && template.is_permanent ? 'checked' : ''} style="margin-top: 0.4rem;">
                                            <label class="form-check-label fw-semibold" for="editIsPermanent" style="color: #495057; margin-left: 0.5rem;">
                                                <i class="fas fa-infinity me-2 text-primary"></i>무기한 사용
                                            </label>
                                        </div>
                                        
                                        <div id="editValidityPeriod" style="display: ${!isAddMode && template.is_permanent ? 'none' : 'block'};">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="editValidFrom" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                        <i class="fas fa-play me-2 text-success"></i>시작일
                                                    </label>
                                                    <input type="date" class="form-control rounded-3 shadow-sm" id="editValidFrom" value="${isAddMode ? '' : template.valid_from || ''}" 
                                                        style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                        onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="editValidUntil" class="form-label fw-semibold" style="color: #495057; font-size: 0.95rem;">
                                                        <i class="fas fa-stop me-2 text-danger"></i>종료일
                                                    </label>
                                                    <input type="date" class="form-control rounded-3 shadow-sm" id="editValidUntil" value="${isAddMode ? '' : template.valid_until || ''}" 
                                                        style="border: 2px solid #e9ecef; padding: 0.75rem 1rem; font-size: 0.95rem; transition: all 0.3s ease;" 
                                                        onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 0.2rem rgba(102, 126, 234, 0.25)'" 
                                                        onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    
                                    <!-- 회원가입 쿠폰 안내 메시지 -->
                                    <div class="mb-4" id="editSignupCouponNotice" style="display: ${actualType === 'SIGNUP' ? 'block' : 'none'};">
                                        <div class="alert alert-info border-0 rounded-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 4px solid #2196f3 !important;">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-info-circle me-3" style="color: #2196f3; font-size: 1.2rem;"></i>
                                                <div>
                                                    <h6 class="mb-1 fw-bold" style="color: #1976d2;">회원가입 쿠폰 특징</h6>
                                                    <small style="color: #424242;">
                                                        회원가입 쿠폰은 <strong>무제한 발행</strong>되며, 고객이 회원가입할 때 자동으로 발급됩니다.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer border-0 pt-0" style="padding: 0 1.5rem 1rem 1.5rem;">
                                <div class="d-flex gap-3 w-100 justify-content-end">
                                    <button type="button" class="btn btn-light rounded-3 px-3 py-1.5 fw-semibold" onclick="this.closest('.edit-modal-overlay').remove()" 
                                        style="border: 2px solid #e9ecef; transition: all 0.3s ease;" 
                                        onmouseover="this.style.borderColor='#adb5bd'; this.style.backgroundColor='#f8f9fa'" 
                                        onmouseout="this.style.borderColor='#e9ecef'; this.style.backgroundColor='#f8f9fa'">
                                        <i class="fas fa-times me-2"></i>취소
                                    </button>
                                    <button type="button" class="btn btn-primary rounded-3 px-3 py-1.5 fw-semibold shadow-sm" onclick="saveEditedTemplate()" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; transition: all 0.3s ease;" 
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.4)'" 
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.2)'">
                                        <i class="fas fa-save me-2"></i>${isAddMode ? '생성하기' : '저장하기'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            editDialog.className = "edit-modal-overlay";
            document.body.appendChild(editDialog);
            document.body.classList.add('modal-open');
}

// 타입별 표시명 반환
function getTypeDisplayName(type) {
    const typeNames = {
        'SIGNUP': '회원가입 쿠폰',
        'CUMULATIVE': '누적매출 쿠폰', 
        'MONTHLY': '전월매출 쿠폰'
    };
    return typeNames[type] || type;
}

// 편집 다이얼로그의 혜택 유형 변경 처리
function handleEditBenefitTypeChange() {
    const benefitType = document.getElementById('editModalBenefitType').value;
    const discountGroup = document.getElementById('editDiscountAmountGroup');
    const productGroup = document.getElementById('editProductNameGroup');
    
    discountGroup.style.display = 'none';
    productGroup.style.display = 'none';
    
    if (benefitType === 'DISCOUNT' || benefitType === 'BOTH') {
        discountGroup.style.display = 'block';
    }
    
    if (benefitType === 'PRODUCT' || benefitType === 'BOTH') {
        productGroup.style.display = 'block';
    }
}

// 편집 다이얼로그의 무기한 사용 체크박스 변경 처리
function handleEditPermanentChange() {
    const isPermanent = document.getElementById('editIsPermanent').checked;
    const validityPeriod = document.getElementById('editValidityPeriod');
    
    if (isPermanent) {
        validityPeriod.style.display = 'none';
        document.getElementById('editValidFrom').value = '';
        document.getElementById('editValidUntil').value = '';
    } else {
        validityPeriod.style.display = 'block';
    }
}

// 편집된 템플릿 저장 (새 추가 모드와 수정 모드 모두 지원)
function saveEditedTemplate() {
    const templateId = document.getElementById('editTemplateId').value;
    const couponType = document.getElementById('editModalCouponType').value;
    const isAddMode = !templateId; // templateId가 비어있으면 새 추가 모드
    
    console.log('저장 모드:', isAddMode ? '새 추가' : '수정');
    console.log('templateId:', templateId);
    console.log('couponType:', couponType);
    
    const formData = new FormData();
    if (!isAddMode) {
        formData.append('template_id', templateId);
    }
    formData.append('coupon_type', couponType);
    formData.append('coupon_name', document.getElementById('editCouponName').value);
    formData.append('description', document.getElementById('editTemplateDescription').value);
    formData.append('benefit_type', document.getElementById('editModalBenefitType').value);
    formData.append('discount_amount', document.getElementById('editDiscountAmount').value);
    formData.append('product_name', document.getElementById('editProductName').value);
    formData.append('is_permanent', document.getElementById('editIsPermanent').checked);
    formData.append('valid_from', document.getElementById('editValidFrom').value);
    formData.append('valid_until', document.getElementById('editValidUntil').value);
    
    // 조건 데이터 (누적매출, 전월매출 쿠폰만)
    if (couponType === 'CUMULATIVE' || couponType === 'MONTHLY') {
        formData.append('threshold_amount', document.getElementById('editThresholdAmount').value);
    }
    
    // API 엔드포인트 결정 (새 추가면 create, 수정이면 update)
    const apiUrl = isAddMode ? '/station/auto-coupons/create/' : `/station/auto-coupons/${templateId}/update/`;
    
    fetch(apiUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 다이얼로그 닫기
            document.querySelector('.edit-modal-overlay').remove();
            document.body.classList.remove('modal-open');
            
            // 템플릿 목록 새로고침
            loadAllTemplates();
            
            showToast(data.message || (isAddMode ? '템플릿이 생성되었습니다.' : '템플릿이 수정되었습니다.'), 'success');
        } else {
            showToast(data.message || '오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('템플릿 저장 오류:', error);
        showToast((isAddMode ? '템플릿 생성' : '템플릿 저장') + ' 중 오류가 발생했습니다.', 'error');
    });
}

// 템플릿 활성/비활성 토글
function toggleTemplate(templateId) {
    fetch(`/station/auto-coupons/${templateId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            loadAllTemplates();
            showToast(data.message, 'success');
        } else {
            showToast(data.message || '오류가 발생했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('템플릿 토글 오류:', error);
    });
}

// 템플릿 삭제
function deleteTemplate(templateId) {
    const template = findTemplateById(templateId);
    if (!template) return;
    
    if (confirm(`"${template.coupon_name}" 템플릿을 정말 삭제하시겠습니까?`)) {
        fetch(`/station/auto-coupons/${templateId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadAllTemplates();
                showToast(data.message || '템플릿이 삭제되었습니다.', 'success');
            } else {
                showToast(data.message || '삭제 중 오류가 발생했습니다.', 'error');
            }
        })
        .catch(error => {
            console.error('템플릿 삭제 오류:', error);
        });
    }
}

// 유틸리티 함수들
function findTemplateById(templateId) {
    for (const type in templates) {
        const template = templates[type].find(t => t.id === templateId);
        if (template) return template;
    }
    return null;
}


// 기존 코드와의 호환성을 위한 빈 함수들
function saveSignupCouponSettings() {
    console.log('구 시스템 함수 - 신규 시스템으로 대체됨');
}

function saveCumulativeCouponSettings() {
    console.log('구 시스템 함수 - 신규 시스템으로 대체됨');
}

function saveMonthlyCouponSettings() {
    console.log('구 시스템 함수 - 신규 시스템으로 대체됨');
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded 이벤트 시작 ===');
    
    // 새로운 자동 쿠폰 CRUD 시스템 초기화
    console.log('1. loadAllTemplates 호출');
    loadAllTemplates();
    
    // 기존 시스템 초기화
    console.log('2. initializePage 호출');
    initializePage();
    
    // 탭 변경 이벤트 리스너
    console.log('3. 탭 이벤트 리스너 등록 시작');
    const tabButtons = document.querySelectorAll('#couponTabs button[data-bs-toggle="tab"]');
    console.log('   - 찾은 탭 버튼 개수:', tabButtons.length);
    
    tabButtons.forEach(function(tab, index) {
        const tabId = tab.id;
        const targetPane = tab.getAttribute('data-bs-target');
        console.log(`   - 탭 ${index}: ID="${tabId}", Target="${targetPane}"`);
        
        tab.addEventListener('shown.bs.tab', function(event) {
            console.log('=== 탭 전환 이벤트 발생 ===');
            console.log('   - 이전 탭:', event.relatedTarget ? event.relatedTarget.id : 'none');
            console.log('   - 현재 탭:', event.target.id);
            
            var targetTab = event.target.getAttribute('data-bs-target');
            console.log('   - Target 속성:', targetTab);
            
            if (targetTab === '#auto-coupon') {
                console.log('   → 자동 쿠폰 탭 활성화 - loadAutoCouponStatus() 호출');
                loadAutoCouponStatus();
            } else if (targetTab === '#manual-coupon') {
                console.log('   → 수동 쿠폰 탭 활성화 - loadManualCouponData() 호출');
                loadManualCouponData();
            } else if (targetTab === '#coupon-management') {
                console.log('   → 쿠폰 관리 탭 활성화 - loadCouponManagementData() 호출');
                loadCouponManagementData();
            } else {
                console.log('   → 알 수 없는 탭:', targetTab);
            }
        });
        
        // click 이벤트도 추가로 로깅
        tab.addEventListener('click', function(event) {
            console.log(`[클릭 이벤트] 탭 "${tabId}" 클릭됨`);
        });
    });
    
    console.log('4. 탭 이벤트 리스너 등록 완료');
    
    // Auto coupon templates will be loaded dynamically
    
    // 수동 쿠폰 폼 이벤트
    console.log('5. setupManualCouponForms 호출');
    setupManualCouponForms();
    
    console.log('=== DOMContentLoaded 이벤트 종료 ===');
    
    // 초기 탭 상태 확인
    console.log('=== 초기 탭 상태 확인 ===');
    const activeTab = document.querySelector('#couponTabs .nav-link.active');
    const activePane = document.querySelector('#couponTabContent .tab-pane.active');
    if (activeTab) {
        console.log('   - 활성 탭 버튼:', activeTab.id, '/ Target:', activeTab.getAttribute('data-bs-target'));
    }
    if (activePane) {
        console.log('   - 활성 탭 패널:', activePane.id);
    }
    
    // 모든 탭 패널 상태 확인
    document.querySelectorAll('#couponTabContent .tab-pane').forEach(function(pane) {
        const isActive = pane.classList.contains('active');
        const isShow = pane.classList.contains('show');
        console.log(`   - 패널 "${pane.id}": active=${isActive}, show=${isShow}`);
    });
});

function initializePage() {
    console.log('=== initializePage 함수 실행 ===');
    // Load data for different tabs
    console.log('   - loadCouponTypes 호출');
    loadCouponTypes();
    loadCouponTemplates();
    loadGroups();
    loadCustomers();
}

// Auto coupon templates are now managed using CRUD operations

// 수동 쿠폰 관련 함수들
function setupManualCouponForms() {
    // 혜택 유형 변경 이벤트
    document.getElementById('benefitType').addEventListener('change', function() {
        const discountSection = document.getElementById('discountSection');
        const productSection = document.getElementById('productSection');
        
        if (this.value === 'DISCOUNT' || this.value === 'BOTH') {
            discountSection.style.display = 'block';
        } else {
            discountSection.style.display = 'none';
        }
        
        if (this.value === 'PRODUCT' || this.value === 'BOTH') {
            productSection.style.display = 'block';
        } else {
            productSection.style.display = 'none';
        }
    });
    
    // 발행 대상 변경 이벤트
    document.getElementById('targetType').addEventListener('change', function() {
        const groupSection = document.getElementById('groupSection');
        const individualSection = document.getElementById('individualSection');
        
        if (this.value === 'group') {
            groupSection.style.display = 'block';
            individualSection.style.display = 'none';
        } else if (this.value === 'individual') {
            groupSection.style.display = 'none';
            individualSection.style.display = 'block';
        } else {
            groupSection.style.display = 'none';
            individualSection.style.display = 'none';
        }
    });
    
    // 수동 쿠폰 유효기간 무기한 체크박스 이벤트
    document.getElementById('manualIsPermanent').addEventListener('change', function() {
        const validityPeriod = document.getElementById('manualValidityPeriod');
        validityPeriod.style.display = this.checked ? 'none' : 'block';
    });
    
    // 쿠폰 생성 폼 제출
    document.getElementById('couponCreationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createCoupon();
    });
    
    // 쿠폰 발행 폼 제출
    document.getElementById('couponIssuanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        issueCoupon();
    });
}

function loadManualCouponData() {
    loadCouponQuota();
    loadCouponTemplates();
}

function loadCouponQuota() {
    fetch('{% url "station:purchase_request_status" %}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const quota = data.data.quota;
                document.getElementById('totalQuota').textContent = quota.total_quota;
                document.getElementById('usedQuota').textContent = quota.used_quota;
                document.getElementById('remainingQuota').textContent = quota.remaining_quota;
            }
        })
        .catch(error => console.error('쿠폰 수량 로드 오류:', error));
}

function createCoupon() {
    const form = document.getElementById('couponCreationForm');
    const formData = new FormData(form);
    
    fetch('{% url "station:create_coupon_template" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast('쿠폰이 성공적으로 생성되었습니다.', 'success');
            form.reset();
            loadCouponTemplates();
        } else {
            showToast(data.message || '쿠폰 생성에 실패했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('쿠폰 생성 오류:', error);
        showToast('쿠폰 생성 중 오류가 발생했습니다.', 'error');
    });
}

function issueCoupon() {
    const form = document.getElementById('couponIssuanceForm');
    const formData = new FormData(form);
    
    fetch('{% url "station:send_coupon" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            form.reset();
            loadCouponQuota();
        } else {
            showToast(data.message || '쿠폰 발행에 실패했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('쿠폰 발행 오류:', error);
        showToast('쿠폰 발행 중 오류가 발생했습니다.', 'error');
    });
}

// 데이터 로드 함수들
function loadCouponTypes() {
    // 쿠폰 유형 드롭다운 업데이트 (수동 쿠폰용만)
    fetch('{% url "station:get_coupon_types" %}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const select = document.getElementById('couponType');
                if (select) {
                    select.innerHTML = '<option value="">쿠폰 유형 선택...</option>';
                    data.data.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.type_name;
                        select.appendChild(option);
                    });
                }
            }
        })
        .catch(error => console.error('쿠폰 유형 로드 오류:', error));
}

function loadCouponTemplates() {
    fetch('{% url "station:get_coupon_templates" %}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateTemplateSelects(data.templates);
            }
        })
        .catch(error => console.error('쿠폰 템플릿 로드 오류:', error));
}

function updateTemplateSelects(templates) {
    const selects = [
        'signupTemplate',
        'cumulativeTemplate', 
        'monthlyTemplate',
        'issueCouponTemplate'
    ];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">템플릿 선택...</option>';
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.coupon_name;
                select.appendChild(option);
            });
        }
    });
}

function loadGroups() {
    fetch('{% url "station:get_groups" %}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateGroupSelect(data.groups);
            }
        })
        .catch(error => console.error('그룹 로드 오류:', error));
}

function updateGroupSelect(groups) {
    const select = document.getElementById('targetGroup');
    select.innerHTML = '<option value="">그룹 선택...</option>';
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.id;
        option.textContent = group.name;
        select.appendChild(option);
    });
}

function loadCustomers() {
    // 고객 목록 로드 로직 (기존 코드 참조)
}

// 쿠폰 관리 탭 관련 함수들
function loadCouponManagementData() {
    console.log('=== loadCouponManagementData 함수 실행 ===');
    console.log('   - refreshCouponList 호출 예정');
    refreshCouponList();
    console.log('=== loadCouponManagementData 함수 종료 ===');
}

function refreshCouponList() {
    console.log('=== refreshCouponList 함수 실행 ===');
    console.log('   - 쿠폰 목록 테이블 확인');
    const table = document.querySelector('#couponListTable');
    if (table) {
        console.log('   - 테이블 찾음:', table);
        const tbody = table.querySelector('tbody');
        if (tbody) {
            console.log('   - tbody 찾음, 현재 행 개수:', tbody.rows.length);
            // 페이지 새로고침 대신 로그만 출력 (테스트용)
            console.log('   - 페이지 새로고침 대신 데이터 확인만 수행');
            // window.location.reload();
        } else {
            console.error('   - tbody를 찾을 수 없음!');
        }
    } else {
        console.error('   - 쿠폰 목록 테이블을 찾을 수 없음!');
    }
    console.log('=== refreshCouponList 함수 종료 ===');
}


// 쿠폰 구매 요청 관련 함수들
function requestCouponPurchase() {
    const modal = new bootstrap.Modal(document.getElementById('purchaseRequestModal'));
    modal.show();
}

function submitPurchaseRequest() {
    const quantity = document.getElementById('purchaseQuantity').value;
    
    if (!quantity || quantity < 1 || quantity > 1000) {
        showToast('1~1000개 사이의 수량을 입력해주세요.', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('quantity', quantity);
    
    fetch('{% url "station:request_coupon_purchase" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('purchaseRequestModal')).hide();
        } else {
            showToast(data.message || '구매 요청에 실패했습니다.', 'error');
        }
    })
    .catch(error => {
        console.error('구매 요청 오류:', error);
        showToast('구매 요청 중 오류가 발생했습니다.', 'error');
    });
}

// 통계 관련 함수들
let monthlyChart = null;
let typeChart = null;

function loadStatistics() {
    console.log('🔄 [STATS] loadStatistics 함수 시작');
    console.log('🔄 [STATS] 현재 시간:', new Date().toISOString());
    
    // 통계 탭 활성화 상태 확인
    const statisticsTab = document.getElementById('statistics-tab');
    const statisticsPane = document.getElementById('statistics');
    console.log('📊 [STATS] 통계 탭 상태 확인:');
    console.log('   - 탭 버튼 존재:', !!statisticsTab);
    console.log('   - 탭 버튼 active 클래스:', statisticsTab?.classList.contains('active'));
    console.log('   - 탭 패널 존재:', !!statisticsPane);
    console.log('   - 탭 패널 active 클래스:', statisticsPane?.classList.contains('active'));
    
    // 캔버스 요소들 상태 확인
    const monthlyCanvas = document.getElementById('monthlyChart');
    const typeCanvas = document.getElementById('typeChart');
    console.log('🎨 [CANVAS] 캔버스 요소 상태:');
    console.log('   - monthlyChart 존재:', !!monthlyCanvas);
    if (monthlyCanvas) {
        console.log('   - monthlyChart 크기:', {
            width: monthlyCanvas.width,
            height: monthlyCanvas.height,
            clientWidth: monthlyCanvas.clientWidth,
            clientHeight: monthlyCanvas.clientHeight,
            offsetWidth: monthlyCanvas.offsetWidth,
            offsetHeight: monthlyCanvas.offsetHeight,
            style: monthlyCanvas.style.cssText
        });
    }
    console.log('   - typeChart 존재:', !!typeCanvas);
    if (typeCanvas) {
        console.log('   - typeChart 크기:', {
            width: typeCanvas.width,
            height: typeCanvas.height,
            clientWidth: typeCanvas.clientWidth,
            clientHeight: typeCanvas.clientHeight,
            offsetWidth: typeCanvas.offsetWidth,
            offsetHeight: typeCanvas.offsetHeight,
            style: typeCanvas.style.cssText
        });
    }
    
    // 기존 차트 인스턴스 상태 확인
    console.log('📈 [CHARTS] 기존 차트 인스턴스:');
    console.log('   - monthlyChart 존재:', !!monthlyChart);
    console.log('   - typeChart 존재:', !!typeChart);
    
    fetch('{% url "station:coupon_statistics" %}')
        .then(response => {
            console.log('✅ [API] 통계 API 응답 받음');
            return response.json();
        })
        .then(data => {
            console.log('📊 [API] 통계 데이터:', data);
            if (data.status === 'success') {
                console.log('✅ [API] 통계 데이터 성공, updateStatisticsDisplay 호출');
                updateStatisticsDisplay(data.data);
            } else {
                console.error('❌ [API] 통계 데이터 로드 실패:', data.message);
                showToast('통계 데이터 로드 실패: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('❌ [API] 통계 로드 오류:', error);
            showToast('통계 데이터 로드 중 오류가 발생했습니다.', 'error');
        });
    
    console.log('🔄 [STATS] loadStatistics 함수 종료 (비동기 요청 시작함)');
}

function updateStatisticsDisplay(data) {
    // 1. 기본 통계 업데이트
    document.getElementById('totalIssuedCount').textContent = data.basic_stats.total_issued.toLocaleString();
    document.getElementById('totalUsedCount').textContent = data.basic_stats.total_used.toLocaleString();
    document.getElementById('totalAvailableCount').textContent = data.basic_stats.total_available.toLocaleString();
    document.getElementById('usageRate').textContent = data.basic_stats.usage_rate + '%';
    
    // 2. 월별 차트 업데이트
    updateMonthlyChart(data.monthly_stats);
    
    // 3. 타입별 차트 업데이트
    updateTypeChart(data.type_stats);
}

function updateMonthlyChart(monthlyData) {
    console.log('📈 [MONTHLY] updateMonthlyChart 시작');
    console.log('📈 [MONTHLY] 입력 데이터:', monthlyData);
    
    const canvas = document.getElementById('monthlyChart');
    console.log('🎨 [MONTHLY] 캔버스 상태 (업데이트 전):');
    console.log('   - 캔버스 존재:', !!canvas);
    if (canvas) {
        console.log('   - 캔버스 크기:', {
            width: canvas.width,
            height: canvas.height,
            clientWidth: canvas.clientWidth,
            clientHeight: canvas.clientHeight,
            offsetWidth: canvas.offsetWidth,
            offsetHeight: canvas.offsetHeight,
            style: canvas.style.cssText
        });
        console.log('   - 부모 컨테이너 크기:', {
            parentWidth: canvas.parentElement?.offsetWidth,
            parentHeight: canvas.parentElement?.offsetHeight,
            parentStyle: canvas.parentElement?.style.cssText
        });
    }
    
    const ctx = canvas.getContext('2d');
    console.log('🎨 [MONTHLY] Context 획득:', !!ctx);
    
    // 기존 차트 제거
    console.log('🗑️ [MONTHLY] 기존 차트 확인 및 제거:');
    console.log('   - 기존 monthlyChart 존재:', !!monthlyChart);
    if (monthlyChart) {
        console.log('   - 기존 차트 제거 중...');
        monthlyChart.destroy();
        console.log('   - 기존 차트 제거 완료');
        monthlyChart = null;
    }
    
    // 캔버스 상태 다시 확인 (차트 제거 후)
    console.log('🎨 [MONTHLY] 캔버스 상태 (차트 제거 후):');
    console.log('   - 캔버스 크기:', {
        width: canvas.width,
        height: canvas.height,
        clientWidth: canvas.clientWidth,
        clientHeight: canvas.clientHeight,
        offsetWidth: canvas.offsetWidth,
        offsetHeight: canvas.offsetHeight
    });
    
    const labels = monthlyData.map(item => item.month);
    const issuedData = monthlyData.map(item => item.issued);
    const usedData = monthlyData.map(item => item.used);
    
    console.log('📊 [MONTHLY] 차트 데이터 준비:');
    console.log('   - 라벨:', labels);
    console.log('   - 발행 데이터:', issuedData);
    console.log('   - 사용 데이터:', usedData);
    
    console.log('🔨 [MONTHLY] 새 차트 생성 중...');
    monthlyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '발행',
                    data: issuedData,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4
                },
                {
                    label: '사용',
                    data: usedData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    console.log('✅ [MONTHLY] 새 차트 생성 완료');
    console.log('🎨 [MONTHLY] 최종 캔버스 상태:');
    console.log('   - 캔버스 크기:', {
        width: canvas.width,
        height: canvas.height,
        clientWidth: canvas.clientWidth,
        clientHeight: canvas.clientHeight,
        offsetWidth: canvas.offsetWidth,
        offsetHeight: canvas.offsetHeight
    });
    console.log('📈 [MONTHLY] updateMonthlyChart 완료');
}

function updateTypeChart(typeData) {
    console.log('🥧 [TYPE] updateTypeChart 시작');
    console.log('🥧 [TYPE] 입력 데이터:', typeData);
    
    const canvas = document.getElementById('typeChart');
    console.log('🎨 [TYPE] 캔버스 상태 (업데이트 전):');
    console.log('   - 캔버스 존재:', !!canvas);
    if (canvas) {
        console.log('   - 캔버스 크기:', {
            width: canvas.width,
            height: canvas.height,
            clientWidth: canvas.clientWidth,
            clientHeight: canvas.clientHeight,
            offsetWidth: canvas.offsetWidth,
            offsetHeight: canvas.offsetHeight,
            style: canvas.style.cssText
        });
        console.log('   - 부모 컨테이너 크기:', {
            parentWidth: canvas.parentElement?.offsetWidth,
            parentHeight: canvas.parentElement?.offsetHeight,
            parentStyle: canvas.parentElement?.style.cssText
        });
    }
    
    const ctx = canvas.getContext('2d');
    console.log('🎨 [TYPE] Context 획득:', !!ctx);
    
    // 기존 차트 제거
    console.log('🗑️ [TYPE] 기존 차트 확인 및 제거:');
    console.log('   - 기존 typeChart 존재:', !!typeChart);
    if (typeChart) {
        console.log('   - 기존 차트 제거 중...');
        typeChart.destroy();
        console.log('   - 기존 차트 제거 완료');
        typeChart = null;
    }
    
    // 캔버스 상태 다시 확인 (차트 제거 후)
    console.log('🎨 [TYPE] 캔버스 상태 (차트 제거 후):');
    console.log('   - 캔버스 크기:', {
        width: canvas.width,
        height: canvas.height,
        clientWidth: canvas.clientWidth,
        clientHeight: canvas.clientHeight,
        offsetWidth: canvas.offsetWidth,
        offsetHeight: canvas.offsetHeight
    });
    
    if (typeData.length === 0) {
        console.log('⚠️ [TYPE] 데이터가 없음, 빈 메시지 표시');
        ctx.fillText('데이터가 없습니다.', 50, 100);
        return;
    }
    
    const labels = typeData.map(item => item.name);
    const data = typeData.map(item => item.issued);
    const colors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)'
    ];
    
    console.log('📊 [TYPE] 차트 데이터 준비:');
    console.log('   - 라벨:', labels);
    console.log('   - 데이터:', data);
    console.log('   - 색상 개수:', colors.length);
    
    console.log('🔨 [TYPE] 새 차트 생성 중...');
    typeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, data.length),
                borderColor: colors.slice(0, data.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
    
    console.log('✅ [TYPE] 새 차트 생성 완료');
    console.log('🎨 [TYPE] 최종 캔버스 상태:');
    console.log('   - 캔버스 크기:', {
        width: canvas.width,
        height: canvas.height,
        clientWidth: canvas.clientWidth,
        clientHeight: canvas.clientHeight,
        offsetWidth: canvas.offsetWidth,
        offsetHeight: canvas.offsetHeight
    });
    console.log('🥧 [TYPE] updateTypeChart 완료');
}


// 탭 변경 시 통계 로드
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 [INIT] DOMContentLoaded - 이벤트 리스너 등록 중...');
    
    const statisticsTab = document.getElementById('statistics-tab');
    if (statisticsTab) {
        console.log('✅ [INIT] statistics-tab 요소 찾음');
        
        // Bootstrap 탭 이벤트 사용
        statisticsTab.addEventListener('shown.bs.tab', function(event) {
            console.log('🎯 [EVENT] shown.bs.tab 이벤트 발생!');
            console.log('   - 이벤트 시간:', new Date().toISOString());
            console.log('   - 타겟 탭:', event.target.id);
            console.log('   - 타겟 패널:', event.target.getAttribute('data-bs-target'));
            console.log('   - 이전 탭:', event.relatedTarget?.id || 'none');
            
            // 캔버스 요소들 존재 여부 확인
            const monthlyCanvas = document.getElementById('monthlyChart');
            const typeCanvas = document.getElementById('typeChart');
            console.log('🎨 [EVENT] 캔버스 요소 확인:');
            console.log('   - monthlyChart 존재:', !!monthlyCanvas);
            console.log('   - typeChart 존재:', !!typeCanvas);
            
            if (monthlyCanvas && typeCanvas) {
                console.log('✅ [EVENT] 캔버스 요소들 존재, loadStatistics 및 모니터링 시작');
                startStatisticsMonitoring();
                loadStatistics();
            } else {
                console.error('❌ [EVENT] 캔버스 요소가 없음! 통계 로드 중단');
            }
        });
        
        console.log('✅ [INIT] shown.bs.tab 이벤트 리스너 등록 완료');
    } else {
        console.error('❌ [INIT] statistics-tab 요소를 찾을 수 없음!');
    }
});

// 캔버스 크기 모니터링 함수
function startCanvasMonitoring() {
    console.log('🔍 [MONITOR] 캔버스 크기 모니터링 시작');
    
    const monitorInterval = setInterval(function() {
        const monthlyCanvas = document.getElementById('monthlyChart');
        const typeCanvas = document.getElementById('typeChart');
        const currentTime = new Date().toISOString();
        
        if (monthlyCanvas) {
            console.log(`📏 [${currentTime}] monthlyChart 크기:`, {
                width: monthlyCanvas.width,
                height: monthlyCanvas.height,
                clientWidth: monthlyCanvas.clientWidth,
                clientHeight: monthlyCanvas.clientHeight,
                offsetWidth: monthlyCanvas.offsetWidth,
                offsetHeight: monthlyCanvas.offsetHeight
            });
            
            // 비정상적인 크기 확장 감지
            if (monthlyCanvas.height > 1000 || monthlyCanvas.offsetHeight > 1000) {
                console.error('🚨 [ALERT] monthlyChart 크기 비정상 확장 감지!');
                console.error('   - 캔버스 높이:', monthlyCanvas.height);
                console.error('   - 오프셋 높이:', monthlyCanvas.offsetHeight);
                clearInterval(monitorInterval);
            }
        }
        
        if (typeCanvas) {
            console.log(`📏 [${currentTime}] typeChart 크기:`, {
                width: typeCanvas.width,
                height: typeCanvas.height,
                clientWidth: typeCanvas.clientWidth,
                clientHeight: typeCanvas.clientHeight,
                offsetWidth: typeCanvas.offsetWidth,
                offsetHeight: typeCanvas.offsetHeight
            });
            
            // 비정상적인 크기 확장 감지
            if (typeCanvas.height > 1000 || typeCanvas.offsetHeight > 1000) {
                console.error('🚨 [ALERT] typeChart 크기 비정상 확장 감지!');
                console.error('   - 캔버스 높이:', typeCanvas.height);
                console.error('   - 오프셋 높이:', typeCanvas.offsetHeight);
                clearInterval(monitorInterval);
            }
        }
    }, 1000); // 1초마다 모니터링
    
    // 30초 후 모니터링 자동 종료
    setTimeout(function() {
        console.log('⏰ [MONITOR] 캔버스 크기 모니터링 자동 종료 (30초 경과)');
        clearInterval(monitorInterval);
    }, 30000);
}

// 통계 탭 활성화 시 모니터링 시작
function startStatisticsMonitoring() {
    console.log('🎯 [MONITOR] 통계 모니터링 시작');
    startCanvasMonitoring();
}

// 디버그 함수 - 현재 탭 상태 확인
function debugTabState() {
    console.log('=== 현재 탭 상태 디버그 ===');
    
    // 활성 탭 버튼 확인
    const activeTabButton = document.querySelector('#couponTabs .nav-link.active');
    if (activeTabButton) {
        console.log('활성 탭 버튼:');
        console.log('   - ID:', activeTabButton.id);
        console.log('   - Text:', activeTabButton.textContent.trim());
        console.log('   - Target:', activeTabButton.getAttribute('data-bs-target'));
        console.log('   - aria-selected:', activeTabButton.getAttribute('aria-selected'));
    } else {
        console.log('활성 탭 버튼을 찾을 수 없음');
    }
    
    // 활성 탭 패널 확인
    const activeTabPane = document.querySelector('#couponTabContent .tab-pane.active');
    if (activeTabPane) {
        console.log('활성 탭 패널:');
        console.log('   - ID:', activeTabPane.id);
        console.log('   - Classes:', activeTabPane.className);
        
        // 패널 내용 확인
        if (activeTabPane.id === 'coupon-management') {
            const table = activeTabPane.querySelector('#couponListTable');
            console.log('   - 쿠폰 목록 테이블 존재:', table ? '있음' : '없음');
            if (table) {
                const tbody = table.querySelector('tbody');
                console.log('   - tbody 행 개수:', tbody ? tbody.rows.length : 0);
            }
        }
    } else {
        console.log('활성 탭 패널을 찾을 수 없음');
    }
    
    // 모든 탭 상태 요약
    console.log('모든 탭 패널 상태:');
    document.querySelectorAll('#couponTabContent .tab-pane').forEach(pane => {
        console.log(`   - ${pane.id}: active=${pane.classList.contains('active')}, show=${pane.classList.contains('show')}`);
    });
    
    console.log('=== 디버그 종료 ===');
}

// 전역 함수로 등록 (콘솔에서 직접 호출 가능)
window.debugTabState = debugTabState;

// 유틸리티 함수들
function showToast(message, type = 'info') {
    // 토스트 메시지 표시 (기존 구현 사용)
    alert(message); // 임시로 alert 사용, 실제로는 토스트 라이브러리 사용
}
</script>

<!-- Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Removed the old Bootstrap modal - now using overlay approach for all template actions -->

{% endblock %}