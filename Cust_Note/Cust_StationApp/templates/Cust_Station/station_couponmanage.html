{% extends 'base/base.html' %}

{% block title %}Oil Note - 쿠폰 노트{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 헤더 섹션 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0 bg-gradient-primary text-white">
                <div class="card-body">
                    <h1 class="card-title h3 mb-3">
                        <i class="fas fa-ticket-alt me-2"></i>쿠폰 노트
                    </h1>
                    <p class="card-text mb-0">{{ station_name }}의 쿠폰을 관리하세요.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠폰 관리 카드들 -->
    <div class="row">
        <!-- 쿠폰 생성 카드 -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm coupon-card">
                <div class="card-body text-center p-4">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                        <i class="fas fa-plus fa-2x text-primary"></i>
                    </div>
                    <h4 class="card-title mb-3">쿠폰 생성</h4>
                    <p class="card-text text-muted mb-4">
                        새로운 쿠폰을 생성하고 할인 조건을 설정합니다.
                    </p>
                    <button class="btn btn-primary btn-lg w-100" onclick="showCouponCreation()">
                        <i class="fas fa-plus me-2"></i>쿠폰 생성하기
                    </button>
                </div>
            </div>
        </div>

        <!-- 쿠폰 발행 카드 -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm coupon-card">
                <div class="card-body text-center p-4">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                        <i class="fas fa-gift fa-2x text-success"></i>
                    </div>
                    <h4 class="card-title mb-3">쿠폰 발행</h4>
                    <p class="card-text text-muted mb-4">
                        생성된 쿠폰을 고객에게 발행하고 관리합니다.
                    </p>
                    <button class="btn btn-success btn-lg w-100" onclick="showCouponIssuance()">
                        <i class="fas fa-gift me-2"></i>쿠폰 발행하기
                    </button>
                </div>
            </div>
        </div>

        <!-- 쿠폰 관리 카드 -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm coupon-card">
                <div class="card-body text-center p-4">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                        <i class="fas fa-cog fa-2x text-info"></i>
                    </div>
                    <h4 class="card-title mb-3">쿠폰 관리</h4>
                    <p class="card-text text-muted mb-4">
                        발행된 쿠폰의 상태를 확인하고 관리합니다.
                    </p>
                    <button class="btn btn-info btn-lg w-100" onclick="showCouponManagement()">
                        <i class="fas fa-cog me-2"></i>쿠폰 관리하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠폰 생성 섹션 (기본적으로 숨김) -->
    <div id="couponCreationSection" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-plus me-2 text-primary"></i>쿠폰 생성
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="hideCouponCreation()">
                            <i class="fas fa-times me-1"></i>닫기
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <form id="couponCreationForm">
                                {% csrf_token %}
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="couponType" class="form-label">쿠폰 유형</label>
                                        <select class="form-select" id="couponType" name="coupon_type_id" required>
                                            <option value="">쿠폰 유형을 선택하세요</option>
                                            {% for coupon_type in coupon_types %}
                                                <option value="{{ coupon_type.id }}" data-code="{{ coupon_type.type_code }}">
                                                    {{ coupon_type.type_name }}
                                                    {% if coupon_type.is_default %}(기본){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="showAddCouponType()">
                                                <i class="fas fa-plus me-1"></i>새 유형 추가
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="couponName" class="form-label">쿠폰명</label>
                                        <input type="text" class="form-control" id="couponName" name="coupon_name" placeholder="쿠폰명을 입력하세요" required>
                                    </div>
                                </div>
                                
                                <!-- 혜택 유형 선택 -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label">혜택 유형</label>
                                        <div class="d-flex gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="benefit_type" id="benefitDiscount" value="DISCOUNT" onchange="toggleBenefitFields()">
                                                <label class="form-check-label" for="benefitDiscount">세차 할인</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="benefit_type" id="benefitProduct" value="PRODUCT" onchange="toggleBenefitFields()">
                                                <label class="form-check-label" for="benefitProduct">상품</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="benefit_type" id="benefitBoth" value="BOTH" onchange="toggleBenefitFields()">
                                                <label class="form-check-label" for="benefitBoth">세차 할인 + 상품</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 세차 할인 혜택 설정 -->
                                <div class="row mb-3" id="discountSection" style="display: none;">
                                    <div class="col-md-6">
                                        <label for="discountValue" class="form-label">세차 할인 금액 (원)</label>
                                        <input type="number" class="form-control" id="discountValue" name="discount_amount" placeholder="세차 서비스 할인 금액을 입력하세요" min="0">
                                    </div>
                                </div>
                                
                                <!-- 상품 혜택 설정 -->
                                <div class="row mb-3" id="productSection" style="display: none;">
                                    <div class="col-md-6">
                                        <label for="productName" class="form-label">상품명</label>
                                        <input type="text" class="form-control" id="productName" name="product_name" placeholder="무료 제공할 상품명을 입력하세요">
                                    </div>
                                </div>
                                
                                <!-- 유효기간 설정 -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="isPermanent" name="is_permanent" onchange="toggleDateFields()">
                                            <label class="form-check-label" for="isPermanent">무기한 쿠폰</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3" id="dateSection">
                                    <div class="col-md-6">
                                        <label for="validFrom" class="form-label">사용 시작일</label>
                                        <input type="date" class="form-control" id="validFrom" name="valid_from">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="validUntil" class="form-label">사용 종료일</label>
                                        <input type="date" class="form-control" id="validUntil" name="valid_until">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="couponDescription" class="form-label">쿠폰 설명</label>
                                    <textarea class="form-control" id="couponDescription" name="description" rows="3" placeholder="쿠폰에 대한 설명을 입력하세요"></textarea>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="hideCouponCreation()">취소</button>
                                    <button type="submit" class="btn btn-primary" id="createCouponBtn">쿠폰 생성</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠폰 발행 섹션 (기본적으로 숨김) -->
    <div id="couponIssuanceSection" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-gift me-2 text-success"></i>쿠폰 발행
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="hideCouponIssuance()">
                            <i class="fas fa-times me-1"></i>닫기
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="couponIssuanceForm">
                                {% csrf_token %}
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="selectCoupon" class="form-label">발행할 쿠폰</label>
                                        <select class="form-select" id="selectCoupon" name="coupon_template_id" required>
                                            <option value="">발행할 쿠폰을 선택하세요</option>
                                            {% for template in coupon_templates %}
                                                <option value="{{ template.id }}">
                                                    {{ template.coupon_name }} ({{ template.coupon_type.type_name }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="customerSelect" class="form-label">발행 대상</label>
                                        <select class="form-select" id="customerSelect" name="target_type" required onchange="toggleTargetOptions()">
                                            <option value="">발행 대상을 선택하세요</option>
                                            <option value="all">전체 고객</option>
                                            <option value="group">특정 그룹</option>
                                            <option value="individual">개별 고객</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3" id="groupSelectRow" style="display: none;">
                                    <div class="col-md-12">
                                        <label for="groupSelect" class="form-label">대상 그룹</label>
                                        <select class="form-select" id="groupSelect" name="group_id">
                                            <option value="">그룹을 선택하세요</option>
                                            {% for group in groups %}
                                                <option value="{{ group.id }}">{{ group.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3" id="customerSelectRow" style="display: none;">
                                    <div class="col-md-12">
                                        <label for="individualCustomer" class="form-label">고객 선택</label>
                                        <input type="text" class="form-control" id="individualCustomer" name="customer_phone" placeholder="고객 전화번호를 입력하세요">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="quantity" class="form-label">1인당 발행 수량</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="issuanceMessage" class="form-label">발행 메시지</label>
                                    <textarea class="form-control" id="issuanceMessage" name="message" rows="3" placeholder="고객에게 전달할 메시지를 입력하세요"></textarea>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-secondary me-2" onclick="hideCouponIssuance()">취소</button>
                                    <button type="submit" class="btn btn-success" id="issueCouponBtn">쿠폰 발행</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">발행 현황</h6>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-primary mb-0">0</h4>
                                            <small class="text-muted">오늘 발행</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success mb-0">0</h4>
                                            <small class="text-muted">이번 주 발행</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 쿠폰 관리 상세 섹션 (기본적으로 숨김) -->
    <div id="couponManagementSection" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2 text-info"></i>쿠폰 관리
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="hideCouponManagement()">
                            <i class="fas fa-times me-1"></i>닫기
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 쿠폰 통계 -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card shadow-sm h-100 border-0 card-clickable" id="allCouponsCard" style="cursor:pointer;">
                                <div class="card-body text-center">
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                        <i class="fas fa-ticket-alt fa-2x text-primary"></i>
                                    </div>
                                    <h5 class="card-title">전체 쿠폰</h5>
                                    <h3 class="text-primary mb-0">{{ total_coupons|default:0 }}장</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card shadow-sm h-100 border-0 card-clickable" id="usedCouponsCard" style="cursor:pointer;">
                                <div class="card-body text-center">
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                        <i class="fas fa-check-circle fa-2x text-success"></i>
                                    </div>
                                    <h5 class="card-title">사용된 쿠폰</h5>
                                    <h3 class="text-success mb-0">{{ used_coupons|default:0 }}장</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card shadow-sm h-100 border-0 card-clickable" id="unusedCouponsCard" style="cursor:pointer;">
                                <div class="card-body text-center">
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                        <i class="fas fa-clock fa-2x text-warning"></i>
                                    </div>
                                    <h5 class="card-title">미사용 쿠폰</h5>
                                    <h3 class="text-warning mb-0">{{ unused_coupons|default:0 }}장</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 생성된 쿠폰 템플릿 목록 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white border-0">
                                    <h5 class="mb-0">
                                        <i class="fas fa-ticket-alt me-2 text-primary"></i>생성된 쿠폰 템플릿 ({{ coupon_templates|length }}개)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    {% if coupon_templates %}
                                        <div class="row">
                                            {% for template in coupon_templates %}
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="card border">
                                                    <div class="card-body">
                                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                                            <span class="badge bg-secondary">{{ template.coupon_type.type_name }}</span>
                                                            <span class="badge {% if template.is_permanent %}bg-success{% else %}bg-warning{% endif %}">
                                                                {% if template.is_permanent %}무기한{% else %}기간제{% endif %}
                                                            </span>
                                                        </div>
                                                        <h6 class="card-title">{{ template.coupon_name }}</h6>
                                                        <p class="card-text text-success fw-bold">{{ template.get_benefit_description }}</p>
                                                        {% if template.description %}
                                                        <p class="card-text"><small class="text-muted">{{ template.description }}</small></p>
                                                        {% endif %}
                                                        {% if not template.is_permanent %}
                                                        <p class="card-text">
                                                            <small class="text-muted">
                                                                {{ template.valid_from|date:"Y-m-d" }} ~ {{ template.valid_until|date:"Y-m-d" }}
                                                            </small>
                                                        </p>
                                                        {% endif %}
                                                        <small class="text-muted">생성일: {{ template.created_at|date:"Y-m-d H:i" }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-ticket-alt fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">생성된 쿠폰 템플릿이 없습니다.</p>
                                            <small class="text-muted">쿠폰 생성 버튼을 클릭하여 새 쿠폰을 만들어보세요.</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 최근 쿠폰 활동 -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white border-0">
                                    <h5 class="mb-0">
                                        <i class="fas fa-history me-2 text-secondary"></i>최근 쿠폰 활동
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="text-center py-5">
                                        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                                        <p class="text-muted mb-3">아직 쿠폰 활동이 없습니다.</p>
                                        <small class="text-muted">쿠폰을 생성하고 발행하면 여기에 활동 내역이 표시됩니다.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 전체 쿠폰 리스트 모달 -->
<div class="modal fade" id="allCouponsModal" tabindex="-1" aria-labelledby="allCouponsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="allCouponsModalLabel"><i class="fas fa-ticket-alt me-2"></i>전체 발행 쿠폰 리스트</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>고객명</th>
                <th>쿠폰명</th>
                <th>상태</th>
                <th>발행일</th>
                <th>만료일</th>
              </tr>
            </thead>
            <tbody>
              {% for coupon in all_coupons %}
              <tr>
                <td>{{ coupon.customer.username }}</td>
                <td>{{ coupon.coupon_template.coupon_name }}</td>
                <td>
                  {% if coupon.status == 'USED' %}
                    <span class="badge bg-secondary">사용완료</span>
                  {% elif coupon.status == 'EXPIRED' %}
                    <span class="badge bg-danger">만료됨</span>
                  {% else %}
                    <span class="badge bg-success">사용가능</span>
                  {% endif %}
                </td>
                <td>{{ coupon.issued_date|date:'Y-m-d H:i' }}</td>
                <td>{{ coupon.expiry_date|default:coupon.coupon_template.valid_until|date:'Y-m-d' }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">발행된 쿠폰이 없습니다.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<!-- 사용된 쿠폰 리스트 모달 -->
<div class="modal fade" id="usedCouponsModal" tabindex="-1" aria-labelledby="usedCouponsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="usedCouponsModalLabel"><i class="fas fa-check-circle me-2 text-success"></i>사용된 쿠폰 리스트</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>고객명</th>
                <th>쿠폰명</th>
                <th>발행일</th>
                <th>사용일</th>
                <th>만료일</th>
              </tr>
            </thead>
            <tbody>
              {% for coupon in used_coupons_list %}
              <tr>
                <td>{{ coupon.customer.username }}</td>
                <td>{{ coupon.coupon_template.coupon_name }}</td>
                <td>{{ coupon.issued_date|date:'Y-m-d H:i' }}</td>
                <td>{{ coupon.used_date|date:'Y-m-d H:i' }}</td>
                <td>{{ coupon.expiry_date|default:coupon.coupon_template.valid_until|date:'Y-m-d' }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">사용된 쿠폰이 없습니다.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
<!-- 미사용 쿠폰 리스트 모달 -->
<div class="modal fade" id="unusedCouponsModal" tabindex="-1" aria-labelledby="unusedCouponsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="unusedCouponsModalLabel"><i class="fas fa-clock me-2 text-warning"></i>미사용 쿠폰 리스트</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>고객명</th>
                <th>쿠폰명</th>
                <th>발행일</th>
                <th>만료일</th>
              </tr>
            </thead>
            <tbody>
              {% for coupon in unused_coupons_list %}
              <tr>
                <td>{{ coupon.customer.username }}</td>
                <td>{{ coupon.coupon_template.coupon_name }}</td>
                <td>{{ coupon.issued_date|date:'Y-m-d H:i' }}</td>
                <td>{{ coupon.expiry_date|default:coupon.coupon_template.valid_until|date:'Y-m-d' }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center text-muted">미사용 쿠폰이 없습니다.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.coupon-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border-radius: 12px;
}

.coupon-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 500;
}

.card-clickable {
    cursor: pointer;
}

/* 모달이 네브바와 겹치지 않도록 상단 여백 추가 */
.modal-dialog {
    margin-top: 80px !important;
    margin-bottom: 20px !important;
}

@media (max-width: 768px) {
    .coupon-card {
        margin-bottom: 1rem;
    }
    .modal-dialog {
        margin-top: 60px !important;
    }
}
</style>

<script>
function showCouponCreation() {
    hideAllSections();
    document.getElementById('couponCreationSection').style.display = 'block';
    document.getElementById('couponCreationSection').scrollIntoView({ 
        behavior: 'smooth' 
    });
    
    // 만료일 기본값 설정 (현재 날짜 기준 한 달 후)
    const today = new Date();
    const oneMonthLater = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const expiryDateInput = document.getElementById('expiryDate');
    if (expiryDateInput) {
        expiryDateInput.value = oneMonthLater.toISOString().split('T')[0];
    }
}

function hideCouponCreation() {
    document.getElementById('couponCreationSection').style.display = 'none';
}

function showCouponIssuance() {
    hideAllSections();
    document.getElementById('couponIssuanceSection').style.display = 'block';
    document.getElementById('couponIssuanceSection').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function hideCouponIssuance() {
    document.getElementById('couponIssuanceSection').style.display = 'none';
}

function showCouponManagement() {
    hideAllSections();
    document.getElementById('couponManagementSection').style.display = 'block';
    document.getElementById('couponManagementSection').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function hideCouponManagement() {
    document.getElementById('couponManagementSection').style.display = 'none';
}

function hideAllSections() {
    document.getElementById('couponCreationSection').style.display = 'none';
    document.getElementById('couponIssuanceSection').style.display = 'none';
    document.getElementById('couponManagementSection').style.display = 'none';
}

function toggleBenefitFields() {
    const discountRadio = document.getElementById('benefitDiscount');
    const productRadio = document.getElementById('benefitProduct');
    const bothRadio = document.getElementById('benefitBoth');
    const discountSection = document.getElementById('discountSection');
    const productSection = document.getElementById('productSection');
    
    if (discountRadio.checked) {
        discountSection.style.display = 'block';
        productSection.style.display = 'none';
    } else if (productRadio.checked) {
        discountSection.style.display = 'none';
        productSection.style.display = 'block';
    } else if (bothRadio.checked) {
        discountSection.style.display = 'block';
        productSection.style.display = 'block';
    } else {
        discountSection.style.display = 'none';
        productSection.style.display = 'none';
    }
}

function toggleDateFields() {
    const isPermanent = document.getElementById('isPermanent');
    const dateSection = document.getElementById('dateSection');
    
    if (isPermanent.checked) {
        dateSection.style.display = 'none';
    } else {
        dateSection.style.display = 'block';
    }
}

function toggleTargetOptions() {
    const targetType = document.getElementById('customerSelect').value;
    const groupRow = document.getElementById('groupSelectRow');
    const customerRow = document.getElementById('customerSelectRow');
    
    if (targetType === 'group') {
        groupRow.style.display = 'block';
        customerRow.style.display = 'none';
    } else if (targetType === 'individual') {
        groupRow.style.display = 'none';
        customerRow.style.display = 'block';
    } else {
        groupRow.style.display = 'none';
        customerRow.style.display = 'none';
    }
}

// 쿠폰 생성 폼 제출
document.addEventListener('DOMContentLoaded', function() {
    const couponCreationForm = document.getElementById('couponCreationForm');
    if (couponCreationForm) {
        couponCreationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const createBtn = document.getElementById('createCouponBtn');
            
            createBtn.disabled = true;
            createBtn.textContent = '생성 중...';
            
            fetch('/station/create-coupon-template/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('쿠폰이 성공적으로 생성되었습니다.');
                    location.reload(); // 페이지 새로고침
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('쿠폰 생성 중 오류가 발생했습니다.');
            })
            .finally(() => {
                createBtn.disabled = false;
                createBtn.textContent = '쿠폰 생성';
            });
        });
    }
    
    // 쿠폰 발행 폼 제출
    const couponIssuanceForm = document.getElementById('couponIssuanceForm');
    if (couponIssuanceForm) {
        couponIssuanceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const issueBtn = document.getElementById('issueCouponBtn');
            
            issueBtn.disabled = true;
            issueBtn.textContent = '발행 중...';
            
            fetch('/station/send-coupon/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`쿠폰이 성공적으로 발행되었습니다. (${data.issued_count}개)`);
                    location.reload(); // 페이지 새로고침
                } else {
                    alert('오류: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('쿠폰 발행 중 오류가 발생했습니다.');
            })
            .finally(() => {
                issueBtn.disabled = false;
                issueBtn.textContent = '쿠폰 발행';
            });
        });
    }

    // 전체 쿠폰 카드 클릭 시 모달 오픈
    const allCouponsCard = document.getElementById('allCouponsCard');
    if (allCouponsCard) {
        allCouponsCard.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('allCouponsModal'));
            modal.show();
        });
    }
    // 사용된 쿠폰 카드 클릭 시 모달 오픈
    const usedCouponsCard = document.getElementById('usedCouponsCard');
    if (usedCouponsCard) {
        usedCouponsCard.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('usedCouponsModal'));
            modal.show();
        });
    }
    // 미사용 쿠폰 카드 클릭 시 모달 오픈
    const unusedCouponsCard = document.getElementById('unusedCouponsCard');
    if (unusedCouponsCard) {
        unusedCouponsCard.addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('unusedCouponsModal'));
            modal.show();
        });
    }
});
</script>
{% endblock %} 