{% extends 'base/base.html' %}
{% load static %}
{% load phone_filters %}

{% block title %}Oil Note - 고객 노트{% endblock %}

{% block extra_css %}
<style>
    /* 모달 z-index 조정 */
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    .modal {
        z-index: 1050 !important;
    }
    
    /* 모달 위치 조정 */
    .modal-dialog {
        margin-top: 5rem !important;
    }
    
    /* 모달이 네비게이션 바 아래에 표시되도록 조정 */
    #cardSelectionModal .modal-dialog {
        margin-top: 7rem !important;
    }
    
    /* 카드 선택 모달 스크롤 영역 조정 */
    #cardSelectionModal .modal-body {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
    }

    /* 검색 입력 필드 스타일링 */
    .search-input {
        position: relative;
    }
    
    .search-input i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    
    .search-input input {
        padding-left: 40px;
        border-radius: 20px;
    }
    
    /* 고객 카드 스타일링 */
    .customer-card {
        transition: transform 0.2s;
    }
    
    .customer-card:hover {
        transform: translateY(-5px);
    }
    
    /* 버튼 스타일링 */
    .btn-icon {
        width: 35px;
        height: 35px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .accordion-button:not(.collapsed) {
        background-color: #f8f9fa;
        color: #0d6efd;
    }
    .accordion-button:focus {
        box-shadow: none;
        border-color: rgba(0,0,0,.125);
    }
    .rounded-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .input-group {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .input-group .form-control {
        width: 354.33px;
        height: 38px;
        border-radius: 4px;
        padding: 6px 12px;
    }

    .input-group .btn {
        height: 38px;
        min-width: 60px;
        border-radius: 4px;
        padding: 6px 12px;
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
        font-weight: 400;
    }

    .input-group .btn:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    /* 모던한 점 3개 버튼 스타일 */
    .toggle-accordion {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        background: transparent;
    }
    
    .toggle-accordion:hover {
        background-color: rgba(108, 117, 125, 0.1) !important;
        transform: scale(1.05);
    }
    
    .toggle-accordion:hover i {
        color: #6c757d !important;
    }
    
    .toggle-accordion i {
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    /* 카드 헤더 호버 효과 */
    .customer-card-header:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* 모던한 페이지네이션 스타일 */
    .pagination .page-link {
        border: none;
        color: #6c757d;
        padding: 0.5rem 0.75rem;
        transition: all 0.3s ease;
    }
    
    .pagination .page-link:hover {
        background-color: rgba(108, 117, 125, 0.1);
        color: #495057;
        transform: translateY(-1px);
    }
    
    .pagination .page-item.active .page-link {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #adb5bd;
        background-color: transparent;
    }
    
    /* 모바일 반응형 스타일 */
    @media (max-width: 768px) {
        /* 컨테이너 패딩 조정 */
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* 카드 패딩 조정 */
        .card-body {
            padding: 1rem;
        }
        
        /* 헤더 영역 모바일 최적화 */
        .d-flex.justify-content-between.align-items-center {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch !important;
        }
        
        .d-flex.justify-content-between.align-items-center h2 {
            text-align: center;
            margin-bottom: 0;
        }
        
        /* 신규 고객 등록 버튼 모바일 최적화 */
        #addCustomerBtn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
        }
        
        /* 통계 카드 모바일 최적화 */
        .col-md-3 {
            margin-bottom: 1rem;
        }
        
        .d-flex.align-items-center.p-3.bg-light.rounded {
            padding: 1rem !important;
        }
        
        .rounded-circle {
            width: 35px;
            height: 35px;
            min-width: 35px;
        }
        
        .rounded-circle i {
            font-size: 1rem;
        }
        
        /* 고객 카드 모바일 최적화 */
        .customer-card-header {
            padding: 0.75rem !important;
        }
        
        .customer-card-header .d-flex.align-items-center {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.5rem;
        }
        
        .customer-card-header .d-flex.align-items-center.ms-3 {
            margin-left: 0 !important;
            margin-top: 0.5rem;
            width: 100%;
            justify-content: space-between;
        }
        
        /* 토글 버튼 모바일 최적화 */
        .toggle-accordion {
            width: 28px;
            height: 28px;
        }
        
        .toggle-accordion i {
            font-size: 12px;
        }
        
        /* 아코디언 내용 모바일 최적화 */
        .accordion-body {
            padding: 0.75rem !important;
        }
        
        .accordion-body .row.g-3 {
            margin: 0;
        }
        
        .accordion-body .col-12 {
            padding: 0.5rem 0;
        }
        
        /* 입력 그룹 모바일 최적화 */
        .input-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .input-group .form-control {
            width: 100%;
            height: 40px;
        }
        
        .input-group .btn {
            width: 100%;
            height: 40px;
        }
        
        /* 모달 모바일 최적화 */
        .modal-dialog {
            margin: 1rem !important;
            max-width: calc(100% - 2rem);
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        /* 페이지네이션 모바일 최적화 */
        .pagination {
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .pagination .page-link {
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
        }
        
        /* 검색 입력 필드 모바일 최적화 */
        .search-input input {
            padding-left: 35px;
            height: 40px;
        }
        
        .search-input i {
            left: 12px;
            font-size: 0.875rem;
        }
        
        /* 고객 등록 모달 모바일 최적화 */
        #customerRegistrationModal .modal-dialog {
            margin: 0.5rem !important;
        }
        
        #customerRegistrationModal .modal-body {
            padding: 1rem;
        }
        
        /* 카드 관리 모달 모바일 최적화 */
        #cardManageModal .modal-dialog {
            margin: 0.5rem !important;
        }
        
        #cardManageModal .modal-body {
            padding: 1rem;
        }
        
        /* 리스트 아이템 모바일 최적화 */
        .list-group-item {
            padding: 0.75rem;
        }
        
        /* 버튼 그룹 모바일 최적화 */
        .btn-group {
            width: 100%;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        /* 텍스트 크기 조정 */
        h6 {
            font-size: 0.9rem;
        }
        
        small {
            font-size: 0.8rem;
        }
        
        /* 배지 모바일 최적화 */
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* 아이콘 크기 조정 */
        .fs-4 {
            font-size: 1.25rem !important;
        }
        
        /* 간격 조정 */
        .mb-3 {
            margin-bottom: 0.75rem !important;
        }
        
        .mb-4 {
            margin-bottom: 1rem !important;
        }
        
        .p-3 {
            padding: 0.75rem !important;
        }
        
        .me-3 {
            margin-right: 0.75rem !important;
        }
        
        .ms-3 {
            margin-left: 0.75rem !important;
        }
    }
    
    /* 태블릿 반응형 스타일 */
    @media (min-width: 769px) and (max-width: 1024px) {
        .container {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .customer-card-header .d-flex.align-items-center {
            flex-direction: row;
            align-items: center !important;
        }
        
        .customer-card-header .d-flex.align-items-center.ms-3 {
            margin-left: 0.75rem !important;
            margin-top: 0;
            width: auto;
        }
        
        .input-group {
            flex-direction: row;
        }
        
        .input-group .form-control {
            width: auto;
            flex: 1;
        }
        
        .input-group .btn {
            width: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 주유소 TID 저장 -->
    <input type="hidden" id="station_tid" value="{{ request.user.station_profile.tid }}">
    
    <!-- 고객 관리 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">고객 노트</h2>
                        <button type="button" class="btn btn-primary" id="addCustomerBtn">
                            <i class="fas fa-user-plus me-2"></i>신규 고객 등록
                        </button>
                    </div>
                    
                    <!-- 고객 통계 -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-users text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">전체 고객</h6>
                                    <h3 class="mb-0">{{ total_registered_count|add:total_unregistered_count }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-user-check text-success"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">회원가입 고객</h6>
                                    <h3 class="mb-0">{{ total_registered_count }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-user-clock text-warning"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">미회원가입 고객</h6>
                                    <h3 class="mb-0">{{ total_unregistered_count }}명</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                                    <i class="fas fa-calendar-check text-info"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">이번 달 방문</h6>
                                    <h3 class="mb-0">{{ this_month_visitors }}명</h3>
                                </div>
                            </div>
                        </div>                        
                    </div>

                    <!-- 검색 영역 -->
                    <!-- <div class="mb-4">
                        <div class="position-relative">
                            <i class="fas fa-search text-primary position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%); z-index: 10;"></i>
                            <input type="text" class="form-control ps-5" id="searchInput" 
                                   placeholder="고객 검색 (전화번호 또는 카드번호)" style="height: 45px;">
                        </div>
                    </div> -->

                    <!-- 회원가입한 고객 목록 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-user-check text-success me-2"></i>
                                회원가입 고객 ({{ total_registered_count }}명)
                            </h5>
                            <div class="btn-group" role="group">
                                <button id="show-registered-btn" class="btn btn-sm btn-outline-success" style="display: inline-block;">
                                    <i class="fas fa-eye me-1"></i>보이기
                                </button>
                                <button id="hide-registered-btn" class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-eye-slash me-1"></i>숨기기
                                </button>
                            </div>
                        </div>
                        <div id="registered-customer-section" class="accordion d-none">
                            {% for customer in registered_customers %}
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body p-0">
                                <div class="accordion-item border-0">
                                    <div class="d-flex justify-content-between align-items-center p-3 customer-card-header" 
                                         style="cursor: pointer;" 
                                         data-customer-id="{{ customer.id }}">
                                            <div class="d-flex align-items-center flex-grow-1">
                                                <i class="fas fa-user-check text-success me-3 fs-4"></i>
                                            <div class="flex-grow-1">
                                                    <h6 class="mb-0">ID: {{ customer.customer.username|default:'-' }} </h6>
                                                    <small class="text-muted">                                                         
                                                        카드: {{ customer.card_number|default:'-' }}
                                                    </small>
                                            </div>
                                        </div>
                                            <div class="d-flex align-items-center ms-3 flex-shrink-0">
                                                <span class="badge bg-success me-2">회원가입</span>
                                            <button class="btn btn-link text-decoration-none p-2 toggle-accordion" 
                                                    type="button" 
                                                    data-customer-id="{{ customer.id }}"
                                                    aria-expanded="false"
                                                    style="border-radius: 50%; transition: all 0.2s ease;">
                                                <i class="fas fa-chevron-down text-muted"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="customerCollapse-{{ customer.id }}" class="accordion-collapse collapse">
                                        <div class="accordion-body px-3 pb-3 pt-0">
                                            <div class="border-top pt-3">
                                                <div class="row g-3">
                                                        <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">고객 ID</span>
                                                                <span>{{ customer.customer.username|default:'-' }}</span>
                                                        </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">전화번호</span>
                                                                <span>{{ customer.phone|mask_phone }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="text-muted">최근 방문</span>
                                                            <span>{{ customer.last_visit|default:'-' }}</span>
                                                        </div>
                                                        </div>
                                                    <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="text-muted">총 방문 횟수</span>
                                                            <span>{{ customer.total_visit_count|default:'0' }}회</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="text-muted">총 주유 금액</span>
                                                            <span>{{ customer.total_fuel_amount|default:'0'|floatformat:0 }}원</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 mt-3">
                                                        <div class="btn-group w-100">
                                                            <button class="btn btn-sm btn-outline-primary view-customer-history" data-customer-id="{{ customer.id }}">
                                                                상세보기
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                            {% empty %}
                            <div class="text-center py-4">
                                <i class="fas fa-user-check text-muted fa-3x mb-3"></i>
                                <p class="text-muted mb-0">회원가입한 고객이 없습니다.</p>
                            </div>
                        {% endfor %}
                        </div>
                    </div>

                    <!-- 미회원가입 고객 목록 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-user-clock text-warning me-2"></i>
                                미회원가입 고객 ({{ total_unregistered_count }}명)
                            </h5>
                            <div class="btn-group" role="group">
                                <button id="show-unregistered-btn" class="btn btn-sm btn-outline-warning" style="display: inline-block;">
                                    <i class="fas fa-eye me-1"></i>보이기
                                </button>
                                <button id="hide-unregistered-btn" class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    <i class="fas fa-eye-slash me-1"></i>숨기기
                                </button>
                            </div>
                        </div>
                        <div id="unregistered-customer-section" class="accordion d-none">
                            {% for customer in unregistered_customers %}
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body p-0">
                                    <div class="accordion-item border-0">
                                        <div class="d-flex justify-content-between align-items-center p-3 customer-card-header" 
                                             style="cursor: pointer;" 
                                             data-customer-id="{{ customer.id }}">
                                            <div class="d-flex align-items-center flex-grow-1">
                                                <i class="fas fa-user-clock text-warning me-3 fs-4"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">{{ customer.phone|mask_phone|default:'-' }}</h6>
                                                    <small class="text-muted">카드: {{ customer.card_number|default:'-' }}</small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center ms-3 flex-shrink-0">
                                                <span class="badge bg-warning me-2">미회원가입</span>
                                                <button class="btn btn-link text-decoration-none p-2 toggle-accordion" 
                                                        type="button" 
                                                        data-customer-id="{{ customer.id }}"
                                                        aria-expanded="false"
                                                        style="border-radius: 50%; transition: all 0.2s ease;">
                                                    <i class="fas fa-chevron-down text-muted"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="customerCollapse-{{ customer.id }}" class="accordion-collapse collapse">
                                            <div class="accordion-body px-3 pb-3 pt-0">
                                                <div class="border-top pt-3">
                                                    <div class="row g-3">
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">전화번호</span>
                                                                <span>{{ customer.phone|mask_phone }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">등록일</span>
                                                                <span>{{ customer.created_at|date:"Y-m-d H:i" }}</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <span class="text-muted">상태</span>
                                                                <span class="text-warning">회원가입 대기중</span>
                                                            </div>
                                                        </div>
                                                        <div class="col-12 mt-3">
                                                            <div class="alert alert-info mb-0">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                고객이 회원가입하면 자동으로 연동됩니다.
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-4">
                                <i class="fas fa-user-clock text-muted fa-3x mb-3"></i>
                                <p class="text-muted mb-0">미회원가입 고객이 없습니다.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- 페이지네이션 (회원가입 고객만) -->
                    {% if total_pages > 1 %}
                    <nav aria-label="Page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if current_page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ current_page|add:'-1' }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in page_range %}
                            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                            </li>
                            {% endfor %}
                            
                            {% if current_page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ current_page|add:'1' }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 고객 등록 모달 -->
<div class="modal fade" id="customerRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>폰번호-카드 연동 등록
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerRegistrationForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <!-- 전화번호 입력 그룹 -->
                    <div class="mb-4">
                        <label class="h6 mb-3">전화번호</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="bg-light rounded p-2" style="width: 45px; height: 45px;">
                                <i class="fas fa-phone"></i>
                            </div>
                            <input type="tel" class="form-control flex-grow-1" id="phone" name="phone" 
                                   style="height: 45px;"
                                   pattern="[0-9]{10,11}" placeholder="전화번호 (숫자만 입력)" required>
                            <button class="btn btn-primary" type="button" id="checkPhoneBtn" 
                                   style="width: 80px; height: 45px; margin-top: -5px;">
                                    조회
                                </button>
                        </div>
                        <div class="form-text text-muted mt-2">
                            <i class="fas fa-info-circle me-1"></i>숫자만 입력해주세요 (예: 01012345678)
                        </div>
                        <div id="phoneCheckResult" class="mt-2" style="display: none;">
                            <!-- 조회 결과가 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <!-- 멤버십 카드 입력 그룹 -->
                    <div class="mb-4">
                        <label class="h6 mb-3">멤버십 카드</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="bg-light rounded p-2" style="width: 45px; height: 45px;">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <input type="text" class="form-control flex-grow-1" id="card_number" name="card_number" 
                                   style="height: 45px;"
                                   pattern="[0-9]{16}" placeholder="카드번호 선택" readonly required>
                            <button class="btn btn-primary" type="button" data-bs-target="#cardManageModal" data-bs-toggle="modal"
                                   style="width: 80px; height: 45px; margin-top: -5px;">
                                선택
                            </button>
                        </div>
                        <div class="form-text text-muted mt-2">
                            <i class="fas fa-info-circle me-1"></i>카드 선택 버튼을 클릭하여 사용 가능한 카드를 선택해주세요
                        </div>
                    </div>

                    <!-- 고객 그룹 선택 (비활성화) -->
                    <!-- 
                    <div class="mb-4">
                        <label class="h6 mb-3">고객 그룹</label>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="bg-light rounded p-2" style="width: 45px; height: 45px;">
                                <i class="fas fa-users"></i>
                            </div>
                            <select class="form-control flex-grow-1" id="customer_group" name="group" style="height: 45px;">
                                <option value="">그룹 선택 (선택사항)</option>-->
                                <!-- 그룹 옵션들이 여기에 동적으로 로드됩니다 -->
                            <!-- </select>
                        </div>
                        <div class="form-text text-muted mt-2">
                            <i class="fas fa-info-circle me-1"></i>고객을 분류하기 위한 그룹을 선택해주세요
                        </div>
                    </div>
                    -->

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i>폰번호-카드 연동 등록
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 고객 상세 정보 모달 -->
<div class="modal fade" id="customerDetailModal" tabindex="-1" aria-labelledby="customerDetailModalLabel">
    <div class="modal-dialog modal-lg" style="margin-top: 10rem;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerDetailModalLabel">
                    <i class="fas fa-user me-2"></i>고객 상세 정보
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-user me-2"></i>기본 정보
                                </h6>
                                <div class="mb-2">
                                    <strong>이름:</strong> <span id="detailName">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>전화번호:</strong> <span id="detailPhone">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>포인트카드:</strong> <span id="detailCard" class="font-monospace">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>가입일:</strong> <span id="detailJoinDate">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light border-0 h-100">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-chart-line me-2"></i>이용 통계
                                </h6>
                                <div class="mb-2">
                                    <strong>총 방문횟수:</strong> <span id="detailVisitCount">0회</span>
                                </div>
                                <div class="mb-2">
                                    <strong>전월 주유금액:</strong> <span id="detailLastMonthAmount">0원</span>
                                </div>
                                <div class="mb-2">
                                    <strong>금월 주유금액:</strong> <span id="detailThisMonthAmount">0원</span>
                                </div>
                                <div class="mb-2">
                                    <strong>최근 방문일:</strong> <span id="detailLastVisit">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 멤버십 카드 관리 모달 -->
<div class="modal fade" id="cardManageModal" tabindex="-1" aria-labelledby="cardManageModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardManageModalLabel">
                    <i class="fas fa-credit-card me-2"></i>멤버십 카드 관리
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <!-- 카드번호 조회 영역 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-search me-2"></i>카드번호 조회
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="search-card-number" class="form-label">카드번호</label>
                                <input type="text" 
                                       id="search-card-number" 
                                       class="form-control" 
                                       placeholder="뒷자리 4자리 입력" 
                                       maxlength="16">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" id="search-card-btn" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-search me-1"></i>조회
                                </button>
                            </div>
                        </div>
                        <div id="search-card-result" class="mt-3" style="display: none;"></div>
                        <div id="search-card-suggestions" class="mt-3" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-list me-2"></i>검색 결과
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <ul id="card-suggestions-list" class="list-group list-group-flush">
                                        <!-- 실시간 검색 결과가 여기에 표시됩니다 -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 미사용 카드 목록 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>미사용 카드 목록
                        </h5>
                        <div class="btn-group" role="group">
                            <button id="refresh-cards-btn" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-sync-alt me-1"></i>카드 목록 불러오기
                            </button>
                            <button id="close-cards-btn" class="btn btn-sm btn-outline-secondary" style="display: none;">
                                <i class="fas fa-eye-slash me-1"></i>목록 닫기
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <ul id="unusedCardsList" class="list-group">
                            <!-- 카드 목록이 여기에 동적으로 추가됩니다 -->
                        </ul>
                    </div>
                </div>

                <!-- 멤버십 카드 등록 폼 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>멤버십 카드 등록
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="card-registration-form">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="card-number" class="form-label">카드번호</label>
                                <input type="text" 
                                       id="card-number" 
                                       class="form-control" 
                                       placeholder="미등록 멤버십 카드 번호 입력(16자리)" 
                                       maxlength="16" 
                                       required>
                            </div>
                            <input type="hidden" id="card_station_tid" value="{{ request.user.station_profile.tid }}">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus-circle me-1"></i>카드 등록
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 방문 이력 리스트 모달 추가 -->
<div class="modal fade" id="customerHistoryModal" tabindex="-1" aria-labelledby="customerHistoryModalLabel">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerHistoryModalLabel">
          <i class="fas fa-list me-2"></i>고객 방문 이력
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body">
        <div id="customerHistoryContent">
          <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>데이터를 불러오는 중...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// 전역 변수로 이벤트 리스너 등록 상태 관리
let isEventListenerRegistered = false;

// DOM이 로드되면 실행
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    // CSRF 토큰 설정
    window.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    // TID 설정 확인
    const mainStationTid = document.getElementById('station_tid')?.value;
    const cardStationTid = document.getElementById('card_station_tid')?.value;
    console.log('[DEBUG] 메인 TID:', mainStationTid);
    console.log('[DEBUG] 카드 등록 TID:', cardStationTid);
    
    // TID가 설정되지 않은 경우 경고 표시
    if (!mainStationTid || !cardStationTid) {
        console.log('[WARNING] 주유소 TID가 설정되지 않음');
        const warningDiv = document.createElement('div');
        warningDiv.className = 'alert alert-warning alert-dismissible fade show';
        warningDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>주의:</strong> 주유소 단말기 번호(TID)가 설정되지 않았습니다. 
            카드 등록 및 고객 등록 기능을 사용하려면 관리자에게 문의하세요.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(warningDiv, document.querySelector('.container').firstChild);
    }
    
    // 이벤트 리스너가 이미 등록되어 있다면 중복 등록 방지
    if (window.isEventListenerRegistered) {
        console.log('Event listeners already registered, skipping...');
        return;
    }
    
    // 고객 등록 모달 이벤트 설정
    const registrationModal = document.getElementById('customerRegistrationModal');
    if (registrationModal) {
        // 모달이 열릴 때 초기화
        registrationModal.addEventListener('show.bs.modal', function() {
            console.log('[DEBUG] 고객 등록 모달 열기');
            // 카드 선택에서 돌아온 경우가 아닐 때만 초기화
            const cardModal = document.getElementById('cardManageModal');
            const isFromCardSelection = cardModal && cardModal.classList.contains('show');
            
            console.log('[DEBUG] 카드 선택에서 돌아옴:', isFromCardSelection);
            
            if (!isFromCardSelection) {
                console.log('[DEBUG] 폼 초기화 실행');
                const form = this.querySelector('#customerRegistrationForm');
                const phoneCheckResult = this.querySelector('#phoneCheckResult');
                if (form) form.reset();
                if (phoneCheckResult) phoneCheckResult.style.display = 'none';
            } else {
                console.log('[DEBUG] 카드 선택에서 돌아온 경우 폼 초기화 건너뜀');
            }
            
            // 그룹 목록 로드
            // loadGroupsForCustomer();
        });

        // 모달이 닫힐 때 정리
        registrationModal.addEventListener('hidden.bs.modal', function() {
            console.log('[DEBUG] 고객 등록 모달 닫기');
            // 카드 선택 모달로 이동하는 경우가 아닐 때만 초기화
            const cardModal = document.getElementById('cardManageModal');
            const isGoingToCardSelection = cardModal && cardModal.classList.contains('show');
            
            console.log('[DEBUG] 카드 선택으로 이동:', isGoingToCardSelection);
            
            if (!isGoingToCardSelection) {
                console.log('[DEBUG] 폼 완전 초기화 실행');
                const form = this.querySelector('#customerRegistrationForm');
                const phoneCheckResult = this.querySelector('#phoneCheckResult');
                if (form) {
                    form.reset();
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-user-plus me-1"></i>고객 등록';
                    }
                }
                if (phoneCheckResult) phoneCheckResult.style.display = 'none';
            } else {
                console.log('[DEBUG] 카드 선택으로 이동하는 경우 폼 초기화 건너뜀');
            }
            
            // backdrop 제거
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('padding-right');
        });
    }

    // 카드 관리 모달 이벤트 설정
    const cardManageModal = document.getElementById('cardManageModal');
    if (cardManageModal) {
        // 모달이 열릴 때 초기화
        cardManageModal.addEventListener('show.bs.modal', function() {
            console.log('Card manage modal opening');
            const cardsList = this.querySelector('#unusedCardsList');
            if (cardsList) {
                cardsList.innerHTML = `
                    <li class="list-group-item text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>카드 목록 불러오기를 하여 목록에서 선택할 수 있습니다.
                    </li>
                `;
            }
            // 자동 카드 목록 로드 제거 (새로고침 버튼을 통해서만 로드)
        });

        // 모달이 닫힐 때 정리
        cardManageModal.addEventListener('hidden.bs.modal', function() {
            console.log('Card manage modal closing');
            // 고객 등록 모달이 열려있는 경우에는 카드 목록을 초기화하지 않음
            const registerModal = document.getElementById('customerRegistrationModal');
            if (!registerModal.classList.contains('show')) {
                const cardsList = this.querySelector('#unusedCardsList');
                if (cardsList) {
                    cardsList.innerHTML = `
                    <li class="list-group-item text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>새로고침 버튼을 눌러 카드 목록을 불러오세요
                        </li>
                    `;
                }
            }
        });
    }
    
    // 고객 등록 폼 제출 이벤트 리스너 설정
    const customerRegistrationForm = document.getElementById('customerRegistrationForm');
    if (customerRegistrationForm) {
        customerRegistrationForm.removeEventListener('submit', registerCustomer);  // 기존 리스너 제거
        customerRegistrationForm.addEventListener('submit', registerCustomer);
    }
    
    // 멤버십 카드 선택 버튼 이벤트 리스너 설정
    const cardSelectionBtn = document.querySelector('[data-bs-target="#cardManageModal"]');
    if (cardSelectionBtn) {
        cardSelectionBtn.removeEventListener('click', openCardSelectionModal);  // 기존 리스너 제거
        cardSelectionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const cardModal = new bootstrap.Modal(document.getElementById('cardManageModal'));
            cardModal.show();
        });
    }
    
    // 전화번호 입력 필드 실시간 검증
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            // 숫자만 입력 허용
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // 11자리 제한
            if (this.value.length > 11) {
                this.value = this.value.slice(0, 11);
            }
            
            // 실시간 유효성 검사
            const cleanPhone = this.value.replace(/[\s\-]/g, '');
            const phoneCheckResult = document.getElementById('phoneCheckResult');
            
            if (cleanPhone.length === 0) {
                phoneCheckResult.style.display = 'none';
            } else if (cleanPhone.length < 11) {
                phoneCheckResult.style.display = 'block';
                phoneCheckResult.innerHTML = '<span class="text-warning"><i class="fas fa-info-circle me-1"></i>전화번호를 11자리로 입력해주세요.</span>';
            } else if (!cleanPhone.startsWith('010')) {
                phoneCheckResult.style.display = 'block';
                phoneCheckResult.innerHTML = '<span class="text-warning"><i class="fas fa-info-circle me-1"></i>휴대폰 번호는 010으로 시작해야 합니다.</span>';
            } else {
                phoneCheckResult.style.display = 'block';
                phoneCheckResult.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>올바른 전화번호 형식입니다.</span>';
            }
        });
    }
    
    // 전화번호 조회 버튼 이벤트 리스너 설정
    const phoneCheckBtn = document.getElementById('checkPhoneBtn');
    if (phoneCheckBtn) {
        phoneCheckBtn.removeEventListener('click', () => checkDuplicate('phone'));  // 기존 리스너 제거
        phoneCheckBtn.addEventListener('click', () => checkDuplicate('phone'));
    }
    
    // 카드번호 입력 필드 실시간 검증
    const cardNumberInput = document.getElementById('card-number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function() {
            // 숫자만 입력 허용
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // 16자리 제한
            if (this.value.length > 16) {
                this.value = this.value.slice(0, 16);
            }
            
            console.log('[DEBUG] 카드번호 입력:', this.value);
        });
    }
    
    // 카드 등록 폼 제출 이벤트 리스너 설정
    const cardRegistrationForm = document.getElementById('card-registration-form');
    if (cardRegistrationForm) {
        console.log('[DEBUG] 카드 등록 폼 찾음');
        // 기존 리스너 제거 후 새로 등록
        cardRegistrationForm.removeEventListener('submit', registerCard);
        cardRegistrationForm.addEventListener('submit', registerCard);
    } else {
        console.error('[ERROR] 카드 등록 폼을 찾을 수 없음');
    }
    
    // 실시간 검색 이벤트 리스너 설정
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.removeEventListener('input', e => performSearch(e.target.value));  // 기존 리스너 제거
        searchInput.addEventListener('input', e => performSearch(e.target.value));
    }
    
    // 이벤트 리스너 등록 완료 표시
    window.isEventListenerRegistered = true;
    console.log('Event listeners registered successfully');
});

// 고객 상세 정보 보기
function viewCustomerDetail(customerId) {
    // 여기서 고객 상세 정보를 불러와서 모달에 표시
    const modal = new bootstrap.Modal(document.getElementById('customerDetailModal'));
    modal.show();
}

// 멤버십 카드 관리 모달 열기
let isCardModalOpen = false;  // 모달 상태 추적
function openCardSelectionModal() {
    console.log('Opening card selection modal');
    
    // 이미 모달이 열려있으면 중복 호출 방지
    if (isCardModalOpen) {
        console.log('Modal is already open, skipping fetch');
        return;
    }
    
    isCardModalOpen = true;  // 모달 상태 업데이트
    
    // 모달 표시 (카드목록은 새로고침 버튼을 눌렀을 때만 가져옴)
        const modalElement = document.getElementById('cardManageModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    
    // 카드목록 초기화 (빈 상태로 시작)
        const cardList = document.getElementById('unusedCardsList');
        cardList.innerHTML = `
        <li class="list-group-item text-center text-muted">
            <i class="fas fa-info-circle me-2"></i>새로고침 버튼을 눌러 카드 목록을 불러오세요
            </li>
        `;
}

// 멤버십 카드 선택 처리
function selectCard(cardNumber, tid) {
    console.log('[DEBUG] 카드 선택 시작');
    console.log('[DEBUG] 선택된 카드번호:', cardNumber);
    console.log('[DEBUG] 선택된 TID:', tid);
    
    // 현재 전화번호 값과 조회 결과 저장
    const phoneInput = document.getElementById('phone');
    const phoneCheckResult = document.getElementById('phoneCheckResult');
    const savedPhone = phoneInput ? phoneInput.value : '';
    const savedCheckResult = phoneCheckResult ? phoneCheckResult.innerHTML : '';
    
    console.log('[DEBUG] 저장된 전화번호:', savedPhone);
    console.log('[DEBUG] 저장된 조회 결과:', savedCheckResult);
    
    // 카드번호 입력
    const cardInput = document.getElementById('card_number');
    if (cardInput) {
        cardInput.value = cardNumber;
        console.log('[DEBUG] 카드번호 입력 완료:', cardNumber);
    }
    
    // 카드 관리 모달 닫기
    const cardModal = bootstrap.Modal.getInstance(document.getElementById('cardManageModal'));
    if (cardModal) {
        cardModal.hide();
        console.log('[DEBUG] 카드 관리 모달 닫기 완료');
    }
    
    // 고객 등록 모달 처리
    const registerModal = document.getElementById('customerRegistrationModal');
    if (!registerModal.classList.contains('show')) {
        console.log('[DEBUG] 고객 등록 모달 새로 열기');
        const modal = new bootstrap.Modal(registerModal);
        modal.show();
    }
    
    // 전화번호와 조회 결과 복원
    setTimeout(() => {
        console.log('[DEBUG] 전화번호와 조회 결과 복원 시작');
        const phoneInput = document.getElementById('phone');
        const phoneCheckResult = document.getElementById('phoneCheckResult');
        const cardInput = document.getElementById('card_number');
        
        if (phoneInput && savedPhone) {
            phoneInput.value = savedPhone;
            console.log('[DEBUG] 전화번호 복원 완료:', savedPhone);
        }
        
        if (phoneCheckResult && savedCheckResult) {
            phoneCheckResult.style.display = 'block';
            phoneCheckResult.innerHTML = savedCheckResult;
            console.log('[DEBUG] 조회 결과 복원 완료');
        }
        
        if (cardInput) {
            cardInput.value = cardNumber;
            console.log('[DEBUG] 카드번호 복원 완료:', cardNumber);
        }
    }, 100);
    
    console.log('[DEBUG] 카드 선택 프로세스 완료');
}

// 중복 체크 함수
async function checkDuplicate(type) {
    const phone = document.getElementById('phone').value;
    const cardNumber = document.getElementById('card_number').value;
    const csrftoken = window.csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    // 전화번호 체크만 수행
    if (type === 'phone') {
        // 전화번호 정리 (공백, 하이픈 제거)
        const cleanPhone = phone.replace(/[\s\-]/g, '');
        
        // 전화번호 유효성 검사
        if (!cleanPhone) {
            document.getElementById('phoneCheckResult').innerHTML = 
                '<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>전화번호를 입력해주세요.</span>';
            return;
        }
        
        // 숫자만 있는지 확인
        if (!/^\d+$/.test(cleanPhone)) {
            document.getElementById('phoneCheckResult').innerHTML = 
                '<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>전화번호는 숫자만 입력해주세요.</span>';
            return;
        }
        
        // 11자리인지 확인
        if (cleanPhone.length !== 11) {
            document.getElementById('phoneCheckResult').innerHTML = 
                '<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>전화번호는 11자리로 입력해주세요.</span>';
            return;
        }
        
        // 010으로 시작하는지 확인
        if (!cleanPhone.startsWith('010')) {
            document.getElementById('phoneCheckResult').innerHTML = 
                '<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>올바른 휴대폰 번호 형식이 아닙니다. (010으로 시작)</span>';
            return;
        }

        // 요청 데이터 준비
        const requestData = {
            phone: phone
        };

        // 헤더 준비
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // CSRF 토큰이 있으면 추가
        if (csrftoken) {
            headers['X-CSRFToken'] = csrftoken;
        }

        try {
            // 먼저 고객 존재 여부 확인
            const customerResponse = await fetch('{% url "station:check_customer" %}', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestData)
            });

            const customerData = await customerResponse.json();
            
            // 폰번호-카드 연동 정보 확인
            const mappingResponse = await fetch(`{% url "station:check_phone_mapping" %}?phone=${cleanPhone}`, {
                method: 'GET',
                headers: headers
            });

            const mappingData = await mappingResponse.json();
            
            let resultHtml = '';
            
            // 고객 정보 결과
            if (customerData.status === 'error') {
                resultHtml += `
                    <div class="alert alert-danger mb-2">
                        <i class="fas fa-exclamation-circle me-2"></i>${customerData.message}
                    </div>
                `;
                // 이미 등록된 고객인 경우 입력 필드 비활성화
                if (customerData.exists && customerData.data && customerData.data.is_registered_here) {
                    document.getElementById('card_number').disabled = true;
                    document.querySelector('button[type="submit"]').disabled = true;
                }
            } else {
                if (customerData.exists) {
                    // 기존 고객 발견
                    const customerInfo = customerData.data;
                    if (customerInfo.is_registered_here) {
                        // 이미 이 주유소에 등록된 고객
                    resultHtml += `
                        <div class="alert alert-warning mb-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>${customerData.message}
                        </div>
                    `;
                        document.getElementById('card_number').disabled = true;
                        document.querySelector('button[type="submit"]').disabled = true;
                    } else {
                        // 기존 고객이지만 이 주유소에는 등록되지 않음
                        resultHtml += `
                            <div class="alert alert-info mb-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>기존 고객 발견:</strong> ${customerInfo.username}<br>
                                <small class="text-muted">카드 등록 시 자동으로 연동됩니다.</small>
                            </div>
                        `;
                    document.getElementById('card_number').disabled = false;
                    document.querySelector('button[type="submit"]').disabled = false;
                    }
                } else {
                    // 신규 고객
                    resultHtml += `
                        <div class="alert alert-success mb-2">
                            <i class="fas fa-check-circle me-2"></i>${customerData.message}
                        </div>
                    `;
                    document.getElementById('card_number').disabled = false;
                    document.querySelector('button[type="submit"]').disabled = false;
                }
            }
            
            // 폰번호-카드 연동 정보 결과
            if (mappingData.status === 'success' && mappingData.exists) {
                const mapping = mappingData.data;
                if (mapping.is_used) {
                    resultHtml += `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>연동된 멤버십카드:</strong> ${mapping.card_number}<br>
                            <small class="text-muted">이미 고객과 연동되어 있습니다. (연동일: ${mapping.created_at})</small>
                        </div>
                    `;
                } else {
                    resultHtml += `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>등록된 멤버십카드:</strong> ${mapping.card_number}<br>
                            <small class="text-muted">고객이 회원가입하면 자동으로 연동됩니다. (등록일: ${mapping.created_at})</small>
                        </div>
                    `;
                }
            }
            
            document.getElementById('phoneCheckResult').innerHTML = resultHtml;
            
        } catch (error) {
            console.error('Error:', error);
            showToast('error', '전화번호 조회 중 오류가 발생했습니다.');
        }
    }
}

// 그룹 목록 로드 (고객 등록용) - 비활성화
/*
function loadGroupsForCustomer() {
    console.log('[DEBUG] 고객 등록용 그룹 목록 로드 시작');
    
    fetch('/station/get-groups/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const groupSelect = document.getElementById('customer_group');
            if (groupSelect) {
                // 기존 옵션 제거 (첫 번째 옵션 제외)
                while (groupSelect.children.length > 1) {
                    groupSelect.removeChild(groupSelect.lastChild);
                }
                
                // 새 그룹 옵션 추가
                data.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.name;
                    option.textContent = group.name;
                    groupSelect.appendChild(option);
                });
                
                console.log('[DEBUG] 그룹 목록 로드 완료:', data.groups.length, '개');
            }
        } else {
            console.error('그룹 목록 로드 실패:', data.message);
        }
    })
    .catch(error => {
        console.error('그룹 목록 로드 중 오류:', error);
    });
}
*/

// 고객 등록 함수
function registerCustomer(e) {
    e.preventDefault();
    
    // 폼 제출 버튼 찾기
    const submitButton = document.querySelector('#customerRegistrationForm button[type="submit"]');
    
    // 버튼이 이미 비활성화되어 있다면 중복 제출 방지
    if (submitButton.disabled) {
        console.log('[DEBUG] 폼 제출 차단 - 이미 처리 중');
        return;
    }
    
    // 버튼 비활성화 및 로딩 상태 표시
    submitButton.disabled = true;
    const originalButtonText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>처리중...';
    
    const phone = document.getElementById('phone').value;
    const cardNumber = document.getElementById('card_number').value;
    // const group = document.getElementById('customer_group').value; // 그룹 기능 비활성화
    
    // 로깅 추가
    console.log('[DEBUG] 고객 등록 시도');
    console.log('[DEBUG] 전화번호:', phone);
    console.log('[DEBUG] 카드번호:', cardNumber);
    // console.log('[DEBUG] 그룹:', group); // 그룹 기능 비활성화
    
    // 전화번호 유효성 검사
    const cleanPhone = phone.replace(/[\s\-]/g, '');
    
    if (!cleanPhone) {
        console.log('[ERROR] 전화번호가 입력되지 않음');
        showToast('error', '전화번호를 입력해주세요.');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
    }
    
    // 숫자만 있는지 확인
    if (!/^\d+$/.test(cleanPhone)) {
        console.log('[ERROR] 전화번호에 숫자 외 문자가 포함됨');
        showToast('error', '전화번호는 숫자만 입력해주세요.');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
    }
    
    // 11자리인지 확인
    if (cleanPhone.length !== 11) {
        console.log('[ERROR] 전화번호가 11자리가 아님');
        showToast('error', '전화번호는 11자리로 입력해주세요.');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
    }
    
    // 010으로 시작하는지 확인
    if (!cleanPhone.startsWith('010')) {
        console.log('[ERROR] 전화번호가 010으로 시작하지 않음');
        showToast('error', '올바른 휴대폰 번호 형식이 아닙니다. (010으로 시작)');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
    }
    
    // 카드번호 유효성 검사
    if (!cardNumber || cardNumber.trim() === '') {
        console.log('[ERROR] 카드번호가 선택되지 않음');
        showToast('error', '카드번호를 선택해주세요.');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
        return;
    }
    
    const data = {
        phone: cleanPhone,
        card_number: cardNumber
        // group: group // 그룹 기능 비활성화
    };
    
    console.log('[DEBUG] 서버로 전송할 데이터:', data);
    
    fetch('/station/register-customer/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('[DEBUG] 서버 응답 상태:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('[DEBUG] 서버 응답 데이터:', data);
        if (data.status === 'success') {
            // 성공 메시지 표시
            showToast('success', data.message);
            
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('customerRegistrationModal'));
            if (modal) {
                modal.hide();
            }
            
            // 입력 필드 초기화
            document.getElementById('phone').value = '';
            document.getElementById('card_number').value = '';
            document.getElementById('phoneCheckResult').innerHTML = '';
            document.getElementById('phoneCheckResult').style.display = 'none';
            
            // 페이지 새로고침
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            console.log('[ERROR] 고객 등록 실패:', data.message);
            showToast('error', data.message || '고객 등록 중 오류가 발생했습니다.');
            // 버튼 상태 복구
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    })
    .catch(error => {
        console.error('[ERROR] 고객 등록 중 오류:', error);
        showToast('error', '등록 중 오류가 발생했습니다: ' + error.message);
        // 버튼 상태 복구
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
    });
}

function adjustGridLayout() {
    // 모든 고객 카드 요소 선택
    const cards = document.querySelectorAll('.customer-card');
    
    // 각 카드의 위치와 크기를 재계산
    cards.forEach(card => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    });
}

function showToast(type, message) {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        // 토스트 컨테이너가 없으면 생성
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.position = 'fixed';
        container.style.top = '1rem';
        container.style.right = '1rem';
        container.style.zIndex = '1060';
        document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // 토스트가 숨겨진 후 요소 제거
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function addNewCustomerToList(customer) {
    const customerList = document.querySelector('.row.g-3');
    const emptyMessage = customerList.querySelector('.empty-state')?.closest('.col-12');
    
    // 빈 상태 메시지가 있으면 제거
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // 새 고객 카드 HTML 생성
    const newCustomerCard = document.createElement('div');
    newCustomerCard.className = 'col-md-6 col-lg-4 customer-card';
    newCustomerCard.setAttribute('data-customer-id', customer.id);
    newCustomerCard.style.opacity = '0';
    newCustomerCard.style.transform = 'translateY(-20px)';
    newCustomerCard.style.transition = 'all 0.3s ease-out';
    
    newCustomerCard.innerHTML = `
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-4">
                <h6 class="card-title mb-2 customer-name">${customer.name || '고객'}</h6>
                <p class="card-text text-muted mb-2">${customer.phone}</p>
                <p class="card-text text-muted mb-3">${customer.card_number}</p>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary edit-customer" data-customer-id="${customer.id}">
                        수정
                    </button>
                    <!-- 삭제 버튼 제거됨 -->
                </div>
            </div>
        </div>
    `;
    
    // 새 카드를 목록의 맨 앞에 추가
    if (customerList.firstChild) {
        customerList.insertBefore(newCustomerCard, customerList.firstChild);
    } else {
        customerList.appendChild(newCustomerCard);
    }
    
    // 애니메이션 효과 적용
    requestAnimationFrame(() => {
        newCustomerCard.style.opacity = '1';
        newCustomerCard.style.transform = 'translateY(0)';
    });
    
    // 이벤트 리스너 추가
    const editBtn = newCustomerCard.querySelector('.edit-customer');
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            editCustomer(customer.id);
        });
    }
}

// 실시간 검색 함수
function performSearch(searchTerm) {
    const customerCards = document.querySelectorAll('.customer-card');
    const searchTermLower = searchTerm.toLowerCase().trim();
    
    customerCards.forEach(card => {
        const customerName = card.querySelector('.customer-name')?.textContent.toLowerCase() || '';
        const customerPhone = card.querySelector('.customer-phone')?.textContent.toLowerCase() || '';
        const customerCard = card.querySelector('.customer-card-number')?.textContent.toLowerCase() || '';
        
        // 검색어가 이름, 전화번호, 또는 카드번호에 포함되는지 확인
        const isMatch = searchTermLower === '' || 
                       customerName.includes(searchTermLower) ||
                       customerPhone.includes(searchTermLower) ||
                       customerCard.includes(searchTermLower);
        
        // 카드 표시/숨김
        if (isMatch) {
            card.style.display = 'block';
            card.classList.remove('d-none');
        } else {
            card.style.display = 'none';
            card.classList.add('d-none');
        }
    });
    
    // 검색 결과가 없을 때 메시지 표시
    const visibleCards = document.querySelectorAll('.customer-card:not(.d-none)');
    let noResultsMessage = document.getElementById('noSearchResults');
    
    if (visibleCards.length === 0 && searchTermLower !== '') {
        if (!noResultsMessage) {
            noResultsMessage = document.createElement('div');
            noResultsMessage.id = 'noSearchResults';
            noResultsMessage.className = 'col-12 text-center py-5';
            noResultsMessage.innerHTML = `
                <div class="text-muted">
                    <i class="fas fa-search fa-3x mb-3 text-light"></i>
                    <p class="mb-0">검색 결과가 없습니다.</p>
                    <small>다른 검색어를 시도해보세요.</small>
                </div>
            `;
            document.querySelector('.row.g-3').appendChild(noResultsMessage);
        }
        noResultsMessage.style.display = 'block';
    } else {
        if (noResultsMessage) {
            noResultsMessage.style.display = 'none';
        }
    }
}

// 고객 삭제 기능 비활성화됨

function showEmptyState() {
    const customerList = document.querySelector('.row.g-3');
    const existingEmptyState = customerList.querySelector('.empty-state');
    
    if (!existingEmptyState) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'col-12 text-center py-5';
        emptyMessage.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">등록된 고객이 없습니다</h5>
                <p class="text-muted mb-0">새로운 고객을 등록해주세요</p>
            </div>
        `;
        customerList.appendChild(emptyMessage);
    }
}

// 페이지 로드 시 초기 상태 설정
document.addEventListener('DOMContentLoaded', function() {
    // 이벤트 리스너가 이미 등록되어 있다면 중복 등록 방지
    if (window.isEventListenerRegistered) {
        return;
    }

    const customerList = document.querySelector('.row.g-3');
    const customerCards = customerList.querySelectorAll('.customer-card');
    
    // 기존 고객 카드들에 대한 이벤트 리스너 등록
    customerCards.forEach(card => {
        const editBtn = card.querySelector('.edit-customer');
        
        if (editBtn) {
            const customerId = card.dataset.customerId;
            editBtn.addEventListener('click', () => editCustomer(customerId));
        }
    });
    
    // 빈 상태 체크
    if (customerCards.length === 0) {
        showEmptyState();
    }
    
    window.isEventListenerRegistered = true;
});

// 미사용 카드 목록 로드
function loadUnusedCards() {
    fetch('{% url "station:get_unused_cards" %}')
        .then(response => {
            if (!response.ok) {
                throw new Error('서버 응답 오류');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const cardList = document.getElementById('unusedCardsList');
                cardList.innerHTML = ''; // 기존 목록 초기화
                
                if (data.cards.length === 0) {
                    cardList.innerHTML = '<li class="list-group-item text-center">등록된 미사용 카드가 없습니다</li>';
                } else {
                    data.cards.forEach(card => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <div class="d-flex align-items-center">
                                    <span class="card-number font-monospace">${card.number}</span>
                                    ${card.tid ? `<span class="badge bg-info ms-2">TID: ${card.tid}</span>` : ''}
                                </div>
                                <small class="text-muted">${card.created_at}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectCard('${card.number}', '${card.tid || ''}')">
                                <i class="fas fa-check me-1"></i>선택
                            </button>
                        `;
                        cardList.appendChild(li);
                    });
                }
            } else {
                console.error('카드 목록 조회 실패:', data.message);
                alert('카드 목록을 불러오는데 실패했습니다: ' + data.message);
            }
        })
        .catch(error => {
            console.error('카드 목록 조회 중 오류:', error);
            alert('카드 목록을 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.');
        });
}

// 멤버십 카드 등록 폼 제출 처리
function registerCard(event) {
    event.preventDefault();
    
    console.log('[DEBUG] 카드 등록 함수 호출됨');
    
    // 폼 제출 버튼 찾기
    const submitButton = event.target.querySelector('button[type="submit"]');
    
    // 버튼이 이미 비활성화되어 있다면 중복 제출 방지
    if (submitButton && submitButton.disabled) {
        console.log('[DEBUG] 카드 등록 차단 - 이미 처리 중');
        return;
    }
    
    // 버튼 비활성화 및 로딩 상태 표시
    if (submitButton) {
        submitButton.disabled = true;
        const originalButtonText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>등록 중...';
        
        // 5초 후 버튼 복원 (타임아웃 방지)
        setTimeout(() => {
            if (submitButton.disabled) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
                console.log('[DEBUG] 카드 등록 버튼 타임아웃 복원');
            }
        }, 5000);
    }
    
    // 카드번호 입력 필드 찾기
    const cardNumberInput = document.getElementById('card-number');
    console.log('[DEBUG] 카드번호 입력 필드:', cardNumberInput);
    
    if (!cardNumberInput) {
        console.error('[ERROR] 카드번호 입력 필드를 찾을 수 없음');
        alert('카드번호 입력 필드를 찾을 수 없습니다.');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-plus-circle me-1"></i>카드 등록';
        }
        return;
    }
    
    const cardNumber = cardNumberInput.value.trim();
    console.log('[DEBUG] 입력된 카드번호 (trim 전):', cardNumberInput.value);
    console.log('[DEBUG] 입력된 카드번호 (trim 후):', cardNumber);
    
    // TID 필드 찾기
    const stationTidInput = document.getElementById('card_station_tid');
    console.log('[DEBUG] TID 입력 필드:', stationTidInput);
    
    if (!stationTidInput) {
        console.error('[ERROR] TID 입력 필드를 찾을 수 없음');
        alert('주유소 TID 필드를 찾을 수 없습니다.');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-plus-circle me-1"></i>카드 등록';
        }
        return;
    }
    
    const stationTid = stationTidInput.value.trim();
    console.log('[DEBUG] 입력된 TID (trim 전):', stationTidInput.value);
    console.log('[DEBUG] 입력된 TID (trim 후):', stationTid);
    
    if (!cardNumber) {
        console.log('[ERROR] 카드번호가 입력되지 않음');
        alert('카드번호를 입력해주세요.');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-plus-circle me-1"></i>카드 등록';
        }
        return;
    }
    
    console.log('[DEBUG] 카드 등록 시도');
    console.log('[DEBUG] 카드번호:', cardNumber);
    console.log('[DEBUG] 주유소 TID:', stationTid);
    
    if (!stationTid) {
        console.log('[ERROR] 주유소 TID가 설정되지 않음');
        alert('주유소 단말기 번호(TID)가 설정되지 않았습니다. 관리자에게 문의하세요.');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-plus-circle me-1"></i>카드 등록';
        }
        return;
    }
    
    // CSRF 토큰 가져오기
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // 카드 등록 요청
    fetch('{% url "station:register_card" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            card_number: cardNumber,
            tid: stationTid
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('멤버십 카드가 성공적으로 등록되었습니다.');
            document.getElementById('card-number').value = ''; // 입력 필드 초기화
            refreshUnusedCards(); // 카드 목록 새로고침
        } else {
            alert(data.message || '카드 등록에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('카드 등록 중 오류가 발생했습니다.');
    })
    .finally(() => {
        // 버튼 복원
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-plus-circle me-1"></i>카드 등록';
        }
    });
}

// 전화번호 마스킹 함수
function maskPhoneNumber(phone) {
    if (!phone) return '-';
    
    // 숫자만 추출
    const phoneDigits = phone.replace(/[^0-9]/g, '');
    
    // 11자리 휴대폰 번호인 경우
    if (phoneDigits.length === 11) {
        return `${phoneDigits.substring(0, 3)}****${phoneDigits.substring(7)}`;
    }
    // 10자리 전화번호인 경우
    else if (phoneDigits.length === 10) {
        return `${phoneDigits.substring(0, 3)}****${phoneDigits.substring(7)}`;
    }
    else {
        // 다른 형식의 경우 원본 반환
        return phone;
    }
}

// 신규 고객 등록 버튼 클릭 이벤트
document.getElementById('addCustomerBtn').addEventListener('click', function() {
    // 모달 내의 폼 초기화
    document.getElementById('customerRegistrationForm').reset();
    document.getElementById('phoneCheckResult').style.display = 'none';
    
    // 모달 열기
    const modal = new bootstrap.Modal(document.getElementById('customerRegistrationModal'));
    modal.show();
});

// 고객 목록 새로고침 함수
function loadCustomerList() {
    const currentPage = new URLSearchParams(window.location.search).get('page') || 1;
    const searchQuery = document.getElementById('searchInput')?.value || '';
    
    fetch(`/station/usermanage/?page=${currentPage}&search=${encodeURIComponent(searchQuery)}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        // 회원가입한 고객 목록 업데이트
        updateRegisteredCustomers(data.registered_customers);
        
        // 미회원가입 고객 목록 업데이트
        updateUnregisteredCustomers(data.unregistered_customers);
        
        // 페이지네이션 업데이트
        updatePagination(data);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('고객 목록을 불러오는 중 오류가 발생했습니다.', 'error');
    });
}

// 회원가입한 고객 목록 업데이트
function updateRegisteredCustomers(customers) {
    const registeredAccordion = document.getElementById('registeredCustomerAccordion');
    if (!registeredAccordion) return;

        // 기존 고객 카드 제거
    const existingCards = registeredAccordion.querySelectorAll('.card');
        existingCards.forEach(card => card.remove());

    if (customers && customers.length > 0) {
        customers.forEach(customer => {
            const customerCard = createRegisteredCustomerCard(customer);
            registeredAccordion.appendChild(customerCard);
        });
    } else {
        registeredAccordion.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-user-check text-muted fa-3x mb-3"></i>
                <p class="text-muted mb-0">회원가입한 고객이 없습니다.</p>
            </div>
        `;
    }
}

// 미회원가입 고객 목록 업데이트
function updateUnregisteredCustomers(customers) {
    const unregisteredAccordion = document.getElementById('unregisteredCustomerAccordion');
    if (!unregisteredAccordion) return;

    // 기존 고객 카드 제거
    const existingCards = unregisteredAccordion.querySelectorAll('.card');
    existingCards.forEach(card => card.remove());

    if (customers && customers.length > 0) {
        customers.forEach(customer => {
            const customerCard = createUnregisteredCustomerCard(customer);
            unregisteredAccordion.appendChild(customerCard);
        });
    } else {
        unregisteredAccordion.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-user-clock text-muted fa-3x mb-3"></i>
                <p class="text-muted mb-0">미회원가입 고객이 없습니다.</p>
            </div>
        `;
    }
}

// 회원가입한 고객 카드 생성
function createRegisteredCustomerCard(customer) {
    const card = document.createElement('div');
    card.className = 'card border-0 shadow-sm mb-3';
    card.setAttribute('data-customer-id', customer.id);
    
    card.innerHTML = `
        <div class="card-body p-0">
            <div class="accordion-item border-0">
                <div class="d-flex justify-content-between align-items-center p-3 customer-card-header" 
                     style="cursor: pointer;" 
                     data-customer-id="${customer.id}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="fas fa-user-check text-success me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${maskPhoneNumber(customer.phone)}</h6>
                            <small class="text-muted">카드: ${customer.card_number || '-'}</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center ms-3 flex-shrink-0">
                        <span class="badge bg-success me-2">회원가입</span>
                        <button class="btn btn-link text-decoration-none p-2 toggle-accordion" 
                                type="button" 
                                data-customer-id="${customer.id}"
                                aria-expanded="false"
                                style="border-radius: 50%; transition: all 0.2s ease;">
                            <i class="fas fa-chevron-down text-muted"></i>
                        </button>
                    </div>
                </div>
                
                <div id="customerCollapse-${customer.id}" class="accordion-collapse collapse">
                    <div class="accordion-body px-3 pb-3 pt-0">
                        <div class="border-top pt-3">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">최근 방문</span>
                                        <span>${customer.last_visit || '-'}</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">총 방문 횟수</span>
                                        <span>${customer.total_visit_count || 0}회</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">총 주유 금액</span>
                                        <span>${customer.total_fuel_amount || 0}원</span>
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-primary view-customer-history" data-customer-id="${customer.id}">
                                    상세보기
                                </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                            </div>
                        </div>
                    </div>
                `;

    // 이벤트 리스너 추가 (편집 버튼만 유지)
    const editBtn = card.querySelector('.edit-customer');
                if (editBtn) {
                    editBtn.addEventListener('click', () => editCustomer(customer.id));
                }
    
    // 아코디언 토글은 이벤트 위임으로 처리하므로 별도 리스너 불필요
    
    // 상세보기 버튼 이벤트 리스너 추가
    const viewBtn = card.querySelector('.view-customer-history');
    if (viewBtn) {
        viewBtn.addEventListener('click', () => showCustomerHistoryModal(customer.id));
    }
    
    return card;
}

// 미회원가입 고객 카드 생성
function createUnregisteredCustomerCard(customer) {
    const card = document.createElement('div');
    card.className = 'card border-0 shadow-sm mb-3';
    card.setAttribute('data-customer-id', customer.id);
    
    const createdDate = new Date(customer.created_at).toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    card.innerHTML = `
        <div class="card-body p-0">
            <div class="accordion-item border-0">
                <div class="d-flex justify-content-between align-items-center p-3 customer-card-header" 
                     style="cursor: pointer;" 
                     data-customer-id="${customer.id}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="fas fa-user-clock text-warning me-3 fs-4"></i>
                        <div class="flex-grow-1">
                            <h6 class="mb-0">${maskPhoneNumber(customer.phone)}</h6>
                            <small class="text-muted">카드: ${customer.card_number || '-'}</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center ms-3 flex-shrink-0">
                        <span class="badge bg-warning me-2">미회원가입</span>
                        <button class="btn btn-link text-decoration-none p-2 toggle-accordion" 
                                type="button" 
                                data-customer-id="${customer.id}"
                                aria-expanded="false"
                                style="border-radius: 50%; transition: all 0.2s ease;">
                            <i class="fas fa-chevron-down text-muted"></i>
                        </button>
                    </div>
                </div>
                
                <div id="customerCollapse-${customer.id}" class="accordion-collapse collapse">
                    <div class="accordion-body px-3 pb-3 pt-0">
                        <div class="border-top pt-3">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">등록일</span>
                                        <span>${createdDate}</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted">상태</span>
                                        <span class="text-warning">회원가입 대기중</span>
                                    </div>
                                </div>
                                <div class="col-12 mt-3">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        고객이 회원가입하면 자동으로 연동됩니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 이벤트 위임을 사용하므로 별도 이벤트 리스너 추가 불필요
    
    return card;
}

// 페이지네이션 업데이트 함수
function updatePagination(data) {
    const pagination = document.querySelector('.pagination');
    if (!pagination) return;

    let paginationHtml = '';
    
    // 이전 페이지 버튼
    paginationHtml += `
        <li class="page-item ${data.current_page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="?page=${data.current_page - 1}" ${data.current_page <= 1 ? 'tabindex="-1"' : ''}>
                <i class="fas fa-angle-left"></i>
            </a>
        </li>
    `;

    // 페이지 번호
    data.page_range.forEach(page => {
        paginationHtml += `
            <li class="page-item ${page === data.current_page ? 'active' : ''}">
                <a class="page-link" href="?page=${page}">${page}</a>
            </li>
        `;
    });

    // 다음 페이지 버튼
    paginationHtml += `
        <li class="page-item ${data.current_page >= data.total_pages ? 'disabled' : ''}">
            <a class="page-link" href="?page=${data.current_page + 1}" ${data.current_page >= data.total_pages ? 'tabindex="-1"' : ''}>
                <i class="fas fa-angle-right"></i>
            </a>
        </li>
    `;

    pagination.innerHTML = paginationHtml;

    // 페이지네이션 클릭 이벤트
    pagination.querySelectorAll('.page-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = new URLSearchParams(this.href.split('?')[1]).get('page');
            if (page) {
                const url = new URL(window.location.href);
                url.searchParams.set('page', page);
                window.history.pushState({}, '', url);
                loadCustomerList();
            }
        });
    });
}

function refreshUnusedCards() {
    // 로딩 상태 표시
    const refreshBtn = document.getElementById('refresh-cards-btn');
    const closeBtn = document.getElementById('close-cards-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>불러오는 중...';
    
    fetch('{% url "station:get_unused_cards" %}')
        .then(response => {
            if (!response.ok) {
                throw new Error('서버 응답 오류');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                const cardList = document.getElementById('unusedCardsList');
                cardList.innerHTML = ''; // 기존 목록 초기화
                
                if (data.cards.length === 0) {
                    cardList.innerHTML = '<li class="list-group-item text-center">등록된 미사용 카드가 없습니다</li>';
                } else {
                    data.cards.forEach(card => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-start';
                        li.innerHTML = `
                            <div class="flex-grow-1">
                                <div class="d-flex flex-column">
                                    <span class="card-number font-monospace fw-bold fs-6">${card.number}</span>
                                    ${card.tid ? `<span class="badge bg-info mt-1" style="width: fit-content;">TID: ${card.tid}</span>` : ''}
                                    <small class="text-muted mt-1">${card.created_at}</small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary flex-shrink-0 ms-2" onclick="selectCard('${card.number}', '${card.tid || ''}')">
                                <i class="fas fa-check me-1"></i>선택
                            </button>
                        `;
                        cardList.appendChild(li);
                    });
                }
                
                // 카드 목록이 로드된 후 버튼 상태 변경
                refreshBtn.style.display = 'none';
                closeBtn.style.display = 'inline-block';
                
            } else {
                console.error('카드 목록 조회 실패:', data.message);
                alert('카드 목록을 불러오는데 실패했습니다: ' + data.message);
                // 에러 발생 시 버튼 복원
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('카드 목록 조회 중 오류:', error);
            alert('카드 목록을 불러오는데 실패했습니다. 잠시 후 다시 시도해주세요.');
            // 에러 발생 시 버튼 복원
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = originalText;
        });
}

// 페이지 로드 시 카드 목록 초기 로드는 제거 (새로고침 버튼을 통해서만 로드)

// 새로고침 버튼 클릭 이벤트 핸들러
document.getElementById('refresh-cards-btn').addEventListener('click', refreshUnusedCards);

// 목록 닫기 버튼 클릭 이벤트 핸들러
document.getElementById('close-cards-btn').addEventListener('click', function() {
    const cardList = document.getElementById('unusedCardsList');
    const refreshBtn = document.getElementById('refresh-cards-btn');
    const closeBtn = document.getElementById('close-cards-btn');
    
    // 카드 목록 숨기기
    cardList.innerHTML = `
        <li class="list-group-item text-center text-muted">
            <i class="fas fa-info-circle me-2"></i>새로고침 버튼을 눌러 카드 목록을 불러오세요
        </li>
    `;
    
    // 버튼 상태 변경
    refreshBtn.style.display = 'inline-block';
    refreshBtn.disabled = false;
    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>카드 목록 불러오기';
    closeBtn.style.display = 'none';
});

// 아코디언 토글 기능
document.addEventListener('DOMContentLoaded', function() {
    // 아코디언 토글 함수
    function toggleAccordion(customerId) {
        console.log('toggleAccordion 함수 호출됨, customerId:', customerId);
        
        // ID에서 실제 ID 추출 (unreg_ 접두사 제거)
        const actualId = customerId.startsWith('unreg_') ? customerId : customerId;
        
        const collapseElement = document.getElementById(`customerCollapse-${customerId}`);
        const toggleButton = document.querySelector(`.toggle-accordion[data-customer-id="${customerId}"]`);
        
        console.log('collapseElement:', collapseElement);
        console.log('toggleButton:', toggleButton);
        
        if (!collapseElement || !toggleButton) {
            console.error('요소를 찾을 수 없습니다:', { collapseElement, toggleButton });
            return;
        }
        
        const icon = toggleButton.querySelector('i');
        const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
        
        console.log('현재 상태:', { isExpanded, customerId });
        
        // 다른 모든 아코디언 닫기
        document.querySelectorAll('.accordion-collapse').forEach(collapse => {
            if (collapse.id !== `customerCollapse-${customerId}`) {
                collapse.classList.remove('show');
                const otherToggle = document.querySelector(`.toggle-accordion[data-customer-id="${collapse.id.split('-')[1]}"]`);
                if (otherToggle) {
                    otherToggle.setAttribute('aria-expanded', 'false');
                    const otherIcon = otherToggle.querySelector('i');
                    if (otherIcon) {
                        otherIcon.className = 'fas fa-chevron-down text-muted';
                    }
                }
            }
        });
        
        // 현재 아코디언 토글
        if (isExpanded) {
            collapseElement.classList.remove('show');
            toggleButton.setAttribute('aria-expanded', 'false');
            icon.className = 'fas fa-chevron-down text-muted';
        } else {
            collapseElement.classList.add('show');
            toggleButton.setAttribute('aria-expanded', 'true');
            icon.className = 'fas fa-chevron-up text-muted';
        }
    }
    
    // 이벤트 위임을 사용하여 아코디언 토글 이벤트 처리
    document.addEventListener('click', function(e) {
        console.log('클릭 이벤트 발생:', e.target);
        
        // 토글 버튼 클릭 처리
        if (e.target.closest('.toggle-accordion')) {
            console.log('토글 버튼 클릭됨');
            e.preventDefault();
            e.stopPropagation();
            const toggleButton = e.target.closest('.toggle-accordion');
            const customerId = toggleButton.dataset.customerId;
            console.log('토글할 고객 ID:', customerId);
            if (customerId) {
            toggleAccordion(customerId);
            } else {
                console.error('customerId가 없습니다:', toggleButton);
            }
        }
        
        // 카드 헤더 클릭 처리 (토글 버튼이 아닌 경우에만)
        if (e.target.closest('.customer-card-header') && !e.target.closest('.toggle-accordion')) {
            console.log('카드 헤더 클릭됨');
            const cardHeader = e.target.closest('.customer-card-header');
            const customerId = cardHeader.dataset.customerId;
            console.log('토글할 고객 ID:', customerId);
            if (customerId) {
            toggleAccordion(customerId);
            } else {
                console.error('customerId가 없습니다:', cardHeader);
            }
        }
    });
    
    // 뒤로 가기 버튼 처리
    window.addEventListener('popstate', function(event) {
        // 열린 모달들 확인
        const openModals = document.querySelectorAll('.modal.show');
        
        if (openModals.length > 0) {
            // 가장 최근에 열린 모달 닫기
            const lastOpenModal = openModals[openModals.length - 1];
            const modalInstance = bootstrap.Modal.getInstance(lastOpenModal);
            
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // 브라우저 히스토리에서 뒤로 가기 이벤트 무효화
            event.preventDefault();
            history.pushState(null, null, window.location.href);
        }
    });
    
    // 모달들에 히스토리 관리 추가
    const modals = ['customerRegistrationModal', 'customerDetailModal', 'cardManageModal'];
    
    modals.forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            modalElement.addEventListener('show.bs.modal', function() {
                // 모달이 열릴 때 히스토리에 상태 추가
                history.pushState({modal: modalId}, null, window.location.href);
            });
            
            modalElement.addEventListener('hidden.bs.modal', function() {
                // 모달이 닫힐 때 히스토리에서 상태 제거 (뒤로 가기로 닫힌 경우가 아닌 경우)
                if (history.state && history.state.modal === modalId) {
                    history.back();
                }
            });
        }
    });
    
    // 카드번호 조회 기능
    const searchCardBtn = document.getElementById('search-card-btn');
    const searchCardInput = document.getElementById('search-card-number');
    const searchCardResult = document.getElementById('search-card-result');
    const searchCardSuggestions = document.getElementById('search-card-suggestions');
    const cardSuggestionsList = document.getElementById('card-suggestions-list');
    
    // 실시간 검색을 위한 디바운스 타이머
    let searchTimeout = null;
    
    if (searchCardBtn) {
        searchCardBtn.addEventListener('click', function() {
            searchCardByNumber();
        });
    }
    
    if (searchCardInput) {
        searchCardInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchCardByNumber();
            }
        });
        
        // 입력 시 숫자만 허용 및 실시간 검색
        searchCardInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 16) {
                this.value = this.value.slice(0, 16);
            }
            
            // 실시간 검색 실행
            const cardNumber = this.value.trim();
            
            // 기존 타이머 클리어
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // 4자리 이상 입력된 경우에만 검색
            if (cardNumber.length >= 4) {
                // 디바운스: 300ms 후에 검색 실행
                searchTimeout = setTimeout(() => {
                    searchCardsByNumberPartial(cardNumber);
                }, 300);
            } else {
                // 4자리 미만이면 검색 결과 숨기기
                hideSearchSuggestions();
            }
        });
        
        // 입력 필드에서 포커스가 벗어날 때 검색 결과 숨기기
        searchCardInput.addEventListener('blur', function() {
            // 약간의 지연을 두어 클릭 이벤트가 먼저 처리되도록 함
            setTimeout(() => {
                hideSearchSuggestions();
            }, 200);
        });
    }
    
    function searchCardByNumber() {
        const cardNumber = searchCardInput.value.trim();
        
        if (!cardNumber) {
            showSearchResult('카드번호를 입력해주세요.', 'warning');
            return;
        }
        
        if (cardNumber.length < 4) {
            showSearchResult('카드번호는 최소 4자리 이상 입력해주세요.', 'warning');
            return;
        }
        
        // 로딩 상태 표시
        searchCardBtn.disabled = true;
        searchCardBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>조회 중...';
        
        // API 호출
        fetch(`{% url 'station:search_card_by_number' %}?card_number=${cardNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.exists) {
                        // 실시간 검색과 동일한 UI로 표시
                        showSearchSuggestions(data.cards, cardNumber);
                    } else {
                        showSearchResult(data.message, 'info');
                    }
                } else {
                    showSearchResult(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showSearchResult('카드 조회 중 오류가 발생했습니다.', 'error');
            })
            .finally(() => {
                // 버튼 상태 복원
                searchCardBtn.disabled = false;
                searchCardBtn.innerHTML = '<i class="fas fa-search me-1"></i>조회';
            });
    }
    
    // showCardInfo 함수는 더 이상 사용되지 않음 (실시간 검색 UI로 통일)
    /*
    function showCardInfo(cardData) {
        const statusIcon = cardData.is_used ? 'fa-times-circle' : 'fa-check-circle';
        const statusText = cardData.is_used ? '사용 중' : '미사용';
        const statusClass = cardData.is_used ? 'text-danger' : 'text-success';
        
        let matchInfo = '';
        if (cardData.total_matches && cardData.total_matches > 1) {
            matchInfo = `
                <div class="alert alert-warning mb-2">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>"${cardData.search_term}"</strong> 검색어로 <strong>${cardData.total_matches}개</strong>의 카드가 매칭되었습니다. 
                    첫 번째 매칭 카드를 표시합니다. 더 정확한 검색을 위해 더 많은 숫자를 입력해주세요.
                </div>
            `;
        }
        
        searchCardResult.innerHTML = `
            ${matchInfo}
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="fas fa-credit-card me-2"></i>카드 정보
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>카드번호:</strong> ${cardData.card_number}</p>
                        <p class="mb-1"><strong>상태:</strong> <span class="${statusClass}"><i class="fas ${statusIcon} me-1"></i>${statusText}</span></p>
                        <p class="mb-1"><strong>생성일:</strong> ${cardData.created_at}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>TID:</strong> ${cardData.tids || '없음'}</p>
                        <p class="mb-1"><strong>수정일:</strong> ${cardData.updated_at}</p>
                    </div>
                </div>
            </div>
        `;
        searchCardResult.style.display = 'block';
    }
    */
    
    function showSearchResult(message, type) {
        const alertClass = type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        const icon = type === 'error' ? 'fa-exclamation-circle' : 
                    type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
        
        searchCardResult.innerHTML = `
            <div class="alert ${alertClass}">
                <i class="fas ${icon} me-2"></i>${message}
            </div>
        `;
        searchCardResult.style.display = 'block';
    }
    
    // 실시간 카드 검색 함수
    function searchCardsByNumberPartial(cardNumber) {
        console.log('실시간 검색 시작:', cardNumber);
        
        // API 호출
        fetch(`{% url 'station:search_cards_by_number_partial' %}?card_number=${cardNumber}`)
            .then(response => {
                console.log('API 응답 상태:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API 응답 데이터:', data);
                if (data.status === 'success') {
                    showSearchSuggestions(data.cards, cardNumber);
                } else {
                    console.error('실시간 검색 오류:', data.message);
                    hideSearchSuggestions();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                hideSearchSuggestions();
            });
    }
    
    // 검색 결과 표시 함수
    function showSearchSuggestions(cards, searchTerm) {
        if (!cards || cards.length === 0) {
            hideSearchSuggestions();
            return;
        }
        
        let suggestionsHtml = '';
        
        cards.forEach(card => {
            const statusIcon = card.is_used ? 'fa-times-circle' : 'fa-check-circle';
            const statusClass = card.is_used ? 'text-danger' : 'text-success';
            
            // 검색어 하이라이트 (16자리 전체 카드번호에서)
            const highlightedNumber = card.card_number.replace(
                new RegExp(searchTerm, 'gi'),
                match => `<mark class="bg-warning">${match}</mark>`
            );
            
            suggestionsHtml += `
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <strong class="me-2">${highlightedNumber}</strong>
                                <span class="badge ${statusClass === 'text-success' ? 'bg-success' : 'bg-danger'}">
                                    <i class="fas ${statusIcon} me-1"></i>${card.is_used ? '사용 중' : '미사용'}
                                </span>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-credit-card me-1"></i>카드번호: ${card.card_number_short}
                            </small>
                            ${card.tids ? `<br><small class="text-info"><i class="fas fa-tag me-1"></i>TID: ${card.tids}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="selectCardFromSearch('${card.card_number_short}')">
                                <i class="fas fa-check me-1"></i>선택
                            </button>
                        </div>
                    </div>
                </li>
            `;
        });
        
        cardSuggestionsList.innerHTML = suggestionsHtml;
        searchCardSuggestions.style.display = 'block';
        
        // 기존 검색 결과 숨기기
        searchCardResult.style.display = 'none';
    }
    
    // 검색 결과 숨기기 함수
    function hideSearchSuggestions() {
        searchCardSuggestions.style.display = 'none';
        cardSuggestionsList.innerHTML = '';
    }
    
    // 검색 결과에서 카드 선택 함수
    function selectCardFromSearch(cardNumber) {
        searchCardInput.value = cardNumber;
        hideSearchSuggestions();
        
        // 선택된 카드의 상세 정보 표시
        searchCardByNumber();
    }
    
    // 고객 목록 보이기/숨기기 기능 - 즉시 실행
    function setupCustomerListToggle() {
        console.log('고객 목록 보이기/숨기기 기능 초기화 시작');
        
        // 회원가입 고객 목록 보이기/숨기기
        const showRegisteredBtn = document.getElementById('show-registered-btn');
        const hideRegisteredBtn = document.getElementById('hide-registered-btn');
        const registeredSection = document.getElementById('registered-customer-section');
        
        console.log('회원가입 고객 요소들:', {
            showRegisteredBtn: showRegisteredBtn,
            hideRegisteredBtn: hideRegisteredBtn,
            registeredSection: registeredSection
        });
        
        if (showRegisteredBtn && hideRegisteredBtn && registeredSection) {
            console.log('회원가입 고객 목록 이벤트 리스너 설정');
            
            // registeredSection.classList.remove('d-none');
            // registeredSection.classList.add('d-block');
            
            // 기존 이벤트 리스너 제거
            showRegisteredBtn.onclick = null;
            hideRegisteredBtn.onclick = null;
            
            // 보이기 버튼 클릭 - 더 확실한 방식으로 변경
            showRegisteredBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('회원가입 고객 목록 보이기 버튼 클릭됨');
                console.log('클릭 전 registeredSection:', registeredSection);
                console.log('클릭 전 display:', registeredSection.style.display);
                
                // d-none 클래스 제거
                registeredSection.classList.remove('d-none');
                // 여러 방법으로 표시 처리
                registeredSection.style.display = 'block';
                registeredSection.style.visibility = 'visible';
                registeredSection.style.height = 'auto';
                registeredSection.style.overflow = 'visible';
                
                showRegisteredBtn.style.display = 'none';
                hideRegisteredBtn.style.display = 'inline-block';
                
                console.log('클릭 후 display:', registeredSection.style.display);
                console.log('회원가입 고객 목록 표시됨');
                
                // 1초 후 다시 확인
                setTimeout(function() {
                    console.log('1초 후 display:', registeredSection.style.display);
                    console.log('1초 후 computed display:', window.getComputedStyle(registeredSection).display);
                }, 1000);
                
                return false;
            };
            
            // 숨기기 버튼 클릭 - 더 확실한 방식으로 변경
            hideRegisteredBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('회원가입 고객 목록 숨기기 버튼 클릭됨');
                console.log('클릭 전 registeredSection:', registeredSection);
                console.log('클릭 전 display:', registeredSection.style.display);
                
                // 여러 방법으로 숨김 처리
                registeredSection.style.display = 'none';
                registeredSection.style.visibility = 'hidden';
                registeredSection.style.height = '0px';
                registeredSection.style.overflow = 'hidden';
                
                hideRegisteredBtn.style.display = 'none';
                showRegisteredBtn.style.display = 'inline-block';
                
                console.log('클릭 후 display:', registeredSection.style.display);
                console.log('회원가입 고객 목록 숨겨짐');
                
                // 1초 후 다시 확인
                setTimeout(function() {
                    console.log('1초 후 display:', registeredSection.style.display);
                    console.log('1초 후 computed display:', window.getComputedStyle(registeredSection).display);
                }, 1000);
                
                return false;
            };
        } else {
            console.error('회원가입 고객 요소를 찾을 수 없음');
        }
        
        // 미회원가입 고객 목록 보이기/숨기기
        const showUnregisteredBtn = document.getElementById('show-unregistered-btn');
        const hideUnregisteredBtn = document.getElementById('hide-unregistered-btn');
        const unregisteredSection = document.getElementById('unregistered-customer-section');
        
        console.log('미회원가입 고객 요소들:', {
            showUnregisteredBtn: showUnregisteredBtn,
            hideUnregisteredBtn: hideUnregisteredBtn,
            unregisteredSection: unregisteredSection
        });
        
        if (showUnregisteredBtn && hideUnregisteredBtn && unregisteredSection) {
            console.log('미회원가입 고객 목록 이벤트 리스너 설정');
            
            // unregisteredSection.classList.remove('d-none');
            // unregisteredSection.classList.add('d-block');
            
            // 기존 이벤트 리스너 제거
            showUnregisteredBtn.onclick = null;
            hideUnregisteredBtn.onclick = null;
            
            // 보이기 버튼 클릭 - 더 확실한 방식으로 변경
            showUnregisteredBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('미회원가입 고객 목록 보이기 버튼 클릭됨');
                console.log('클릭 전 unregisteredSection:', unregisteredSection);
                console.log('클릭 전 display:', unregisteredSection.style.display);
                
                // d-none 클래스 제거
                unregisteredSection.classList.remove('d-none');
                // 여러 방법으로 표시 처리
                unregisteredSection.style.display = 'block';
                unregisteredSection.style.visibility = 'visible';
                unregisteredSection.style.height = 'auto';
                unregisteredSection.style.overflow = 'visible';
                
                showUnregisteredBtn.style.display = 'none';
                hideUnregisteredBtn.style.display = 'inline-block';
                
                console.log('클릭 후 display:', unregisteredSection.style.display);
                console.log('미회원가입 고객 목록 표시됨');
                
                // 1초 후 다시 확인
                setTimeout(function() {
                    console.log('1초 후 display:', unregisteredSection.style.display);
                    console.log('1초 후 computed display:', window.getComputedStyle(unregisteredSection).display);
                }, 1000);
                
                return false;
            };
            
            // 숨기기 버튼 클릭 - 더 확실한 방식으로 변경
            hideUnregisteredBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('미회원가입 고객 목록 숨기기 버튼 클릭됨');
                console.log('클릭 전 unregisteredSection:', unregisteredSection);
                console.log('클릭 전 display:', unregisteredSection.style.display);
                
                // 여러 방법으로 숨김 처리
                unregisteredSection.style.display = 'none';
                unregisteredSection.style.visibility = 'hidden';
                unregisteredSection.style.height = '0px';
                unregisteredSection.style.overflow = 'hidden';
                
                hideUnregisteredBtn.style.display = 'none';
                showUnregisteredBtn.style.display = 'inline-block';
                
                console.log('클릭 후 display:', unregisteredSection.style.display);
                console.log('미회원가입 고객 목록 숨겨짐');
                
                // 1초 후 다시 확인
                setTimeout(function() {
                    console.log('1초 후 display:', unregisteredSection.style.display);
                    console.log('1초 후 computed display:', window.getComputedStyle(unregisteredSection).display);
                }, 1000);
                
                return false;
            };
        } else {
            console.error('미회원가입 고객 요소를 찾을 수 없음');
        }
        
        console.log('고객 목록 보이기/숨기기 기능 초기화 완료');
    }
    
    // DOM 로드 완료 후 실행
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupCustomerListToggle);
    } else {
        setupCustomerListToggle();
    }
});

// 고객 상세 정보 보기
function showCustomerHistoryModal(customerId) {
    const modalElem = document.getElementById('customerHistoryModal');
    console.log('[모달 DOM 존재 여부]', !!modalElem, modalElem);
    if (!modalElem) {
        alert('모달 DOM이 없습니다. 템플릿 위치를 확인하세요.');
        return;
    }
    const modal = new bootstrap.Modal(modalElem);
    const contentDiv = document.getElementById('customerHistoryContent');
    contentDiv.innerHTML = `<div class='text-center text-muted py-4'><i class='fas fa-spinner fa-spin fa-2x mb-2'></i><br>데이터를 불러오는 중...</div>`;
    console.log('[모달 show 호출]');
    modal.show();
    fetch(`/station/api/visit-history/?customer_id=${customerId}`)
        .then(res => res.json())
        .then(data => {
            const records = data.records || data.visits || [];
            let html = '';
            if (records.length > 0) {
                html += `<div class='table-responsive'><table class='table table-bordered table-hover align-middle mb-0'>`;
                html += `<thead class='table-light'><tr><th>날짜</th><th>시간</th><th>금액</th><th>유종</th></tr></thead><tbody>`;
                records.forEach(r => {
                    html += `<tr><td>${r.date}</td><td>${r.time}</td><td>${parseInt(r.amount).toLocaleString()}원</td><td>${r.product}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                html = `<div class='text-center text-muted py-4'>방문 기록이 없습니다.</div>`;
            }
            contentDiv.innerHTML = html;
        })
        .catch(() => {
            contentDiv.innerHTML = `<div class='text-center text-danger py-4'>데이터를 불러오지 못했습니다.</div>`;
        });
}

// 상세보기 버튼 및 아코디언 내부 클릭 모두 전역 이벤트 위임으로 처리

document.addEventListener('click', function(e) {
    // 1. 상세보기 버튼 클릭
    const btn = e.target.closest('.view-customer-history');
    if (btn) {
        const customerId = btn.getAttribute('data-customer-id');
        if (customerId) {
            showCustomerHistoryModal(customerId);
            return;
        }
    }
    // 2. 아코디언 내부(.accordion-body) 클릭 (단, 상세보기 버튼 클릭은 제외)
    const body = e.target.closest('.accordion-body');
    if (body && !e.target.closest('.view-customer-history')) {
        const card = body.closest('.customer-card');
        if (card) {
            const customerId = card.getAttribute('data-customer-id');
            if (customerId) {
                showCustomerHistoryModal(customerId);
            }
        }
    }
});
</script>
{% endblock %} 