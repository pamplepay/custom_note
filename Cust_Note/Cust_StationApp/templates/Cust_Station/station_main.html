{% extends 'base/base.html' %}
{% load humanize %}

{% block title %}Oil Note - 주유소 홈{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0 bg-success text-white">
                <div class="card-body">
                    <h1 class="card-title h3 mb-3">
                        <i class="fas fa-gas-pump me-2"></i>{{ user.station_profile.station_name|default:"주유소" }} 관리자님, 환영합니다!
                    </h1>
                    <p class="card-text mb-0">오늘도 행복한 하루 되세요.</p>
                </div>
            </div>
        </div>
    </div>   

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0" style="cursor: pointer;" onclick="showDailyData('{{ monthly_stats.previous_month_str|default:'' }}', 'quantity')">
                <div class="card-body text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-chart-pie fa-2x text-primary"></i>
                    </div>
                    <h5 class="card-title">전월 판매량</h5>
                    <h3 class="text-primary mb-0">
                        {% if monthly_stats and monthly_stats.previous_month %}
                            {{ monthly_stats.previous_month.total_quantity|floatformat:0|intcomma }}L
                        {% else %}
                            0L
                        {% endif %}
                    </h3>
                    {% if monthly_stats and monthly_stats.previous_top_products %}
                        <small class="text-muted d-block mt-2">
                            {% for product, count in monthly_stats.previous_top_products %}
                                {{ product }}: {{ count }}회
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </small>
                    {% endif %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>클릭하여 상세보기
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0" style="cursor: pointer;" onclick="showDailyData('{{ monthly_stats.previous_month_str|default:'' }}', 'amount')">
                <div class="card-body text-center">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-won-sign fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title">전월 판매금액</h5>
                    <h3 class="text-success mb-0">
                        {% if monthly_stats and monthly_stats.previous_month %}
                            {{ monthly_stats.previous_month.total_amount|floatformat:0|intcomma }}원
                        {% else %}
                            0원
                        {% endif %}
                    </h3>
                    {% if monthly_stats and monthly_stats.previous_top_products_by_amount %}
                        <small class="text-muted d-block mt-2">
                            {% for product, amount in monthly_stats.previous_top_products_by_amount %}
                                {{ product }}: {{ amount|floatformat:0|intcomma }}원
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </small>
                    {% endif %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>클릭하여 상세보기
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0" style="cursor: pointer;" onclick="showDailyData('{{ monthly_stats.current_month_str|default:'' }}', 'quantity')">
                <div class="card-body text-center">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-tint fa-2x text-info"></i>
                    </div>
                    <h5 class="card-title">금월 판매량</h5>
                    <h3 class="text-info mb-0">
                        {% if monthly_stats and monthly_stats.current_month %}
                            {{ monthly_stats.current_month.total_quantity|floatformat:0|intcomma }}L
                        {% else %}
                            0L
                        {% endif %}
                    </h3>
                    {% if monthly_stats and monthly_stats.current_top_products %}
                        <small class="text-muted d-block mt-2">
                            {% for product, count in monthly_stats.current_top_products %}
                                {{ product }}: {{ count }}회
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </small>
                    {% endif %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>클릭하여 상세보기
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0" style="cursor: pointer;" onclick="showDailyData('{{ monthly_stats.current_month_str|default:'' }}', 'amount')">
                <div class="card-body text-center">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-won-sign fa-2x text-warning"></i>
                    </div>
                    <h5 class="card-title">금월 판매금액</h5>
                    <h3 class="text-warning mb-0">
                        {% if monthly_stats and monthly_stats.current_month %}
                            {{ monthly_stats.current_month.total_amount|floatformat:0|intcomma }}원
                        {% else %}
                            0원
                        {% endif %}
                    </h3>
                    {% if monthly_stats and monthly_stats.current_top_products_by_amount %}
                        <small class="text-muted d-block mt-2">
                            {% for product, amount in monthly_stats.current_top_products_by_amount %}
                                {{ product }}: {{ amount|floatformat:0|intcomma }}원
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        </small>
                    {% endif %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>클릭하여 상세보기
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-users fa-2x text-primary"></i>
                    </div>
                    <h5 class="card-title">VIP 고객수</h5>
                    <h3 class="text-primary mb-0">{{ total_customers|intcomma }}명</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-calendar-alt fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title">전월 방문 횟수 & 주유금액</h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted fs-6">방문 횟수</span>
                            <span class="text-success fw-bold fs-5">{{ previous_month_visitors|default:0 }}회</span>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted fs-6">주유 금액</span>
                            <span class="text-success fw-bold fs-5">{{ previous_month_amount|default:0|intcomma }}원</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-calendar-check fa-2x text-info"></i>
                    </div>
                    <h5 class="card-title">금월 방문 횟수 & 주유금액</h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted fs-6">방문 횟수</span>
                            <span class="text-info fw-bold fs-5">{{ current_month_visitors|default:0 }}회</span>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted fs-6">주유 금액</span>
                            <span class="text-info fw-bold fs-5">{{ current_month_amount|default:0|intcomma }}원</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-gas-pump fa-2x text-primary"></i>
                    </div>
                    <h5 class="card-title">오늘 매출</h5>
                    <h3 class="text-primary mb-0">0원</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-users fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title">총 회원수</h5>
                    <h3 class="text-success mb-0">0명</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-credit-card fa-2x text-info"></i>
                    </div>
                    <h5 class="card-title">등록 카드</h5>
                    <h3 class="text-info mb-0">{{ total_cards|intcomma }}장</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body text-center">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-ticket-alt fa-2x text-warning"></i>
                    </div>
                    <h5 class="card-title">발행 쿠폰</h5>
                    <h3 class="text-warning mb-0">0장</h3>
                </div>
            </div>
        </div>
    </div> -->

    <!-- <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-line me-2"></i>매출 추이
                    </h5>
                    <div class="text-center py-4">
                        <i class="fas fa-chart-area fa-3x text-muted mb-3"></i>
                        <p class="text-muted">아직 매출 데이터가 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-pie me-2"></i>유종별 판매 비율
                    </h5>
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">아직 판매 데이터가 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div> -->

    <!-- <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-history me-2"></i>최근 VIP거래 내역
                    </h5>
                    <div class="text-center py-4">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-3">아직 거래 내역이 없습니다.</p>
                        <a href="{% url 'station:management' %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-cog me-1"></i>주유소 관리하기
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div> -->

    <!-- 메뉴 카드 -->
    <div class="row g-4">
        <!-- 고객 관리 카드 -->
        <div class="col-md-6 col-lg-4">
            <a href="{% url 'station:usermanage' %}" class="text-decoration-none">
                <div class="card h-100 border-0 shadow-sm hover-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-3x mb-3 text-primary"></i>
                        <h5 class="card-title">고객 관리</h5>
                        <p class="card-text text-muted">고객 정보를 조회하고 관리합니다.</p>
                    </div>
                </div>
            </a>
        </div>
        
        <!-- 멤버십 카드 관리 카드 -->
        <div class="col-md-6 col-lg-4">
            <a href="{% url 'station:cardmanage' %}" class="text-decoration-none">
                <div class="card h-100 border-0 shadow-sm hover-card">
                    <div class="card-body text-center">
                        <i class="fas fa-credit-card fa-3x mb-3 text-primary"></i>
                        <h5 class="card-title">멤버십 카드 관리</h5>
                        <p class="card-text text-muted">멤버십 카드를 등록하고 관리합니다.</p>
                    </div>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- 날짜별 상세 데이터 모달 -->
<div class="modal fade" id="dailyDataModal" tabindex="-1" aria-labelledby="dailyDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dailyDataModalLabel">날짜별 상세 데이터</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="dailyDataContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">로딩 중...</span>
                        </div>
                        <p class="mt-2">데이터를 불러오는 중...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<style>
/* 모달이 네브바와 겹치지 않도록 상단 여백 추가 */
.modal-dialog-centered {
    margin-top: 80px !important;
}

/* 모달이 화면 상단에 너무 가깝게 붙지 않도록 최소 여백 설정 */
.modal.show .modal-dialog {
    margin-top: 80px !important;
}

/* 모바일에서도 적절한 여백 유지 */
@media (max-width: 768px) {
    .modal-dialog-centered {
        margin-top: 60px !important;
    }
    
    .modal.show .modal-dialog {
        margin-top: 60px !important;
    }
}
</style>

<script>
function showDailyData(month, type) {
    if (!month) {
        // 모달을 열고 데이터가 없다는 메시지 표시
        const modal = new bootstrap.Modal(document.getElementById('dailyDataModal'));
        modal.show();
        
        document.getElementById('dailyDataContent').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>해당 월의 데이터가 없습니다.</p>
                <small>매출 데이터를 업로드하면 상세 정보를 확인할 수 있습니다.</small>
            </div>
        `;
        return;
    }
    
    // 모달 표시
    const modal = new bootstrap.Modal(document.getElementById('dailyDataModal'));
    modal.show();
    
    // 로딩 상태 표시
    document.getElementById('dailyDataContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-2">데이터를 불러오는 중...</p>
        </div>
    `;
    
    // AJAX 요청
    fetch(`{% url 'station:get_daily_sales_data' %}?month=${month}&type=${type}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDailyData(data);
            } else {
                document.getElementById('dailyDataContent').innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>데이터를 불러오는 중 오류가 발생했습니다.</p>
                        <small>${data.error || '알 수 없는 오류'}</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('dailyDataContent').innerHTML = `
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>네트워크 오류가 발생했습니다.</p>
                    <small>잠시 후 다시 시도해주세요.</small>
                </div>
            `;
        });
}

function displayDailyData(data) {
    const typeText = data.type === 'quantity' ? '판매량' : '판매금액';
    const unit = data.type === 'quantity' ? 'L' : '원';
    
    let html = `
        <h6 class="mb-3">${data.month} ${typeText} 상세</h6>
    `;
    
    // 상위 제품 정보 표시
    if (data.top_products && data.top_products.length > 0) {
        html += `
            <div class="alert alert-info mb-3">
                <h6 class="alert-heading mb-2">
                    <i class="fas fa-star me-2"></i>상위 판매 제품
                </h6>
                <div class="row">
        `;
        
        data.top_products.forEach((product, index) => {
            if (data.type === 'quantity') {
                html += `
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${index + 1}. ${product.product}</span>
                            <div class="text-end">
                                <div class="small text-muted">판매횟수: ${product.count}회</div>
                                <div class="small text-muted">판매수량: ${parseFloat(product.quantity).toLocaleString()}L</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {  // amount
                html += `
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${index + 1}. ${product.product}</span>
                            <div class="text-end">
                                <div class="small text-muted">판매횟수: ${product.count}회</div>
                                <div class="small text-muted">판매수량: ${parseFloat(product.quantity).toLocaleString()}L</div>
                                <div class="small text-muted">판매금액: ${parseFloat(product.amount).toLocaleString()}원</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th>날짜</th>
                        <th class="text-end">${typeText}</th>
                        ${data.daily_product_stats && data.daily_product_stats.length > 0 ? '<th class="text-center">상위 제품</th>' : ''}
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (data.data.length === 0) {
        html += `
            <tr>
                <td colspan="${data.daily_product_stats && data.daily_product_stats.length > 0 ? '3' : '2'}" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    해당 월의 데이터가 없습니다.
                </td>
            </tr>
        `;
    } else {
        data.data.forEach((item, index) => {
            const formattedValue = data.type === 'quantity' 
                ? parseFloat(item.value).toLocaleString() + unit
                : parseFloat(item.value).toLocaleString() + unit;
            
            let productInfo = '';
            if (data.daily_product_stats && data.daily_product_stats[index]) {
                const dailyStats = data.daily_product_stats[index];
                if (dailyStats.products && dailyStats.products.length > 0) {
                    if (data.type === 'quantity') {
                        productInfo = dailyStats.products.map(product => 
                            `<div class="small">
                                <strong>${product.product}</strong><br>
                                <span class="text-muted">${product.count}회 / ${parseFloat(product.quantity).toLocaleString()}L</span>
                            </div>`
                        ).join('<hr class="my-1">');
                    } else {  // amount
                        productInfo = dailyStats.products.map(product => 
                            `<div class="small">
                                <strong>${product.product}</strong><br>
                                <span class="text-muted">${product.count}회 / ${parseFloat(product.quantity).toLocaleString()}L</span><br>
                                <span class="text-muted">${parseFloat(product.amount).toLocaleString()}원</span>
                            </div>`
                        ).join('<hr class="my-1">');
                    }
                }
            }
            
            html += `
                <tr>
                    <td>${item.date}</td>
                    <td class="text-end">${formattedValue}</td>
                    ${data.daily_product_stats && data.daily_product_stats.length > 0 ? `<td class="text-center">${productInfo}</td>` : ''}
                </tr>
            `;
        });
    }
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('dailyDataContent').innerHTML = html;
}
</script>

{% endblock %} 