{% extends 'base/base.html' %}

{% block title %}Oil Note - {{ station_name }} 멤버쉽카드 관리{% endblock %}

{% block extra_css %}
<style>
    /* 모달 z-index 조정 */
    .modal-backdrop {
        z-index: 10040 !important;
    }
    
    .modal {
        z-index: 10050 !important;
    }
    
    /* 모달 위치 조정 */
    .modal-dialog {
        margin-top: 80px !important;
    }
    
    /* 통계 카드 스타일 */
    .stats-card {
        transition: transform 0.2s;
        border: none;
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-card .card-body {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 180px;
    }
    
    .stats-card.progress-card .card-body {
        justify-content: space-between;
    }
    
    /* 프로그레스 바 애니메이션 */
    @keyframes progressAnimation {
        from { width: 0; }
    }
    
    .progress-bar {
        animation: progressAnimation 1s ease-out forwards;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>멤버쉽카드 관리</h2>
            <p class="text-muted mb-0">{{ station_name }} 주유소</p>
        </div>
    </div>
    
    <!-- 통계 정보 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card shadow-sm">
                <div class="card-body text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-credit-card fa-2x text-primary"></i>
                    </div>
                    <h5 class="card-title">전체 카드</h5>
                    <h3 class="text-primary mb-0" id="totalCardsCount">{{ total_cards }}장</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card shadow-sm">
                <div class="card-body text-center">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                    <h5 class="card-title">사용 가능</h5>
                    <h3 class="text-success mb-0" id="activeCardsCount">{{ active_cards }}장</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card shadow-sm">
                <div class="card-body text-center">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-clock fa-2x text-warning"></i>
                    </div>
                    <h5 class="card-title">사용중</h5>
                    <h3 class="text-warning mb-0" id="usedCardsCount">{{ used_cards }}장</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card progress-card shadow-sm">
                <div class="card-body text-center">
                    <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-chart-pie fa-2x text-info"></i>
                    </div>
                    <h5 class="card-title">사용 현황</h5>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ active_percentage }}%;" 
                             aria-valuenow="{{ active_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ active_percentage|floatformat:1 }}%
                        </div>
                        <div class="progress-bar bg-warning" role="progressbar" 
                             style="width: {{ used_percentage }}%;" 
                             aria-valuenow="{{ used_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ used_percentage|floatformat:1 }}%
                        </div>
                    </div>
                    <div class="d-flex justify-content-center gap-3 small text-muted">
                        <span><i class="fas fa-circle text-success me-1"></i>사용 가능</span>
                        <span><i class="fas fa-circle text-warning me-1"></i>사용중</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 카드 일괄 등록 폼 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">멤버쉽카드 일괄 등록</h5>
        </div>
        <div class="card-body">
            <form id="bulkCardForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="startNumber" class="form-label">시작 번호</label>
                        <input type="text" class="form-control" id="startNumber" required maxlength="16" pattern="\d{16}">
                        <div class="form-text">16자리 숫자를 입력하세요</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="cardCount" class="form-label">등록할 카드 수</label>
                        <input type="number" class="form-control" id="cardCount" required min="1" max="1000">
                        <div class="form-text">1~1000 사이의 숫자를 입력하세요</div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">일괄 등록</button>
            </form>
        </div>
    </div>

    <!-- 카드 개별 등록 폼 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">멤버쉽카드 개별 등록</h5>
        </div>
        <div class="card-body">
            <form id="singleCardForm">
                <div class="mb-3">
                    <label for="cardNumber" class="form-label">카드 번호</label>
                    <input type="text" class="form-control" id="cardNumber" required maxlength="16" pattern="\d{16}">
                    <div class="form-text">16자리 숫자를 입력하세요</div>
                </div>
                <button type="submit" class="btn btn-primary">등록</button>
            </form>
        </div>
    </div>

    <!-- 등록된 카드 목록 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">등록된 카드 목록</h5>
                <small class="text-muted" id="cardCount">총 {{ total_cards }}장의 카드가 등록되어 있습니다</small>
            </div>
            <div class="d-flex align-items-center">
                <button id="refreshCardList" class="btn btn-primary btn-sm">
                    <i class="fas fa-sync-alt me-1"></i>새로고침
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush" id="cardList">
                <!-- 서버에서 가져온 기본 카드 목록 -->
                {% for card in recent_cards %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-credit-card fa-lg text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">{{ card.number }}</h6>
                                <div class="d-flex align-items-center">
                                    {% if card.is_used %}
                                        <i class="fas fa-clock text-warning me-1"></i>
                                        <small class="text-warning">사용중</small>
                                    {% else %}
                                        <i class="fas fa-check-circle text-success me-1"></i>
                                        <small class="text-success">미사용</small>
                                    {% endif %}
                                    <small class="text-muted ms-2">{{ card.created_at }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="updateCardStatus('{{ card.number }}', {{ card.is_used|yesno:'false,true' }})">
                                {% if card.is_used %}미사용으로 변경{% else %}사용중으로 변경{% endif %}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteCard('{{ card.number }}', {{ card.is_used|yesno:'true,false' }})"
                                    {% if card.is_used %}disabled title="사용중인 카드는 삭제할 수 없습니다"{% endif %}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="list-group-item text-center py-5">
                    <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                    <p class="text-muted mb-0">등록된 카드가 없습니다</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- 알림 모달 -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">알림</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 페이지 로드 시작 로그
console.log('=== 포인트카드 관리 페이지 스크립트 시작 ===');

// Bootstrap 및 jQuery 로드 확인
console.log('Bootstrap 로드 상태:', typeof bootstrap !== 'undefined' ? '✅' : '❌');
console.log('jQuery 로드 상태:', typeof $ !== 'undefined' ? '✅' : '❌');

// CSRF 토큰은 base.html에서 이미 선언되어 있음

// 알림 모달 표시 함수
function showAlert(message) {
    console.log('showAlert 호출됨:', message);
    const modalMessage = document.getElementById('modalMessage');
    const alertModal = document.getElementById('alertModal');
    
    if (!modalMessage) {
        console.error('modalMessage 요소를 찾을 수 없습니다!');
        alert(message); // 백업으로 기본 alert 사용
        return;
    }
    
    if (!alertModal) {
        console.error('alertModal 요소를 찾을 수 없습니다!');
        alert(message); // 백업으로 기본 alert 사용
        return;
    }
    
    modalMessage.textContent = message;
    
    try {
        if (typeof bootstrap !== 'undefined') {
            new bootstrap.Modal(alertModal).show();
        } else {
            console.error('Bootstrap이 로드되지 않았습니다!');
            alert(message); // 백업으로 기본 alert 사용
        }
    } catch (error) {
        console.error('모달 표시 중 오류:', error);
        alert(message); // 백업으로 기본 alert 사용
    }
}

// 카드 목록을 가져오는 함수
function fetchCards() {
    console.log('fetchCards 함수 호출됨');
    // 캐시를 방지하기 위한 타임스탬프 추가
    const timestamp = new Date().getTime();
    const url = `/station/get-cards/?_=${timestamp}`;
    console.log('요청 URL:', url);
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('응답 상태:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('받은 데이터:', data);
        if (data.status === 'success' && Array.isArray(data.cards)) {
            const cardList = document.getElementById('cardList');
            console.log('cardList 요소:', cardList);
            
            if (!cardList) {
                console.error('cardList 요소를 찾을 수 없습니다!');
                return;
            }
            
            // 기존 내용을 완전히 지우고 새로 시작
            cardList.innerHTML = '';
            console.log('기존 카드 목록 지움');
            
            // 카드 수 표시 업데이트
            const cardCountElement = document.getElementById('cardCount');
            if (cardCountElement) {
                cardCountElement.textContent = `총 ${data.total_count}장의 카드가 등록되어 있습니다`;
                console.log('카드 수 업데이트:', data.total_count);
            }
            
            // 통계 정보 업데이트
            updateStatistics(data);
            
            if (data.cards.length === 0) {
                cardList.innerHTML = `
                    <div class="list-group-item text-center py-5">
                        <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">등록된 카드가 없습니다</p>
                    </div>
                `;
                console.log('카드가 없음 메시지 표시');
                return;
            }
            
            console.log('카드 개수:', data.cards.length);
            let cardHtml = '';
            data.cards.forEach((card, index) => {
                console.log(`카드 ${index + 1}:`, card);
                cardHtml += createCardItem(card);
            });
            cardList.innerHTML = cardHtml;
            console.log('카드 목록 HTML 업데이트 완료');
        } else {
            console.error('서버 응답 형식 오류:', data);
            throw new Error('서버 응답 형식이 올바르지 않습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('카드 목록을 불러오는데 실패했습니다. 새로고침을 시도해주세요.');
    });
}

// 통계 정보 업데이트 함수
function updateStatistics(data) {
    console.log('통계 정보 업데이트 시작:', data);
    
    // 서버에서 받은 통계 정보 사용
    const totalCards = data.total_count || 0;
    const activeCards = data.active_count || 0;
    const usedCards = data.used_count || 0;
    
    console.log('계산된 통계:', {
        totalCards,
        activeCards,
        usedCards
    });
    
    // 통계 카드 요소들 찾기
    const totalCardsElement = document.getElementById('totalCardsCount');
    const activeCardsElement = document.getElementById('activeCardsCount');
    const usedCardsElement = document.getElementById('usedCardsCount');
    const cardCountElement = document.getElementById('cardCount');
    
    // 전체 카드 수 업데이트
    if (totalCardsElement) {
        totalCardsElement.textContent = `${totalCards}장`;
        console.log('전체 카드 수 업데이트:', totalCards);
    }
    
    // 사용 가능 카드 수 업데이트
    if (activeCardsElement) {
        activeCardsElement.textContent = `${activeCards}장`;
        console.log('사용 가능 카드 수 업데이트:', activeCards);
    }
    
    // 사용중 카드 수 업데이트
    if (usedCardsElement) {
        usedCardsElement.textContent = `${usedCards}장`;
        console.log('사용중 카드 수 업데이트:', usedCards);
    }
    
    // 카드 목록 상단의 총 카드 수 업데이트
    if (cardCountElement) {
        cardCountElement.textContent = `총 ${totalCards}장의 카드가 등록되어 있습니다`;
        console.log('카드 목록 상단 카드 수 업데이트:', totalCards);
    }
    
    // 프로그레스 바 업데이트
    const progressBars = document.querySelectorAll('.progress-bar');
    if (progressBars.length >= 2 && totalCards > 0) {
        const activePercentage = ((activeCards / totalCards) * 100).toFixed(1);
        const usedPercentage = ((usedCards / totalCards) * 100).toFixed(1);
        
        console.log('프로그레스 바 업데이트:', {
            activePercentage,
            usedPercentage
        });
        
        // 사용 가능 프로그레스 바
        progressBars[0].style.width = `${activePercentage}%`;
        progressBars[0].setAttribute('aria-valuenow', activePercentage);
        progressBars[0].textContent = `${activePercentage}%`;
        
        // 사용중 프로그레스 바
        progressBars[1].style.width = `${usedPercentage}%`;
        progressBars[1].setAttribute('aria-valuenow', usedPercentage);
        progressBars[1].textContent = `${usedPercentage}%`;
    }
    
    console.log('통계 정보 업데이트 완료');
}

// 카드 아이템 HTML 생성 함수
function createCardItem(card) {
    const statusClass = card.is_used ? 'text-warning' : 'text-success';
    const statusIcon = card.is_used ? 'clock' : 'check-circle';
    const statusText = card.is_used ? '사용중' : '미사용';
    
    return `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-credit-card fa-lg text-primary"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">${card.number}</h6>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-${statusIcon} ${statusClass} me-1"></i>
                            <small class="${statusClass}">${statusText}</small>
                            <small class="text-muted ms-2">${card.created_at}</small>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary" 
                            onclick="updateCardStatus('${card.number}', ${!card.is_used})">
                        ${card.is_used ? '미사용으로 변경' : '사용중으로 변경'}
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteCard('${card.number}', ${card.is_used})"
                            ${card.is_used ? 'disabled title="사용중인 카드는 삭제할 수 없습니다"' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// 카드 상태 업데이트 함수
function updateCardStatus(cardNumber, newStatus) {
    fetch('/station/update-card-status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.csrftoken,
        },
        body: JSON.stringify({
            cardNumber: cardNumber,
            isUsed: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        showAlert(data.message);
        if (data.status === 'success') {
            fetchCards();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('카드 상태 업데이트 중 오류가 발생했습니다.');
    });
}

// 카드 삭제 함수
function deleteCard(cardNumber, isUsed) {
    console.log('deleteCard 호출됨:', cardNumber, 'isUsed:', isUsed);
    
    // 사용중인 카드는 삭제할 수 없음
    if (isUsed) {
        showAlert('사용중인 카드는 삭제할 수 없습니다. 먼저 미사용 상태로 변경해주세요.');
        return;
    }
    
    // 삭제 확인
    if (!confirm(`카드 ${cardNumber}을(를) 정말 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        console.log('카드 삭제 취소됨');
        return;
    }
    
    console.log('카드 삭제 요청 시작:', cardNumber);
    
    // 해당 카드의 모든 버튼 비활성화
    const cardButtons = document.querySelectorAll(`button[onclick*="${cardNumber}"]`);
    cardButtons.forEach(button => {
        button.disabled = true;
        button.innerHTML = button.innerHTML.includes('trash') ? '<i class="fas fa-spinner fa-spin"></i>' : '처리중...';
    });
    
    fetch('/station/delete-card/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.csrftoken,
        },
        body: JSON.stringify({
            cardNumber: cardNumber
        })
    })
    .then(response => {
        console.log('삭제 응답 상태:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('삭제 서버 응답:', data);
        showAlert(data.message);
        if (data.status === 'success') {
            console.log('카드 삭제 성공, 목록 새로고침');
            fetchCards();
        } else {
            console.error('카드 삭제 실패:', data.message);
            // 실패 시 버튼 다시 활성화
            restoreCardButtons(cardNumber);
        }
    })
    .catch(error => {
        console.error('카드 삭제 중 오류:', error);
        showAlert('카드 삭제 중 오류가 발생했습니다: ' + error.message);
        // 오류 시 버튼 다시 활성화
        restoreCardButtons(cardNumber);
    });
}

// 카드 버튼 복원 함수
function restoreCardButtons(cardNumber) {
    console.log('카드 버튼 복원:', cardNumber);
    const cardButtons = document.querySelectorAll(`button[onclick*="${cardNumber}"]`);
    cardButtons.forEach(button => {
        button.disabled = false;
        if (button.innerHTML.includes('spinner')) {
            button.innerHTML = '<i class="fas fa-trash"></i>';
        } else if (button.innerHTML.includes('처리중')) {
            // 상태 변경 버튼의 원래 텍스트 복원은 fetchCards()에서 처리됨
            button.innerHTML = '상태 변경';
        }
    });
}

// DOM이 완전히 로드된 후 실행
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM 로드 완료 ===');
    
    // 페이지 요소들 존재 확인
    console.log('페이지 요소 확인:');
    console.log('- bulkCardForm:', document.getElementById('bulkCardForm') ? '✅' : '❌');
    console.log('- singleCardForm:', document.getElementById('singleCardForm') ? '✅' : '❌');
    console.log('- cardList:', document.getElementById('cardList') ? '✅' : '❌');
    console.log('- refreshCardList:', document.getElementById('refreshCardList') ? '✅' : '❌');
    console.log('- alertModal:', document.getElementById('alertModal') ? '✅' : '❌');
    
    // CSRF 토큰 가져오기
    const csrfToken1 = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    const csrfToken2 = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    const csrfToken3 = getCookie('csrftoken');
    
    console.log('CSRF 토큰 소스들:');
    console.log('- input[name=csrfmiddlewaretoken]:', csrfToken1 ? '✅' : '❌');
    console.log('- meta[name="csrf-token"]:', csrfToken2 ? '✅' : '❌');
    console.log('- 쿠키 csrftoken:', csrfToken3 ? '✅' : '❌');
    
    window.csrftoken = csrfToken1 || csrfToken2 || csrfToken3;
    
    console.log('최종 CSRF 토큰:', window.csrftoken ? '✅ 설정됨' : '❌ 없음');
    
    // 페이지 로드시 카드 목록 가져오기
    fetchCards();

    // 새로고침 버튼 클릭 이벤트
    const refreshBtn = document.getElementById('refreshCardList');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            fetchCards();
        });
    }
    
    // 일괄 등록 폼 제출
    const bulkForm = document.getElementById('bulkCardForm');
    if (bulkForm) {
        console.log('일괄 등록 폼 이벤트 리스너 등록됨');
        bulkForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('일괄 등록 폼 제출됨');
            
            // 이미 처리 중인지 확인
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton.disabled) {
                console.log('이미 처리 중인 요청입니다.');
                return;
            }
            
            const startNumber = document.getElementById('startNumber').value;
            const cardCount = document.getElementById('cardCount').value;
            console.log('시작번호:', startNumber, '카드수:', cardCount);

            // 버튼 비활성화 및 로딩 표시
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>등록 중...';

            const requestData = {
                startNumber: startNumber,
                cardCount: cardCount
            };
            console.log('요청 데이터:', requestData);

            fetch('/station/register-cards-bulk/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrftoken,
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('서버 응답:', data);
                showAlert(data.message);
                if (data.status === 'success') {
                    console.log('일괄 등록 성공, 폼 리셋 및 카드 목록 새로고침');
                    this.reset();
                    fetchCards();
                } else {
                    console.error('일괄 등록 실패:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('카드 등록 중 오류가 발생했습니다: ' + error.message);
            })
            .finally(() => {
                // 버튼 다시 활성화
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                console.log('일괄 등록 버튼 복원됨');
            });
        });
    } else {
        console.error('일괄 등록 폼을 찾을 수 없습니다!');
    }

    // 개별 등록 폼 제출
    const singleForm = document.getElementById('singleCardForm');
    if (singleForm) {
        console.log('개별 등록 폼 이벤트 리스너 등록됨');
        singleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('개별 등록 폼 제출됨');
            
            // 이미 처리 중인지 확인
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton.disabled) {
                console.log('이미 처리 중인 요청입니다.');
                return;
            }
            
            const cardNumber = document.getElementById('cardNumber').value;
            console.log('입력된 카드번호:', cardNumber);
            
            if (!cardNumber || cardNumber.length !== 16) {
                showAlert('16자리 카드번호를 입력해주세요.');
                return;
            }

            // 버튼 비활성화 및 로딩 표시
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>등록 중...';

            const requestData = {
                cardNumber: cardNumber
            };
            console.log('요청 데이터:', requestData);
            console.log('CSRF 토큰:', window.csrftoken);

            fetch('/station/register-cards-single/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrftoken,
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log('응답 상태:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('서버 응답:', data);
                showAlert(data.message);
                if (data.status === 'success') {
                    console.log('카드 등록 성공, 폼 리셋 및 카드 목록 새로고침');
                    this.reset();
                    fetchCards();
                } else {
                    console.error('카드 등록 실패:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('카드 등록 중 오류가 발생했습니다: ' + error.message);
            })
            .finally(() => {
                // 버튼 다시 활성화
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                console.log('개별 등록 버튼 복원됨');
            });
        });
    } else {
        console.error('개별 등록 폼을 찾을 수 없습니다!');
    }
});

// 쿠키에서 CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


</script>
{% endblock %} 